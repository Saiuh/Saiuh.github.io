<!DOCTYPE html><html lang="zh-CN"><head><meta name="generator" content="Hexo 3.9.0"><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="我的个人博客"><title>zk解析(3)：leader请求处理及处理链(ZookeeperServer/LeaderZooKeeperServer) | SvizzerChow's Blog</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/normalize/8.0.1/normalize.min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/1.0.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/1.0.0/grids-responsive-min.css"><link rel="stylesheet" href="//lib.baomitu.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//lib.baomitu.com/jquery/3.4.0/jquery.min.js"></script><link rel="icon" mask sizes="any" href="/favicon.ico"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">zk解析(3)：leader请求处理及处理链(ZookeeperServer/LeaderZooKeeperServer)</h1><a id="logo" href="/.">SvizzerChow's Blog</a><p class="description">Leaning</p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">zk解析(3)：leader请求处理及处理链(ZookeeperServer/LeaderZooKeeperServer)</h1><div class="post-meta">Jan 14, 2019<span> | </span><span class="category"><a href="/categories/分布式/">分布式</a></span></div><div class="post-content"><h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>在第二篇Leader初始化解析中见到了主节点工作的类ZookeeperServer/LeaderZooKeeperServer，请求的处理工作是交给LeaderZooKeeperServer来处理的。</p>
<p><strong>初始化</strong><br><br>leader.lead() -&gt; leader.startZkServer()<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">startZkServer</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// Update lastCommitted and Db's zxid to a value representing the new epoch</span></span><br><span class="line">    lastCommitted = zk.getZxid();</span><br><span class="line">    LOG.info(<span class="string">"Have quorum of supporters, sids: [ "</span></span><br><span class="line">            + getSidSetString(newLeaderProposal.ackSet)</span><br><span class="line">            + <span class="string">" ]; starting up and setting last processed zxid: 0x&#123;&#125;"</span>,</span><br><span class="line">            Long.toHexString(zk.getZxid()));</span><br><span class="line">    zk.startup();</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">        * Update the election vote here to ensure that all members of the</span></span><br><span class="line"><span class="comment">        * ensemble report the same vote to new servers that start up and</span></span><br><span class="line"><span class="comment">        * send leader election notifications to the ensemble.</span></span><br><span class="line"><span class="comment">        * </span></span><br><span class="line"><span class="comment">        * @see https://issues.apache.org/jira/browse/ZOOKEEPER-1732</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">    self.updateElectionVote(getEpoch());</span><br><span class="line"></span><br><span class="line">    zk.getZKDatabase().setlastProcessedZxid(zk.getZxid());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><strong>其他调用</strong><br><br>LearnerHandler.run()<br><a id="more"></a><br><strong>由于zk有集群和单机的区别，所以ZookeeperServer在这两种情况是不一样的。集群环境使用的是LeaderZooKeeperServer。LeaderZooKeeperServer是继承QuorumZooKeeperServer，而QuorumZooKeeperServer继承了ZooKeeperServer，大部分的方法都是在ZooKeeperServer类中实现</strong></p>
<h1 id="ZookeeperServer-类"><a href="#ZookeeperServer-类" class="headerlink" title="ZookeeperServer 类"></a>ZookeeperServer 类</h1><h2 id="构造器"><a href="#构造器" class="headerlink" title="构造器"></a>构造器</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">ZooKeeperServer</span><span class="params">(FileTxnSnapLog txnLogFactory, <span class="keyword">int</span> tickTime,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">int</span> minSessionTimeout, <span class="keyword">int</span> maxSessionTimeout,</span></span></span><br><span class="line"><span class="function"><span class="params">        DataTreeBuilder treeBuilder, ZKDatabase zkDb)</span> </span>&#123;</span><br><span class="line">    serverStats = <span class="keyword">new</span> ServerStats(<span class="keyword">this</span>);</span><br><span class="line">    <span class="keyword">this</span>.txnLogFactory = txnLogFactory;</span><br><span class="line">    <span class="keyword">this</span>.txnLogFactory.setServerStats(<span class="keyword">this</span>.serverStats);</span><br><span class="line">    <span class="keyword">this</span>.zkDb = zkDb;</span><br><span class="line">    <span class="keyword">this</span>.tickTime = tickTime;</span><br><span class="line">    <span class="keyword">this</span>.minSessionTimeout = minSessionTimeout;</span><br><span class="line">    <span class="keyword">this</span>.maxSessionTimeout = maxSessionTimeout;</span><br><span class="line"></span><br><span class="line">    listener = <span class="keyword">new</span> ZooKeeperServerListenerImpl(<span class="keyword">this</span>);</span><br><span class="line"></span><br><span class="line">    LOG.info(<span class="string">"Created server with tickTime "</span> + tickTime</span><br><span class="line">            + <span class="string">" minSessionTimeout "</span> + getMinSessionTimeout()</span><br><span class="line">            + <span class="string">" maxSessionTimeout "</span> + getMaxSessionTimeout()</span><br><span class="line">            + <span class="string">" datadir "</span> + txnLogFactory.getDataDir()</span><br><span class="line">            + <span class="string">" snapdir "</span> + txnLogFactory.getSnapDir());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="主要方法解析"><a href="#主要方法解析" class="headerlink" title="主要方法解析"></a>主要方法解析</h2><h3 id="startup"><a href="#startup" class="headerlink" title="startup()"></a>startup()</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">startup</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (sessionTracker == <span class="keyword">null</span>) &#123;</span><br><span class="line">        createSessionTracker();</span><br><span class="line">    &#125;</span><br><span class="line">    startSessionTracker();</span><br><span class="line">    setupRequestProcessors();</span><br><span class="line"></span><br><span class="line">    registerJMX();</span><br><span class="line">    <span class="comment">// 初始化完成并通知所有等待中的线程</span></span><br><span class="line">    setState(State.RUNNING);</span><br><span class="line">    notifyAll();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="初始SessionTracker-createSessionTracker"><a href="#初始SessionTracker-createSessionTracker" class="headerlink" title="初始SessionTracker createSessionTracker()"></a>初始SessionTracker createSessionTracker()</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">createSessionTracker</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    sessionTracker = <span class="keyword">new</span> SessionTrackerImpl(<span class="keyword">this</span>, zkDb.getSessionWithTimeOuts(),</span><br><span class="line">            tickTime, <span class="number">1</span>, getZooKeeperServerListener());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="启动SessionTracker线程-startSessionTracker"><a href="#启动SessionTracker线程-startSessionTracker" class="headerlink" title="启动SessionTracker线程 startSessionTracker()"></a>启动SessionTracker线程 startSessionTracker()</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">startSessionTracker</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    ((SessionTrackerImpl)sessionTracker).start();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="初始请求处理器-setupRequestProcessors"><a href="#初始请求处理器-setupRequestProcessors" class="headerlink" title="初始请求处理器 setupRequestProcessors()"></a>初始请求处理器 setupRequestProcessors()</h3><p>RequestProcessor是用于处理从节点收到请求后向主节点发起的请求，调用在</p>
<blockquote>
<p>LearnerCnxAcceptor.run() -&gt; LearnerHandler.run() -&gt; leader.zk.submitRequest(si)<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">setupRequestProcessors</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    RequestProcessor finalProcessor = <span class="keyword">new</span> FinalRequestProcessor(<span class="keyword">this</span>);</span><br><span class="line">    RequestProcessor syncProcessor = <span class="keyword">new</span> SyncRequestProcessor(<span class="keyword">this</span>,</span><br><span class="line">            finalProcessor);</span><br><span class="line">    ((SyncRequestProcessor)syncProcessor).start();</span><br><span class="line">    firstProcessor = <span class="keyword">new</span> PrepRequestProcessor(<span class="keyword">this</span>, syncProcessor);</span><br><span class="line">    ((PrepRequestProcessor)firstProcessor).start();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
</blockquote>
<h3 id="提交请求-submitRequest"><a href="#提交请求-submitRequest" class="headerlink" title="提交请求 submitRequest()"></a>提交请求 submitRequest()</h3><p>主节点服务器接收其他服务器的请求(Leader.REQUEST)，执行该方法处理请求. 发生在</p>
<blockquote>
<p>LearnerHandler.run()<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// ... 省略</span></span><br><span class="line">    <span class="keyword">case</span> Leader.REQUEST:                    </span><br><span class="line">        bb = ByteBuffer.wrap(qp.getData());</span><br><span class="line">        sessionId = bb.getLong();</span><br><span class="line">        cxid = bb.getInt();</span><br><span class="line">        type = bb.getInt();</span><br><span class="line">        bb = bb.slice();</span><br><span class="line">        Request si;</span><br><span class="line">        <span class="keyword">if</span>(type == OpCode.sync)&#123;</span><br><span class="line">            si = <span class="keyword">new</span> LearnerSyncRequest(<span class="keyword">this</span>, sessionId, cxid, type, bb, qp.getAuthinfo());</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            si = <span class="keyword">new</span> Request(<span class="keyword">null</span>, sessionId, cxid, type, bb, qp.getAuthinfo());</span><br><span class="line">        &#125;</span><br><span class="line">        si.setOwner(<span class="keyword">this</span>);</span><br><span class="line">        <span class="comment">// 处理请求</span></span><br><span class="line">        leader.zk.submitRequest(si);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="comment">// ... 省略</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
</blockquote>
<p>而请求的处理在submitRequest方法中是交由请求处理器链去处理，处理链类似于filter的形式</p>
<blockquote>
<p>firstProcessor.processRequest(si);<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">submitRequest</span><span class="params">(ServerCnxn cnxn, <span class="keyword">long</span> sessionId, <span class="keyword">int</span> type,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">int</span> xid, ByteBuffer bb, List&lt;Id&gt; authInfo)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 封装请求</span></span><br><span class="line">    Request si = <span class="keyword">new</span> Request(cnxn, sessionId, xid, type, bb, authInfo);</span><br><span class="line">    submitRequest(si);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
</blockquote>
<p><code>void submitRequest(Request si)</code>方法<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">submitRequest</span><span class="params">(Request si)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (firstProcessor == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;<span class="comment">// 等待初始化完成</span></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// Since all requests are passed to the request</span></span><br><span class="line">                <span class="comment">// processor it should wait for setting up the request</span></span><br><span class="line">                <span class="comment">// processor chain. The state will be updated to RUNNING</span></span><br><span class="line">                <span class="comment">// after the setup.</span></span><br><span class="line">                <span class="keyword">while</span> (state == State.INITIAL) &#123; </span><br><span class="line">                    wait(<span class="number">1000</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                LOG.warn(<span class="string">"Unexpected interruption"</span>, e);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (firstProcessor == <span class="keyword">null</span> || state != State.RUNNING) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"Not started"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">//刷新session</span></span><br><span class="line">        touch(si.cnxn); </span><br><span class="line">        <span class="comment">// 校验type</span></span><br><span class="line">        <span class="keyword">boolean</span> validpacket = Request.isValid(si.type);</span><br><span class="line">        <span class="keyword">if</span> (validpacket) &#123;</span><br><span class="line">            <span class="comment">// 由请求处理器处理，处理器处理请求放在后面单独解析</span></span><br><span class="line">            firstProcessor.processRequest(si);</span><br><span class="line">            <span class="keyword">if</span> (si.cnxn != <span class="keyword">null</span>) &#123;</span><br><span class="line">                incInProcess(); <span class="comment">// 计数器加一</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            LOG.warn(<span class="string">"Received packet at server of unknown type "</span> + si.type);</span><br><span class="line">            <span class="keyword">new</span> UnimplementedRequestProcessor().processRequest(si);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (MissingSessionException e) &#123;</span><br><span class="line">        <span class="keyword">if</span> (LOG.isDebugEnabled()) &#123;</span><br><span class="line">            LOG.debug(<span class="string">"Dropping request: "</span> + e.getMessage());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (RequestProcessorException e) &#123;</span><br><span class="line">        LOG.error(<span class="string">"Unable to process request:"</span> + e.getMessage(), e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="创建session-createSession"><a href="#创建session-createSession" class="headerlink" title="创建session createSession()"></a>创建session createSession()</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">long</span> <span class="title">createSession</span><span class="params">(ServerCnxn cnxn, <span class="keyword">byte</span> passwd[], <span class="keyword">int</span> timeout)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">long</span> sessionId = sessionTracker.createSession(timeout);</span><br><span class="line">    Random r = <span class="keyword">new</span> Random(sessionId ^ superSecret);</span><br><span class="line">    r.nextBytes(passwd);</span><br><span class="line">    ByteBuffer to = ByteBuffer.allocate(<span class="number">4</span>);</span><br><span class="line">    to.putInt(timeout);</span><br><span class="line">    cnxn.setSessionId(sessionId);</span><br><span class="line">    <span class="comment">// 这里也调用了请求处理</span></span><br><span class="line">    submitRequest(cnxn, sessionId, OpCode.createSession, <span class="number">0</span>, to, <span class="keyword">null</span>);</span><br><span class="line">    <span class="keyword">return</span> sessionId;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="设置session所属服务器-setOwner"><a href="#设置session所属服务器-setOwner" class="headerlink" title="设置session所属服务器 setOwner()"></a>设置session所属服务器 setOwner()</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setOwner</span><span class="params">(<span class="keyword">long</span> id, Object owner)</span> <span class="keyword">throws</span> SessionExpiredException </span>&#123;</span><br><span class="line">    sessionTracker.setOwner(id, owner);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="刷新session-touch"><a href="#刷新session-touch" class="headerlink" title="刷新session touch()"></a>刷新session touch()</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">touch</span><span class="params">(ServerCnxn cnxn)</span> <span class="keyword">throws</span> MissingSessionException </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (cnxn == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">long</span> id = cnxn.getSessionId();</span><br><span class="line">    <span class="keyword">int</span> to = cnxn.getSessionTimeout();</span><br><span class="line">    <span class="comment">// 更新session过期时间</span></span><br><span class="line">    <span class="keyword">if</span> (!sessionTracker.touchSession(id, to)) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> MissingSessionException(</span><br><span class="line">                <span class="string">"No session with sessionid 0x"</span> + Long.toHexString(id)</span><br><span class="line">                + <span class="string">" exists, probably expired and removed"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="处理请求包-processPacket"><a href="#处理请求包-processPacket" class="headerlink" title="处理请求包 processPacket()"></a>处理请求包 processPacket()</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">processPacket</span><span class="params">(ServerCnxn cnxn, ByteBuffer incomingBuffer)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    <span class="comment">// We have the request, now process and setup for next</span></span><br><span class="line">    InputStream bais = <span class="keyword">new</span> ByteBufferInputStream(incomingBuffer);</span><br><span class="line">    BinaryInputArchive bia = BinaryInputArchive.getArchive(bais);</span><br><span class="line">    RequestHeader h = <span class="keyword">new</span> RequestHeader();</span><br><span class="line">    h.deserialize(bia, <span class="string">"header"</span>);</span><br><span class="line">    <span class="comment">// Through the magic of byte buffers, txn will not be</span></span><br><span class="line">    <span class="comment">// pointing</span></span><br><span class="line">    <span class="comment">// to the start of the txn</span></span><br><span class="line">    incomingBuffer = incomingBuffer.slice();</span><br><span class="line">    <span class="keyword">if</span> (h.getType() == OpCode.auth) &#123;</span><br><span class="line">        LOG.info(<span class="string">"got auth packet "</span> + cnxn.getRemoteSocketAddress());</span><br><span class="line">        AuthPacket authPacket = <span class="keyword">new</span> AuthPacket();</span><br><span class="line">        ByteBufferInputStream.byteBuffer2Record(incomingBuffer, authPacket);</span><br><span class="line">        String scheme = authPacket.getScheme();</span><br><span class="line">        AuthenticationProvider ap = ProviderRegistry.getProvider(scheme);</span><br><span class="line">        Code authReturn = KeeperException.Code.AUTHFAILED;</span><br><span class="line">        <span class="keyword">if</span>(ap != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                authReturn = ap.handleAuthentication(cnxn, authPacket.getAuth());</span><br><span class="line">            &#125; <span class="keyword">catch</span>(RuntimeException e) &#123;</span><br><span class="line">                LOG.warn(<span class="string">"Caught runtime exception from AuthenticationProvider: "</span> + scheme + <span class="string">" due to "</span> + e);</span><br><span class="line">                authReturn = KeeperException.Code.AUTHFAILED;                   </span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (authReturn!= KeeperException.Code.OK) &#123;</span><br><span class="line">            <span class="keyword">if</span> (ap == <span class="keyword">null</span>) &#123;</span><br><span class="line">                LOG.warn(<span class="string">"No authentication provider for scheme: "</span></span><br><span class="line">                        + scheme + <span class="string">" has "</span></span><br><span class="line">                        + ProviderRegistry.listProviders());</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                LOG.warn(<span class="string">"Authentication failed for scheme: "</span> + scheme);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// send a response...</span></span><br><span class="line">            ReplyHeader rh = <span class="keyword">new</span> ReplyHeader(h.getXid(), <span class="number">0</span>,</span><br><span class="line">                    KeeperException.Code.AUTHFAILED.intValue());</span><br><span class="line">            cnxn.sendResponse(rh, <span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line">            <span class="comment">// ... and close connection</span></span><br><span class="line">            cnxn.sendBuffer(ServerCnxnFactory.closeConn);</span><br><span class="line">            cnxn.disableRecv();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (LOG.isDebugEnabled()) &#123;</span><br><span class="line">                LOG.debug(<span class="string">"Authentication succeeded for scheme: "</span></span><br><span class="line">                            + scheme);</span><br><span class="line">            &#125;</span><br><span class="line">            LOG.info(<span class="string">"auth success "</span> + cnxn.getRemoteSocketAddress());</span><br><span class="line">            ReplyHeader rh = <span class="keyword">new</span> ReplyHeader(h.getXid(), <span class="number">0</span>,</span><br><span class="line">                    KeeperException.Code.OK.intValue());</span><br><span class="line">            cnxn.sendResponse(rh, <span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (h.getType() == OpCode.sasl) &#123;</span><br><span class="line">            Record rsp = processSasl(incomingBuffer,cnxn);</span><br><span class="line">            ReplyHeader rh = <span class="keyword">new</span> ReplyHeader(h.getXid(), <span class="number">0</span>, KeeperException.Code.OK.intValue());</span><br><span class="line">            cnxn.sendResponse(rh,rsp, <span class="string">"response"</span>); <span class="comment">// not sure about 3rd arg..what is it?</span></span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            Request si = <span class="keyword">new</span> Request(cnxn, cnxn.getSessionId(), h.getXid(),</span><br><span class="line">                h.getType(), incomingBuffer, cnxn.getAuthInfo());</span><br><span class="line">            si.setOwner(ServerCnxn.me);</span><br><span class="line">            submitRequest(si);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    cnxn.incrOutstandingRequests(h);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="submitRequest提交请求"><a href="#submitRequest提交请求" class="headerlink" title="submitRequest提交请求"></a>submitRequest提交请求</h2><p><code>public void submitRequest(Request si)</code>方法中请求链<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">firstProcessor.processRequest(si);</span><br></pre></td></tr></table></figure></p>
<p>首先查看处理链的初始化过程：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">setupRequestProcessors</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    RequestProcessor finalProcessor = <span class="keyword">new</span> FinalRequestProcessor(<span class="keyword">this</span>);</span><br><span class="line">    RequestProcessor syncProcessor = <span class="keyword">new</span> SyncRequestProcessor(<span class="keyword">this</span>,</span><br><span class="line">            finalProcessor);</span><br><span class="line">    ((SyncRequestProcessor)syncProcessor).start();</span><br><span class="line">    firstProcessor = <span class="keyword">new</span> PrepRequestProcessor(<span class="keyword">this</span>, syncProcessor);</span><br><span class="line">    ((PrepRequestProcessor)firstProcessor).start();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>根据初始化的代码可知firstProcessor的具体类型是PrepRequestProcessor</p>
<h3 id="PrepRequestProcessor类-前置处理（读写请求区分）"><a href="#PrepRequestProcessor类-前置处理（读写请求区分）" class="headerlink" title="PrepRequestProcessor类-前置处理（读写请求区分）"></a>PrepRequestProcessor类-前置处理（读写请求区分）</h3><p>PrepRequestProcessor类负责将请求处理封装</p>
<h4 id="继承关系"><a href="#继承关系" class="headerlink" title="继承关系"></a>继承关系</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PrepRequestProcessor</span> <span class="keyword">extends</span> <span class="title">ZooKeeperCriticalThread</span> <span class="keyword">implements</span></span></span><br><span class="line"><span class="class">        <span class="title">RequestProcessor</span></span></span><br></pre></td></tr></table></figure>
<h4 id="构造器-1"><a href="#构造器-1" class="headerlink" title="构造器"></a>构造器</h4><p>nextProcessor保存了下一个要执行的Processor<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">PrepRequestProcessor</span><span class="params">(ZooKeeperServer zks,</span></span></span><br><span class="line"><span class="function"><span class="params">        RequestProcessor nextProcessor)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">super</span>(<span class="string">"ProcessThread(sid:"</span> + zks.getServerId() + <span class="string">" cport:"</span></span><br><span class="line">            + zks.getClientPort() + <span class="string">"):"</span>, zks.getZooKeeperServerListener());</span><br><span class="line">    <span class="keyword">this</span>.nextProcessor = nextProcessor;</span><br><span class="line">    <span class="keyword">this</span>.zks = zks;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h4 id="处理请求"><a href="#处理请求" class="headerlink" title="处理请求"></a>处理请求</h4><p>processRequest方法将请求保存到队列中(LinkedBlockingQueue)，在run()方法中异步处理请求<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">processRequest</span><span class="params">(Request request)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// request.addRQRec("&gt;prep="+zks.outstandingChanges.size());</span></span><br><span class="line">    submittedRequests.add(request);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h4 id="run-方法"><a href="#run-方法" class="headerlink" title="run()方法"></a>run()方法</h4><p>run方法将队列中请求取出并交由pRequest()方法去处理。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">            Request request = submittedRequests.take();</span><br><span class="line">            <span class="keyword">long</span> traceMask = ZooTrace.CLIENT_REQUEST_TRACE_MASK;</span><br><span class="line">            <span class="keyword">if</span> (request.type == OpCode.ping) &#123;</span><br><span class="line">                traceMask = ZooTrace.CLIENT_PING_TRACE_MASK;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (LOG.isTraceEnabled()) &#123;</span><br><span class="line">                ZooTrace.logRequest(LOG, traceMask, <span class="string">'P'</span>, request, <span class="string">""</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (Request.requestOfDeath == request) &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 处理请求</span></span><br><span class="line">            pRequest(request);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (RequestProcessorException e) &#123;</span><br><span class="line">        <span class="keyword">if</span> (e.getCause() <span class="keyword">instanceof</span> XidRolloverException) &#123;</span><br><span class="line">            LOG.info(e.getCause().getMessage());</span><br><span class="line">        &#125;</span><br><span class="line">        handleException(<span class="keyword">this</span>.getName(), e);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        handleException(<span class="keyword">this</span>.getName(), e);</span><br><span class="line">    &#125;</span><br><span class="line">    LOG.info(<span class="string">"PrepRequestProcessor exited loop!"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h4 id="pRequest-处理请求"><a href="#pRequest-处理请求" class="headerlink" title="pRequest()处理请求"></a>pRequest()处理请求</h4><p>写请求生成request.hdr用于区分<br>根据request.type做处理：</p>
<ol>
<li>其中create/delete/setData/check/setACL/createSession/closeSession的处理一致都是通过<code>pRequest2Txn()</code>方法进行校验并生成request.txn，<strong>并且此时会生成新的Zxid(也就是zxid递增)</strong>；</li>
<li>sync/exists/getData/getACL/getChildren/getChildren2/ping/setWatches不用生成Txn，只用校验serssion;</li>
<li>multi是多个请求合并为一个原子操作，这里是将各个请求使用pRequest2Txn生成Txn.</li>
</ol>
<p>以上处理后调用<code>nextProcessor.processRequest(request)</code>，由处理链中的下一个处理器处理，根据<a href>初始请求处理器setupRequestProcessors()</a>可知下一个处理器是SyncRequestProcessor。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">pRequest</span><span class="params">(Request request)</span> <span class="keyword">throws</span> RequestProcessorException </span>&#123;</span><br><span class="line">    <span class="comment">// LOG.info("Prep&gt;&gt;&gt; cxid = " + request.cxid + " type = " +</span></span><br><span class="line">    <span class="comment">// request.type + " id = 0x" + Long.toHexString(request.sessionId));</span></span><br><span class="line">    request.hdr = <span class="keyword">null</span>;</span><br><span class="line">    request.txn = <span class="keyword">null</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">switch</span> (request.type) &#123;</span><br><span class="line">            <span class="keyword">case</span> OpCode.create:</span><br><span class="line">            CreateRequest createRequest = <span class="keyword">new</span> CreateRequest();</span><br><span class="line">            pRequest2Txn(request.type, zks.getNextZxid(), request, createRequest, <span class="keyword">true</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> OpCode.delete:</span><br><span class="line">            DeleteRequest deleteRequest = <span class="keyword">new</span> DeleteRequest();               </span><br><span class="line">            pRequest2Txn(request.type, zks.getNextZxid(), request, deleteRequest, <span class="keyword">true</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> OpCode.setData:</span><br><span class="line">            SetDataRequest setDataRequest = <span class="keyword">new</span> SetDataRequest();                </span><br><span class="line">            pRequest2Txn(request.type, zks.getNextZxid(), request, setDataRequest, <span class="keyword">true</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> OpCode.setACL:</span><br><span class="line">            SetACLRequest setAclRequest = <span class="keyword">new</span> SetACLRequest();                </span><br><span class="line">            pRequest2Txn(request.type, zks.getNextZxid(), request, setAclRequest, <span class="keyword">true</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> OpCode.check:</span><br><span class="line">            CheckVersionRequest checkRequest = <span class="keyword">new</span> CheckVersionRequest();              </span><br><span class="line">            pRequest2Txn(request.type, zks.getNextZxid(), request, checkRequest, <span class="keyword">true</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> OpCode.multi:</span><br><span class="line">            MultiTransactionRecord multiRequest = <span class="keyword">new</span> MultiTransactionRecord();</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                ByteBufferInputStream.byteBuffer2Record(request.request, multiRequest);</span><br><span class="line">            &#125; <span class="keyword">catch</span>(IOException e) &#123;</span><br><span class="line">                request.hdr =  <span class="keyword">new</span> TxnHeader(request.sessionId, request.cxid, zks.getNextZxid(),</span><br><span class="line">                        Time.currentWallTime(), OpCode.multi);</span><br><span class="line">                <span class="keyword">throw</span> e;</span><br><span class="line">            &#125;</span><br><span class="line">            List&lt;Txn&gt; txns = <span class="keyword">new</span> ArrayList&lt;Txn&gt;();</span><br><span class="line">            <span class="comment">//Each op in a multi-op must have the same zxid!</span></span><br><span class="line">            <span class="keyword">long</span> zxid = zks.getNextZxid();</span><br><span class="line">            KeeperException ke = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//Store off current pending change records in case we need to rollback</span></span><br><span class="line">            HashMap&lt;String, ChangeRecord&gt; pendingChanges = getPendingChanges(multiRequest);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">int</span> index = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">for</span>(Op op: multiRequest) &#123;</span><br><span class="line">                Record subrequest = op.toRequestRecord() ;</span><br><span class="line"></span><br><span class="line">                <span class="comment">/* If we've already failed one of the ops, don't bother</span></span><br><span class="line"><span class="comment">                    * trying the rest as we know it's going to fail and it</span></span><br><span class="line"><span class="comment">                    * would be confusing in the logfiles.</span></span><br><span class="line"><span class="comment">                    */</span></span><br><span class="line">                <span class="keyword">if</span> (ke != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    request.hdr.setType(OpCode.error);</span><br><span class="line">                    request.txn = <span class="keyword">new</span> ErrorTxn(Code.RUNTIMEINCONSISTENCY.intValue());</span><br><span class="line">                &#125; </span><br><span class="line">                </span><br><span class="line">                <span class="comment">/* Prep the request and convert to a Txn */</span></span><br><span class="line">                <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        pRequest2Txn(op.getType(), zxid, request, subrequest, <span class="keyword">false</span>);</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (KeeperException e) &#123;</span><br><span class="line">                        ke = e;</span><br><span class="line">                        request.hdr.setType(OpCode.error);</span><br><span class="line">                        request.txn = <span class="keyword">new</span> ErrorTxn(e.code().intValue());</span><br><span class="line">                        LOG.info(<span class="string">"Got user-level KeeperException when processing "</span></span><br><span class="line">                                + request.toString() + <span class="string">" aborting remaining multi ops."</span></span><br><span class="line">                                + <span class="string">" Error Path:"</span> + e.getPath()</span><br><span class="line">                                + <span class="string">" Error:"</span> + e.getMessage());</span><br><span class="line"></span><br><span class="line">                        request.setException(e);</span><br><span class="line"></span><br><span class="line">                        <span class="comment">/* Rollback change records from failed multi-op */</span></span><br><span class="line">                        rollbackPendingChanges(zxid, pendingChanges);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">//<span class="doctag">FIXME:</span> I don't want to have to serialize it here and then</span></span><br><span class="line">                <span class="comment">//       immediately deserialize in next processor. But I'm </span></span><br><span class="line">                <span class="comment">//       not sure how else to get the txn stored into our list.</span></span><br><span class="line">                ByteArrayOutputStream baos = <span class="keyword">new</span> ByteArrayOutputStream();</span><br><span class="line">                BinaryOutputArchive boa = BinaryOutputArchive.getArchive(baos);</span><br><span class="line">                request.txn.serialize(boa, <span class="string">"request"</span>) ;</span><br><span class="line">                ByteBuffer bb = ByteBuffer.wrap(baos.toByteArray());</span><br><span class="line"></span><br><span class="line">                txns.add(<span class="keyword">new</span> Txn(request.hdr.getType(), bb.array()));</span><br><span class="line">                index++;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            request.hdr = <span class="keyword">new</span> TxnHeader(request.sessionId, request.cxid, zxid,</span><br><span class="line">                    Time.currentWallTime(), request.type);</span><br><span class="line">            request.txn = <span class="keyword">new</span> MultiTxn(txns);</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//create/close session don't require request record</span></span><br><span class="line">        <span class="keyword">case</span> OpCode.createSession:</span><br><span class="line">        <span class="keyword">case</span> OpCode.closeSession:</span><br><span class="line">            pRequest2Txn(request.type, zks.getNextZxid(), request, <span class="keyword">null</span>, <span class="keyword">true</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//All the rest don't need to create a Txn - just verify session</span></span><br><span class="line">        <span class="keyword">case</span> OpCode.sync:</span><br><span class="line">        <span class="keyword">case</span> OpCode.exists:</span><br><span class="line">        <span class="keyword">case</span> OpCode.getData:</span><br><span class="line">        <span class="keyword">case</span> OpCode.getACL:</span><br><span class="line">        <span class="keyword">case</span> OpCode.getChildren:</span><br><span class="line">        <span class="keyword">case</span> OpCode.getChildren2:</span><br><span class="line">        <span class="keyword">case</span> OpCode.ping:</span><br><span class="line">        <span class="keyword">case</span> OpCode.setWatches:</span><br><span class="line">            zks.sessionTracker.checkSession(request.sessionId,</span><br><span class="line">                    request.getOwner());</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            LOG.warn(<span class="string">"unknown type "</span> + request.type);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (KeeperException e) &#123;</span><br><span class="line">        <span class="keyword">if</span> (request.hdr != <span class="keyword">null</span>) &#123;</span><br><span class="line">            request.hdr.setType(OpCode.error);</span><br><span class="line">            request.txn = <span class="keyword">new</span> ErrorTxn(e.code().intValue());</span><br><span class="line">        &#125;</span><br><span class="line">        LOG.info(<span class="string">"Got user-level KeeperException when processing "</span></span><br><span class="line">                + request.toString()</span><br><span class="line">                + <span class="string">" Error Path:"</span> + e.getPath()</span><br><span class="line">                + <span class="string">" Error:"</span> + e.getMessage());</span><br><span class="line">        request.setException(e);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        <span class="comment">// log at error level as we are returning a marshalling</span></span><br><span class="line">        <span class="comment">// error to the user</span></span><br><span class="line">        LOG.error(<span class="string">"Failed to process "</span> + request, e);</span><br><span class="line"></span><br><span class="line">        StringBuilder sb = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">        ByteBuffer bb = request.request;</span><br><span class="line">        <span class="keyword">if</span>(bb != <span class="keyword">null</span>)&#123;</span><br><span class="line">            bb.rewind();</span><br><span class="line">            <span class="keyword">while</span> (bb.hasRemaining()) &#123;</span><br><span class="line">                sb.append(Integer.toHexString(bb.get() &amp; <span class="number">0xff</span>));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            sb.append(<span class="string">"request buffer is null"</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        LOG.error(<span class="string">"Dumping request buffer: 0x"</span> + sb.toString());</span><br><span class="line">        <span class="keyword">if</span> (request.hdr != <span class="keyword">null</span>) &#123;</span><br><span class="line">            request.hdr.setType(OpCode.error);</span><br><span class="line">            request.txn = <span class="keyword">new</span> ErrorTxn(Code.MARSHALLINGERROR.intValue());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    request.zxid = zks.getZxid();</span><br><span class="line">    nextProcessor.processRequest(request);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="SyncRequestProcessor类-日志记录和快照存储"><a href="#SyncRequestProcessor类-日志记录和快照存储" class="headerlink" title="SyncRequestProcessor类-日志记录和快照存储"></a>SyncRequestProcessor类-日志记录和快照存储</h3><p>SyncRequestProcessor的作用是将请求log记录到硬盘上，直到log完全记录才会执行下一个处理器；同时一定周期会将内存的数据生成快照保存到硬盘中。</p>
<h4 id="继承关系-1"><a href="#继承关系-1" class="headerlink" title="继承关系"></a>继承关系</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SyncRequestProcessor</span> <span class="keyword">extends</span> <span class="title">ZooKeeperCriticalThread</span> <span class="keyword">implements</span> <span class="title">RequestProcessor</span> </span>&#123;&#125;</span><br></pre></td></tr></table></figure>
<h4 id="构造器-2"><a href="#构造器-2" class="headerlink" title="构造器"></a>构造器</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">SyncRequestProcessor</span><span class="params">(ZooKeeperServer zks,</span></span></span><br><span class="line"><span class="function"><span class="params">        RequestProcessor nextProcessor)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">super</span>(<span class="string">"SyncThread:"</span> + zks.getServerId(), zks</span><br><span class="line">            .getZooKeeperServerListener());</span><br><span class="line">    <span class="keyword">this</span>.zks = zks;</span><br><span class="line">    <span class="keyword">this</span>.nextProcessor = nextProcessor;</span><br><span class="line">    running = <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="processRequest"><a href="#processRequest" class="headerlink" title="processRequest"></a>processRequest</h4><p>processRequest与上一个处理器一样都是放进队列中交由线程(run()方法)处理。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">processRequest</span><span class="params">(Request request)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// request.addRQRec("&gt;sync");</span></span><br><span class="line">    queuedRequests.add(request);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h4 id="run"><a href="#run" class="headerlink" title="run"></a>run</h4><p>run方法中<code>zks.getZKDatabase().append(si)</code>将请求记录到日志中，在<code>flush(toFlush)</code>执行commit将日志写入到硬盘中，写入成功后执行下一个处理器的processRequest方法。</p>
<p>根据<a href>初始请求处理器setupRequestProcessors()</a>可知下一个处理器是FinalRequestProcessor。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">int</span> logCount = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// we do this in an attempt to ensure that not all of the servers</span></span><br><span class="line">        <span class="comment">// in the ensemble take a snapshot at the same time</span></span><br><span class="line">        setRandRoll(r.nextInt(snapCount/<span class="number">2</span>));</span><br><span class="line">        <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">            Request si = <span class="keyword">null</span>;</span><br><span class="line">            <span class="keyword">if</span> (toFlush.isEmpty()) &#123;</span><br><span class="line">                si = queuedRequests.take();</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                si = queuedRequests.poll();</span><br><span class="line">                <span class="keyword">if</span> (si == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    flush(toFlush);</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (si == requestOfDeath) &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (si != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="comment">// track the number of records written to the log</span></span><br><span class="line">                <span class="keyword">if</span> (zks.getZKDatabase().append(si)) &#123;</span><br><span class="line">                    logCount++;</span><br><span class="line">                    <span class="keyword">if</span> (logCount &gt; (snapCount / <span class="number">2</span> + randRoll)) &#123;</span><br><span class="line">                        setRandRoll(r.nextInt(snapCount/<span class="number">2</span>));</span><br><span class="line">                        <span class="comment">// roll the log</span></span><br><span class="line">                        zks.getZKDatabase().rollLog();</span><br><span class="line">                        <span class="comment">// take a snapshot</span></span><br><span class="line">                        <span class="keyword">if</span> (snapInProcess != <span class="keyword">null</span> &amp;&amp; snapInProcess.isAlive()) &#123;</span><br><span class="line">                            LOG.warn(<span class="string">"Too busy to snap, skipping"</span>);</span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                            snapInProcess = <span class="keyword">new</span> ZooKeeperThread(<span class="string">"Snapshot Thread"</span>) &#123;</span><br><span class="line">                                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                                        <span class="keyword">try</span> &#123;</span><br><span class="line">                                            zks.takeSnapshot();</span><br><span class="line">                                        &#125; <span class="keyword">catch</span>(Exception e) &#123;</span><br><span class="line">                                            LOG.warn(<span class="string">"Unexpected exception"</span>, e);</span><br><span class="line">                                        &#125;</span><br><span class="line">                                    &#125;</span><br><span class="line">                                &#125;;</span><br><span class="line">                            snapInProcess.start();</span><br><span class="line">                        &#125;</span><br><span class="line">                        logCount = <span class="number">0</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (toFlush.isEmpty()) &#123;</span><br><span class="line">                    <span class="comment">// optimization for read heavy workloads</span></span><br><span class="line">                    <span class="comment">// iff this is a read, and there are no pending</span></span><br><span class="line">                    <span class="comment">// flushes (writes), then just pass this to the next</span></span><br><span class="line">                    <span class="comment">// processor</span></span><br><span class="line">                    <span class="keyword">if</span> (nextProcessor != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        nextProcessor.processRequest(si);</span><br><span class="line">                        <span class="keyword">if</span> (nextProcessor <span class="keyword">instanceof</span> Flushable) &#123;</span><br><span class="line">                            ((Flushable)nextProcessor).flush();</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                toFlush.add(si);</span><br><span class="line">                <span class="keyword">if</span> (toFlush.size() &gt; <span class="number">1000</span>) &#123;</span><br><span class="line">                    flush(toFlush);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">        handleException(<span class="keyword">this</span>.getName(), t);</span><br><span class="line">        running = <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    LOG.info(<span class="string">"SyncRequestProcessor exited!"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="FinalRequestProcessor类-请求处理及响应"><a href="#FinalRequestProcessor类-请求处理及响应" class="headerlink" title="FinalRequestProcessor类-请求处理及响应"></a>FinalRequestProcessor类-请求处理及响应</h3><p>FinalRequestProcessor是最后的处理器，负责处理</p>
<h4 id="继承关系-2"><a href="#继承关系-2" class="headerlink" title="继承关系"></a>继承关系</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FinalRequestProcessor</span> <span class="keyword">implements</span> <span class="title">RequestProcessor</span></span>&#123;&#125;</span><br></pre></td></tr></table></figure>
<h4 id="构造器-3"><a href="#构造器-3" class="headerlink" title="构造器"></a>构造器</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">FinalRequestProcessor</span><span class="params">(ZooKeeperServer zks)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.zks = zks;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="processRequest-1"><a href="#processRequest-1" class="headerlink" title="processRequest"></a>processRequest</h4><ol>
<li>request.hdr != null （hdr在PreRequest类中生成）代表写请求执行<br>ZooKeeperServer.processTxn()-&gt;getZKDatabase().processTxn(hdr, txn);<br><br>将写请求在内存中执行</li>
<li>Request.isQuorum(request.type) 区分写操作，执行<br>zks.getZKDatabase().addCommittedProposal(request);<br><br>将内存中的数据写入到硬盘</li>
<li>清除小于当前请求zxid的请求；<ol>
<li>closeSession请求处理；</li>
<li>ping请求处理，响应；</li>
<li>createSession处理，创建session响应；</li>
<li>multi处理，将多请求封装成MultiResponse；</li>
<li>create/setData/setACL/check设置lastOp和Record对象(lastOp = “CREA”;rsp = new CreateResponse(rc.path);)</li>
<li>exits/getData/getACL/getChildren/getChildren2设置lastOp，校验权限并查询数据封装Response</li>
<li>setWatches设置lastOp,并设置对应的watches</li>
</ol>
</li>
<li>获取DataTree上最后接受的提案Zxid</li>
<li>封装ReplyHeader</li>
<li>向从服务器发送响应(cnxn.sendResponse(hdr, rsp, “response”);// 请求头，响应，类型)<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">processRequest</span><span class="params">(Request request)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (LOG.isDebugEnabled()) &#123;</span><br><span class="line">        LOG.debug(<span class="string">"Processing request:: "</span> + request);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// request.addRQRec("&gt;final");</span></span><br><span class="line">    <span class="keyword">long</span> traceMask = ZooTrace.CLIENT_REQUEST_TRACE_MASK;</span><br><span class="line">    <span class="keyword">if</span> (request.type == OpCode.ping) &#123;</span><br><span class="line">        traceMask = ZooTrace.SERVER_PING_TRACE_MASK;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (LOG.isTraceEnabled()) &#123;</span><br><span class="line">        ZooTrace.logRequest(LOG, traceMask, <span class="string">'E'</span>, request, <span class="string">""</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    ProcessTxnResult rc = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">synchronized</span> (zks.outstandingChanges) &#123;</span><br><span class="line">        <span class="keyword">while</span> (!zks.outstandingChanges.isEmpty()</span><br><span class="line">                &amp;&amp; zks.outstandingChanges.get(<span class="number">0</span>).zxid &lt;= request.zxid) &#123;</span><br><span class="line">            ChangeRecord cr = zks.outstandingChanges.remove(<span class="number">0</span>);</span><br><span class="line">            <span class="keyword">if</span> (cr.zxid &lt; request.zxid) &#123;</span><br><span class="line">                LOG.warn(<span class="string">"Zxid outstanding "</span></span><br><span class="line">                        + cr.zxid</span><br><span class="line">                        + <span class="string">" is less than current "</span> + request.zxid);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (zks.outstandingChangesForPath.get(cr.path) == cr) &#123;</span><br><span class="line">                zks.outstandingChangesForPath.remove(cr.path);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (request.hdr != <span class="keyword">null</span>) &#123;</span><br><span class="line">            TxnHeader hdr = request.hdr;</span><br><span class="line">            Record txn = request.txn;</span><br><span class="line"></span><br><span class="line">            rc = zks.processTxn(hdr, txn);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// do not add non quorum packets to the queue.</span></span><br><span class="line">        <span class="keyword">if</span> (Request.isQuorum(request.type)) &#123;</span><br><span class="line">            zks.getZKDatabase().addCommittedProposal(request);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (request.hdr != <span class="keyword">null</span> &amp;&amp; request.hdr.getType() == OpCode.closeSession) &#123;</span><br><span class="line">        ServerCnxnFactory scxn = zks.getServerCnxnFactory();</span><br><span class="line">        <span class="comment">// this might be possible since</span></span><br><span class="line">        <span class="comment">// we might just be playing diffs from the leader</span></span><br><span class="line">        <span class="keyword">if</span> (scxn != <span class="keyword">null</span> &amp;&amp; request.cnxn == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">// calling this if we have the cnxn results in the client's</span></span><br><span class="line">            <span class="comment">// close session response being lost - we've already closed</span></span><br><span class="line">            <span class="comment">// the session/socket here before we can send the closeSession</span></span><br><span class="line">            <span class="comment">// in the switch block below</span></span><br><span class="line">            scxn.closeSession(request.sessionId);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (request.cnxn == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    ServerCnxn cnxn = request.cnxn;</span><br><span class="line"></span><br><span class="line">    String lastOp = <span class="string">"NA"</span>;</span><br><span class="line">    zks.decInProcess();</span><br><span class="line">    Code err = Code.OK;</span><br><span class="line">    Record rsp = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">boolean</span> closeSession = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (request.hdr != <span class="keyword">null</span> &amp;&amp; request.hdr.getType() == OpCode.error) &#123;</span><br><span class="line">            <span class="keyword">throw</span> KeeperException.create(KeeperException.Code.get((</span><br><span class="line">                    (ErrorTxn) request.txn).getErr()));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        KeeperException ke = request.getException();</span><br><span class="line">        <span class="keyword">if</span> (ke != <span class="keyword">null</span> &amp;&amp; request.type != OpCode.multi) &#123;</span><br><span class="line">            <span class="keyword">throw</span> ke;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (LOG.isDebugEnabled()) &#123;</span><br><span class="line">            LOG.debug(<span class="string">"&#123;&#125;"</span>,request);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">switch</span> (request.type) &#123;</span><br><span class="line">        <span class="keyword">case</span> OpCode.ping: &#123;</span><br><span class="line">            zks.serverStats().updateLatency(request.createTime);</span><br><span class="line"></span><br><span class="line">            lastOp = <span class="string">"PING"</span>;</span><br><span class="line">            cnxn.updateStatsForResponse(request.cxid, request.zxid, lastOp,</span><br><span class="line">                    request.createTime, Time.currentElapsedTime());</span><br><span class="line"></span><br><span class="line">            cnxn.sendResponse(<span class="keyword">new</span> ReplyHeader(-<span class="number">2</span>,</span><br><span class="line">                    zks.getZKDatabase().getDataTreeLastProcessedZxid(), <span class="number">0</span>), <span class="keyword">null</span>, <span class="string">"response"</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">case</span> OpCode.createSession: &#123;</span><br><span class="line">            zks.serverStats().updateLatency(request.createTime);</span><br><span class="line"></span><br><span class="line">            lastOp = <span class="string">"SESS"</span>;</span><br><span class="line">            cnxn.updateStatsForResponse(request.cxid, request.zxid, lastOp,</span><br><span class="line">                    request.createTime, Time.currentElapsedTime());</span><br><span class="line"></span><br><span class="line">            zks.finishSessionInit(request.cnxn, <span class="keyword">true</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">case</span> OpCode.multi: &#123;</span><br><span class="line">            lastOp = <span class="string">"MULT"</span>;</span><br><span class="line">            rsp = <span class="keyword">new</span> MultiResponse() ;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> (ProcessTxnResult subTxnResult : rc.multiResult) &#123;</span><br><span class="line"></span><br><span class="line">                OpResult subResult ;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">switch</span> (subTxnResult.type) &#123;</span><br><span class="line">                    <span class="keyword">case</span> OpCode.check:</span><br><span class="line">                        subResult = <span class="keyword">new</span> CheckResult();</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    <span class="keyword">case</span> OpCode.create:</span><br><span class="line">                        subResult = <span class="keyword">new</span> CreateResult(subTxnResult.path);</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    <span class="keyword">case</span> OpCode.delete:</span><br><span class="line">                        subResult = <span class="keyword">new</span> DeleteResult();</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    <span class="keyword">case</span> OpCode.setData:</span><br><span class="line">                        subResult = <span class="keyword">new</span> SetDataResult(subTxnResult.stat);</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    <span class="keyword">case</span> OpCode.error:</span><br><span class="line">                        subResult = <span class="keyword">new</span> ErrorResult(subTxnResult.err) ;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    <span class="keyword">default</span>:</span><br><span class="line">                        <span class="keyword">throw</span> <span class="keyword">new</span> IOException(<span class="string">"Invalid type of op"</span>);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                ((MultiResponse)rsp).add(subResult);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">case</span> OpCode.create: &#123;</span><br><span class="line">            lastOp = <span class="string">"CREA"</span>;</span><br><span class="line">            rsp = <span class="keyword">new</span> CreateResponse(rc.path);</span><br><span class="line">            err = Code.get(rc.err);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">case</span> OpCode.delete: &#123;</span><br><span class="line">            lastOp = <span class="string">"DELE"</span>;</span><br><span class="line">            err = Code.get(rc.err);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">case</span> OpCode.setData: &#123;</span><br><span class="line">            lastOp = <span class="string">"SETD"</span>;</span><br><span class="line">            rsp = <span class="keyword">new</span> SetDataResponse(rc.stat);</span><br><span class="line">            err = Code.get(rc.err);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">case</span> OpCode.setACL: &#123;</span><br><span class="line">            lastOp = <span class="string">"SETA"</span>;</span><br><span class="line">            rsp = <span class="keyword">new</span> SetACLResponse(rc.stat);</span><br><span class="line">            err = Code.get(rc.err);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">case</span> OpCode.closeSession: &#123;</span><br><span class="line">            lastOp = <span class="string">"CLOS"</span>;</span><br><span class="line">            closeSession = <span class="keyword">true</span>;</span><br><span class="line">            err = Code.get(rc.err);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">case</span> OpCode.sync: &#123;</span><br><span class="line">            lastOp = <span class="string">"SYNC"</span>;</span><br><span class="line">            SyncRequest syncRequest = <span class="keyword">new</span> SyncRequest();</span><br><span class="line">            ByteBufferInputStream.byteBuffer2Record(request.request,</span><br><span class="line">                    syncRequest);</span><br><span class="line">            rsp = <span class="keyword">new</span> SyncResponse(syncRequest.getPath());</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">case</span> OpCode.check: &#123;</span><br><span class="line">            lastOp = <span class="string">"CHEC"</span>;</span><br><span class="line">            rsp = <span class="keyword">new</span> SetDataResponse(rc.stat);</span><br><span class="line">            err = Code.get(rc.err);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">case</span> OpCode.exists: &#123;</span><br><span class="line">            lastOp = <span class="string">"EXIS"</span>;</span><br><span class="line">            <span class="comment">// TODO we need to figure out the security requirement for this!</span></span><br><span class="line">            ExistsRequest existsRequest = <span class="keyword">new</span> ExistsRequest();</span><br><span class="line">            ByteBufferInputStream.byteBuffer2Record(request.request,</span><br><span class="line">                    existsRequest);</span><br><span class="line">            String path = existsRequest.getPath();</span><br><span class="line">            <span class="keyword">if</span> (path.indexOf(<span class="string">'\0'</span>) != -<span class="number">1</span>) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> KeeperException.BadArgumentsException();</span><br><span class="line">            &#125;</span><br><span class="line">            Stat stat = zks.getZKDatabase().statNode(path, existsRequest</span><br><span class="line">                    .getWatch() ? cnxn : <span class="keyword">null</span>);</span><br><span class="line">            rsp = <span class="keyword">new</span> ExistsResponse(stat);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">case</span> OpCode.getData: &#123;</span><br><span class="line">            lastOp = <span class="string">"GETD"</span>;</span><br><span class="line">            GetDataRequest getDataRequest = <span class="keyword">new</span> GetDataRequest();</span><br><span class="line">            ByteBufferInputStream.byteBuffer2Record(request.request,</span><br><span class="line">                    getDataRequest);</span><br><span class="line">            DataNode n = zks.getZKDatabase().getNode(getDataRequest.getPath());</span><br><span class="line">            <span class="keyword">if</span> (n == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> KeeperException.NoNodeException();</span><br><span class="line">            &#125;</span><br><span class="line">            PrepRequestProcessor.checkACL(zks, zks.getZKDatabase().aclForNode(n),</span><br><span class="line">                    ZooDefs.Perms.READ,</span><br><span class="line">                    request.authInfo);</span><br><span class="line">            Stat stat = <span class="keyword">new</span> Stat();</span><br><span class="line">            <span class="keyword">byte</span> b[] = zks.getZKDatabase().getData(getDataRequest.getPath(), stat,</span><br><span class="line">                    getDataRequest.getWatch() ? cnxn : <span class="keyword">null</span>);</span><br><span class="line">            rsp = <span class="keyword">new</span> GetDataResponse(b, stat);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">case</span> OpCode.setWatches: &#123;</span><br><span class="line">            lastOp = <span class="string">"SETW"</span>;</span><br><span class="line">            SetWatches setWatches = <span class="keyword">new</span> SetWatches();</span><br><span class="line">            <span class="comment">// XXX We really should NOT need this!!!!</span></span><br><span class="line">            request.request.rewind();</span><br><span class="line">            ByteBufferInputStream.byteBuffer2Record(request.request, setWatches);</span><br><span class="line">            <span class="keyword">long</span> relativeZxid = setWatches.getRelativeZxid();</span><br><span class="line">            zks.getZKDatabase().setWatches(relativeZxid, </span><br><span class="line">                    setWatches.getDataWatches(), </span><br><span class="line">                    setWatches.getExistWatches(),</span><br><span class="line">                    setWatches.getChildWatches(), cnxn);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">case</span> OpCode.getACL: &#123;</span><br><span class="line">            lastOp = <span class="string">"GETA"</span>;</span><br><span class="line">            GetACLRequest getACLRequest = <span class="keyword">new</span> GetACLRequest();</span><br><span class="line">            ByteBufferInputStream.byteBuffer2Record(request.request,</span><br><span class="line">                    getACLRequest);</span><br><span class="line">            Stat stat = <span class="keyword">new</span> Stat();</span><br><span class="line">            List&lt;ACL&gt; acl = </span><br><span class="line">                zks.getZKDatabase().getACL(getACLRequest.getPath(), stat);</span><br><span class="line">            rsp = <span class="keyword">new</span> GetACLResponse(acl, stat);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">case</span> OpCode.getChildren: &#123;</span><br><span class="line">            lastOp = <span class="string">"GETC"</span>;</span><br><span class="line">            GetChildrenRequest getChildrenRequest = <span class="keyword">new</span> GetChildrenRequest();</span><br><span class="line">            ByteBufferInputStream.byteBuffer2Record(request.request,</span><br><span class="line">                    getChildrenRequest);</span><br><span class="line">            DataNode n = zks.getZKDatabase().getNode(getChildrenRequest.getPath());</span><br><span class="line">            <span class="keyword">if</span> (n == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> KeeperException.NoNodeException();</span><br><span class="line">            &#125;</span><br><span class="line">            PrepRequestProcessor.checkACL(zks, zks.getZKDatabase().aclForNode(n),</span><br><span class="line">                    ZooDefs.Perms.READ,</span><br><span class="line">                    request.authInfo);</span><br><span class="line">            List&lt;String&gt; children = zks.getZKDatabase().getChildren(</span><br><span class="line">                    getChildrenRequest.getPath(), <span class="keyword">null</span>, getChildrenRequest</span><br><span class="line">                            .getWatch() ? cnxn : <span class="keyword">null</span>);</span><br><span class="line">            rsp = <span class="keyword">new</span> GetChildrenResponse(children);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">case</span> OpCode.getChildren2: &#123;</span><br><span class="line">            lastOp = <span class="string">"GETC"</span>;</span><br><span class="line">            GetChildren2Request getChildren2Request = <span class="keyword">new</span> GetChildren2Request();</span><br><span class="line">            ByteBufferInputStream.byteBuffer2Record(request.request,</span><br><span class="line">                    getChildren2Request);</span><br><span class="line">            Stat stat = <span class="keyword">new</span> Stat();</span><br><span class="line">            DataNode n = zks.getZKDatabase().getNode(getChildren2Request.getPath());</span><br><span class="line">            <span class="keyword">if</span> (n == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> KeeperException.NoNodeException();</span><br><span class="line">            &#125;</span><br><span class="line">            PrepRequestProcessor.checkACL(zks, zks.getZKDatabase().aclForNode(n),</span><br><span class="line">                    ZooDefs.Perms.READ,</span><br><span class="line">                    request.authInfo);</span><br><span class="line">            List&lt;String&gt; children = zks.getZKDatabase().getChildren(</span><br><span class="line">                    getChildren2Request.getPath(), stat, getChildren2Request</span><br><span class="line">                            .getWatch() ? cnxn : <span class="keyword">null</span>);</span><br><span class="line">            rsp = <span class="keyword">new</span> GetChildren2Response(children, stat);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (SessionMovedException e) &#123;</span><br><span class="line">        <span class="comment">// session moved is a connection level error, we need to tear</span></span><br><span class="line">        <span class="comment">// down the connection otw ZOOKEEPER-710 might happen</span></span><br><span class="line">        <span class="comment">// ie client on slow follower starts to renew session, fails</span></span><br><span class="line">        <span class="comment">// before this completes, then tries the fast follower (leader)</span></span><br><span class="line">        <span class="comment">// and is successful, however the initial renew is then </span></span><br><span class="line">        <span class="comment">// successfully fwd/processed by the leader and as a result</span></span><br><span class="line">        <span class="comment">// the client and leader disagree on where the client is most</span></span><br><span class="line">        <span class="comment">// recently attached (and therefore invalid SESSION MOVED generated)</span></span><br><span class="line">        cnxn.sendCloseSession();</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (KeeperException e) &#123;</span><br><span class="line">        err = e.code();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        <span class="comment">// log at error level as we are returning a marshalling</span></span><br><span class="line">        <span class="comment">// error to the user</span></span><br><span class="line">        LOG.error(<span class="string">"Failed to process "</span> + request, e);</span><br><span class="line">        StringBuilder sb = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">        ByteBuffer bb = request.request;</span><br><span class="line">        bb.rewind();</span><br><span class="line">        <span class="keyword">while</span> (bb.hasRemaining()) &#123;</span><br><span class="line">            sb.append(Integer.toHexString(bb.get() &amp; <span class="number">0xff</span>));</span><br><span class="line">        &#125;</span><br><span class="line">        LOG.error(<span class="string">"Dumping request buffer: 0x"</span> + sb.toString());</span><br><span class="line">        err = Code.MARSHALLINGERROR;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">long</span> lastZxid = zks.getZKDatabase().getDataTreeLastProcessedZxid();</span><br><span class="line">    ReplyHeader hdr =</span><br><span class="line">        <span class="keyword">new</span> ReplyHeader(request.cxid, lastZxid, err.intValue());</span><br><span class="line"></span><br><span class="line">    zks.serverStats().updateLatency(request.createTime);</span><br><span class="line">    cnxn.updateStatsForResponse(request.cxid, lastZxid, lastOp,</span><br><span class="line">                request.createTime, Time.currentElapsedTime());</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        cnxn.sendResponse(hdr, rsp, <span class="string">"response"</span>);</span><br><span class="line">        <span class="keyword">if</span> (closeSession) &#123;</span><br><span class="line">            cnxn.sendCloseSession();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">        LOG.error(<span class="string">"FIXMSG"</span>,e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h1 id="LeaderZooKeeperServer类"><a href="#LeaderZooKeeperServer类" class="headerlink" title="LeaderZooKeeperServer类"></a>LeaderZooKeeperServer类</h1><h2 id="继承关系-3"><a href="#继承关系-3" class="headerlink" title="继承关系"></a>继承关系</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LeaderZooKeeperServer</span> <span class="keyword">extends</span> <span class="title">QuorumZooKeeperServer</span> </span>&#123;&#125;</span><br></pre></td></tr></table></figure>
<p>因为LeaderZooKeeperServer继承了QuorumZooKeeperServer，所以先看看QuorumZooKeeperServer类</p>
<h3 id="QuorumZooKeeperServer类"><a href="#QuorumZooKeeperServer类" class="headerlink" title="QuorumZooKeeperServer类"></a>QuorumZooKeeperServer类</h3><h4 id="继承关系-4"><a href="#继承关系-4" class="headerlink" title="继承关系"></a>继承关系</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">QuorumZooKeeperServer</span> <span class="keyword">extends</span> <span class="title">ZooKeeperServer</span></span>&#123;&#125;</span><br></pre></td></tr></table></figure>
<h4 id="方法"><a href="#方法" class="headerlink" title="方法"></a>方法</h4><p>QuorumZooKeeperServer重写了两个方法，dumpConf变成打印，setState还是保存。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">dumpConf</span><span class="params">(PrintWriter pwriter)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">super</span>.dumpConf(pwriter);</span><br><span class="line"></span><br><span class="line">    pwriter.print(<span class="string">"initLimit="</span>);</span><br><span class="line">    pwriter.println(self.getInitLimit());</span><br><span class="line">    pwriter.print(<span class="string">"syncLimit="</span>);</span><br><span class="line">    pwriter.println(self.getSyncLimit());</span><br><span class="line">    pwriter.print(<span class="string">"electionAlg="</span>);</span><br><span class="line">    pwriter.println(self.getElectionType());</span><br><span class="line">    pwriter.print(<span class="string">"electionPort="</span>);</span><br><span class="line">    pwriter.println(self.quorumPeers.get(self.getId()).electionAddr</span><br><span class="line">            .getPort());</span><br><span class="line">    pwriter.print(<span class="string">"quorumPort="</span>);</span><br><span class="line">    pwriter.println(self.quorumPeers.get(self.getId()).addr.getPort());</span><br><span class="line">    pwriter.print(<span class="string">"peerType="</span>);</span><br><span class="line">    pwriter.println(self.getLearnerType().ordinal());</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">setState</span><span class="params">(State state)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.state = state;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="构造器-4"><a href="#构造器-4" class="headerlink" title="构造器"></a>构造器</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">LeaderZooKeeperServer(FileTxnSnapLog logFactory, QuorumPeer self,</span><br><span class="line">        DataTreeBuilder treeBuilder, ZKDatabase zkDb) <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="keyword">super</span>(logFactory, self.tickTime, self.minSessionTimeout,</span><br><span class="line">            self.maxSessionTimeout, treeBuilder, zkDb, self);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="处理链"><a href="#处理链" class="headerlink" title="处理链"></a>处理链</h2><p>LeaderZooKeeperServer重写了处理链的初始化，使得处理流程与单机版不一样<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">setupRequestProcessors</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    RequestProcessor finalProcessor = <span class="keyword">new</span> FinalRequestProcessor(<span class="keyword">this</span>);</span><br><span class="line">    RequestProcessor toBeAppliedProcessor = <span class="keyword">new</span> Leader.ToBeAppliedRequestProcessor(</span><br><span class="line">            finalProcessor, getLeader().toBeApplied);</span><br><span class="line">    commitProcessor = <span class="keyword">new</span> CommitProcessor(toBeAppliedProcessor,</span><br><span class="line">            Long.toString(getServerId()), <span class="keyword">false</span>,</span><br><span class="line">            getZooKeeperServerListener());</span><br><span class="line">    commitProcessor.start();</span><br><span class="line">    ProposalRequestProcessor proposalProcessor = <span class="keyword">new</span> ProposalRequestProcessor(<span class="keyword">this</span>,</span><br><span class="line">            commitProcessor);</span><br><span class="line">    proposalProcessor.initialize();</span><br><span class="line">    firstProcessor = <span class="keyword">new</span> PrepRequestProcessor(<span class="keyword">this</span>, proposalProcessor);</span><br><span class="line">    ((PrepRequestProcessor)firstProcessor).start();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>几个处理器在上一节<a href="#submitRequest提交请求">ZookeeperServer.submitRequest提交请求</a>中已经接下，接下来解析其它几个。</p>
<h3 id="ProposalRequestProcessor类-发起判断提案"><a href="#ProposalRequestProcessor类-发起判断提案" class="headerlink" title="ProposalRequestProcessor类-发起判断提案"></a>ProposalRequestProcessor类-发起判断提案</h3><p>ProposalRequestProcessor向各个服务器发送提案，将提案交由CommitProcessor去处理（得到过半服务器响应后会回调CommitProcessor继续处理）；同时调用SyncRequestProcessor将日志记录到硬盘中。</p>
<h4 id="构造器-5"><a href="#构造器-5" class="headerlink" title="构造器"></a>构造器</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">ProposalRequestProcessor</span><span class="params">(LeaderZooKeeperServer zks,</span></span></span><br><span class="line"><span class="function"><span class="params">        RequestProcessor nextProcessor)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.zks = zks;</span><br><span class="line">    <span class="keyword">this</span>.nextProcessor = nextProcessor;</span><br><span class="line">    AckRequestProcessor ackProcessor = <span class="keyword">new</span> AckRequestProcessor(zks.getLeader());</span><br><span class="line">    syncProcessor = <span class="keyword">new</span> SyncRequestProcessor(zks, ackProcessor);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="processRequest-2"><a href="#processRequest-2" class="headerlink" title="processRequest"></a>processRequest</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">processRequest</span><span class="params">(Request request)</span> <span class="keyword">throws</span> RequestProcessorException </span>&#123;</span><br><span class="line">    <span class="comment">// LOG.warn("Ack&gt;&gt;&gt; cxid = " + request.cxid + " type = " +</span></span><br><span class="line">    <span class="comment">// request.type + " id = " + request.sessionId);</span></span><br><span class="line">    <span class="comment">// request.addRQRec("&gt;prop");</span></span><br><span class="line">            </span><br><span class="line">    <span class="comment">/* In the following IF-THEN-ELSE block, we process syncs on the leader. </span></span><br><span class="line"><span class="comment">    * If the sync is coming from a follower, then the follower</span></span><br><span class="line"><span class="comment">    * handler adds it to syncHandler. Otherwise, if it is a client of</span></span><br><span class="line"><span class="comment">    * the leader that issued the sync command, then syncHandler won't </span></span><br><span class="line"><span class="comment">    * contain the handler. In this case, we add it to syncHandler, and </span></span><br><span class="line"><span class="comment">    * call processRequest on the next processor.</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="comment">// 同步请求</span></span><br><span class="line">    <span class="keyword">if</span>(request <span class="keyword">instanceof</span> LearnerSyncRequest)&#123;</span><br><span class="line">        zks.getLeader().processSync((LearnerSyncRequest)request);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 调用下一个处理器CommitProcessor，此时CommitProcessor不会直接提交提案，会等待下面一步向所有服务器发起请求，</span></span><br><span class="line">            <span class="comment">// 且过半服务器同意后才会继续执行这个请求</span></span><br><span class="line">            nextProcessor.processRequest(request);</span><br><span class="line">        <span class="keyword">if</span> (request.hdr != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">// We need to sync and get consensus on any transactions</span></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// 这里发起向所有从服务器发起提案请求leader.propose() -&gt; 统计同意数，更新LearnerHandler.run()</span></span><br><span class="line">                <span class="comment">// -&gt; leader.processAck() -&gt; commitProcessor.commit(request)</span></span><br><span class="line">                <span class="comment">//  -&gt; 此时commitProcessor线程继续执行</span></span><br><span class="line">                zks.getLeader().propose(request);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (XidRolloverException e) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> RequestProcessorException(e.getMessage(), e);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 日志记录到硬盘</span></span><br><span class="line">            syncProcessor.processRequest(request);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="CommitProcessor类-两步提交处理"><a href="#CommitProcessor类-两步提交处理" class="headerlink" title="CommitProcessor类-两步提交处理"></a>CommitProcessor类-两步提交处理</h3><h4 id="构造器-6"><a href="#构造器-6" class="headerlink" title="构造器"></a>构造器</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">CommitProcessor</span><span class="params">(RequestProcessor nextProcessor, String id,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">boolean</span> matchSyncs, ZooKeeperServerListener listener)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">super</span>(<span class="string">"CommitProcessor:"</span> + id, listener);</span><br><span class="line">    <span class="keyword">this</span>.nextProcessor = nextProcessor;</span><br><span class="line">    <span class="keyword">this</span>.matchSyncs = matchSyncs;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="processRequest方法"><a href="#processRequest方法" class="headerlink" title="processRequest方法"></a>processRequest方法</h4><p>processRequest()方法将requet放入队列<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">synchronized</span> <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">processRequest</span><span class="params">(Request request)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// request.addRQRec("&gt;commit");</span></span><br><span class="line">    <span class="keyword">if</span> (LOG.isDebugEnabled()) &#123;</span><br><span class="line">        LOG.debug(<span class="string">"Processing request:: "</span> + request);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!finished) &#123;</span><br><span class="line">        queuedRequests.add(request);</span><br><span class="line">        notifyAll();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h4 id="commit方法"><a href="#commit方法" class="headerlink" title="commit方法"></a>commit方法</h4><p>提案通过过半服务器响应，回调commit方法执行提案.</p>
<p>LearnerHandler.run() -&gt; leader.processAck() -&gt; commitProcessor.commit(request)<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">synchronized</span> <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">commit</span><span class="params">(Request request)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!finished) &#123;</span><br><span class="line">        <span class="keyword">if</span> (request == <span class="keyword">null</span>) &#123;</span><br><span class="line">            LOG.warn(<span class="string">"Committed a null!"</span>,</span><br><span class="line">                        <span class="keyword">new</span> Exception(<span class="string">"committing a null! "</span>));</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (LOG.isDebugEnabled()) &#123;</span><br><span class="line">            LOG.debug(<span class="string">"Committing request:: "</span> + request);</span><br><span class="line">        &#125;</span><br><span class="line">        committedRequests.add(request);</span><br><span class="line">        notifyAll();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h4 id="run-1"><a href="#run-1" class="headerlink" title="run()"></a>run()</h4><ol>
<li>create/delete/setData/multi/setACL/createSession/closeSession类型的请求会保存到nextPending中；</li>
<li>如果committedRequests需要提交的请求队列如果为空则等待；</li>
<li>LearnerHandler.run() -&gt; leader.processAck() -&gt; commitProcessor.commit(request) 过半服务器同意的请求加入到committedRequests队列</li>
<li>将请求保存到toProcess队列中</li>
<li>toProcess队列中的请求使用nextProcessor去执行。<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        Request nextPending = <span class="keyword">null</span>;            </span><br><span class="line">        <span class="keyword">while</span> (!finished) &#123;</span><br><span class="line">            <span class="keyword">int</span> len = toProcess.size();</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; len; i++) &#123;</span><br><span class="line">                nextProcessor.processRequest(toProcess.get(i));</span><br><span class="line">            &#125;</span><br><span class="line">            toProcess.clear();</span><br><span class="line">            <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> ((queuedRequests.size() == <span class="number">0</span> || nextPending != <span class="keyword">null</span>)</span><br><span class="line">                        &amp;&amp; committedRequests.size() == <span class="number">0</span>) &#123;</span><br><span class="line">                    wait();</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// First check and see if the commit came in for the pending</span></span><br><span class="line">                <span class="comment">// request</span></span><br><span class="line">                <span class="keyword">if</span> ((queuedRequests.size() == <span class="number">0</span> || nextPending != <span class="keyword">null</span>)</span><br><span class="line">                        &amp;&amp; committedRequests.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                    Request r = committedRequests.remove();</span><br><span class="line">                    <span class="comment">/*</span></span><br><span class="line"><span class="comment">                        * We match with nextPending so that we can move to the</span></span><br><span class="line"><span class="comment">                        * next request when it is committed. We also want to</span></span><br><span class="line"><span class="comment">                        * use nextPending because it has the cnxn member set</span></span><br><span class="line"><span class="comment">                        * properly.</span></span><br><span class="line"><span class="comment">                        */</span></span><br><span class="line">                    <span class="keyword">if</span> (nextPending != <span class="keyword">null</span></span><br><span class="line">                            &amp;&amp; nextPending.sessionId == r.sessionId</span><br><span class="line">                            &amp;&amp; nextPending.cxid == r.cxid) &#123;</span><br><span class="line">                        <span class="comment">// we want to send our version of the request.</span></span><br><span class="line">                        <span class="comment">// the pointer to the connection in the request</span></span><br><span class="line">                        nextPending.hdr = r.hdr;</span><br><span class="line">                        nextPending.txn = r.txn;</span><br><span class="line">                        nextPending.zxid = r.zxid;</span><br><span class="line">                        toProcess.add(nextPending);</span><br><span class="line">                        nextPending = <span class="keyword">null</span>;</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        <span class="comment">// this request came from someone else so just</span></span><br><span class="line">                        <span class="comment">// send the commit packet</span></span><br><span class="line">                        toProcess.add(r);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// We haven't matched the pending requests, so go back to</span></span><br><span class="line">            <span class="comment">// waiting</span></span><br><span class="line">            <span class="keyword">if</span> (nextPending != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">                <span class="comment">// Process the next requests in the queuedRequests</span></span><br><span class="line">                <span class="keyword">while</span> (nextPending == <span class="keyword">null</span> &amp;&amp; queuedRequests.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                    Request request = queuedRequests.remove();</span><br><span class="line">                    <span class="keyword">switch</span> (request.type) &#123;</span><br><span class="line">                    <span class="keyword">case</span> OpCode.create:</span><br><span class="line">                    <span class="keyword">case</span> OpCode.delete:</span><br><span class="line">                    <span class="keyword">case</span> OpCode.setData:</span><br><span class="line">                    <span class="keyword">case</span> OpCode.multi:</span><br><span class="line">                    <span class="keyword">case</span> OpCode.setACL:</span><br><span class="line">                    <span class="keyword">case</span> OpCode.createSession:</span><br><span class="line">                    <span class="keyword">case</span> OpCode.closeSession:</span><br><span class="line">                        nextPending = request;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    <span class="keyword">case</span> OpCode.sync:</span><br><span class="line">                        <span class="keyword">if</span> (matchSyncs) &#123;</span><br><span class="line">                            nextPending = request;</span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                            toProcess.add(request);</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    <span class="keyword">default</span>:</span><br><span class="line">                        toProcess.add(request);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">        LOG.warn(<span class="string">"Interrupted exception while waiting"</span>, e);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">        LOG.error(<span class="string">"Unexpected exception causing CommitProcessor to exit"</span>, e);</span><br><span class="line">    &#125;</span><br><span class="line">    LOG.info(<span class="string">"CommitProcessor exited loop!"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h3 id="ToBeAppliedRequestProcessor类-清理Leader类中的提案"><a href="#ToBeAppliedRequestProcessor类-清理Leader类中的提案" class="headerlink" title="ToBeAppliedRequestProcessor类-清理Leader类中的提案"></a>ToBeAppliedRequestProcessor类-清理Leader类中的提案</h3><h4 id="构造器-7"><a href="#构造器-7" class="headerlink" title="构造器"></a>构造器</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">ToBeAppliedRequestProcessor(RequestProcessor next,</span><br><span class="line">        ConcurrentLinkedQueue&lt;Proposal&gt; toBeApplied) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!(next <span class="keyword">instanceof</span> FinalRequestProcessor)) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(ToBeAppliedRequestProcessor.class</span><br><span class="line">                .getName()</span><br><span class="line">                + <span class="string">" must be connected to "</span></span><br><span class="line">                + FinalRequestProcessor.class.getName()</span><br><span class="line">                + <span class="string">" not "</span></span><br><span class="line">                + next.getClass().getName());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">this</span>.toBeApplied = toBeApplied;</span><br><span class="line">    <span class="keyword">this</span>.next = next;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="processRequest方法-1"><a href="#processRequest方法-1" class="headerlink" title="processRequest方法"></a>processRequest方法</h4><p>调用下一个处理器（FinalRequestProcessor）去处理，去除Leader.toBeApplied队列头的提案<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">processRequest</span><span class="params">(Request request)</span> <span class="keyword">throws</span> RequestProcessorException </span>&#123;</span><br><span class="line">    <span class="comment">// request.addRQRec("&gt;tobe");</span></span><br><span class="line">    next.processRequest(request);</span><br><span class="line">    Proposal p = toBeApplied.peek();</span><br><span class="line">    <span class="keyword">if</span> (p != <span class="keyword">null</span> &amp;&amp; p.request != <span class="keyword">null</span></span><br><span class="line">            &amp;&amp; p.request.zxid == request.zxid) &#123;</span><br><span class="line">        toBeApplied.remove();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
</div><div class="tags"><a href="/tags/zookeeper/">zookeeper</a></div><div class="post-nav"><a class="pre" href="/2019/02/20/zk解析(4)-Learner/">zk解析(4)：Learner</a><a class="next" href="/2019/01/02/zk解析(2)-zk集群Leader初始化/">zk解析(2)：zk集群Leader初始化leader.lead()</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form class="search-form" action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank"><input type="text" name="q" maxlength="20" placeholder="Search"><input type="hidden" name="sitesearch" value="https://SvizzerChow.github.io"></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Java/">Java</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Netty/">Netty</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Sentinel/">Sentinel</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/redis/">redis</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/sharding-jdbc/">sharding-jdbc</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/分布式/">分布式</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/并发/">并发</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/数据库/">数据库</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/算法/">算法</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/线程池/">线程池</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/网络/">网络</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/虚拟机/">虚拟机</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/TCP/" style="font-size: 15px;">TCP</a> <a href="/tags/BASE理论/" style="font-size: 15px;">BASE理论</a> <a href="/tags/虚拟机/" style="font-size: 15px;">虚拟机</a> <a href="/tags/JavaAgent/" style="font-size: 15px;">JavaAgent</a> <a href="/tags/集合/" style="font-size: 15px;">集合</a> <a href="/tags/可见性/" style="font-size: 15px;">可见性</a> <a href="/tags/内存模型/" style="font-size: 15px;">内存模型</a> <a href="/tags/MESI/" style="font-size: 15px;">MESI</a> <a href="/tags/volatile/" style="font-size: 15px;">volatile</a> <a href="/tags/MySQL/" style="font-size: 15px;">MySQL</a> <a href="/tags/网络/" style="font-size: 15px;">网络</a> <a href="/tags/Netty/" style="font-size: 15px;">Netty</a> <a href="/tags/channel/" style="font-size: 15px;">channel</a> <a href="/tags/ServerBootstrap/" style="font-size: 15px;">ServerBootstrap</a> <a href="/tags/NioEventLoop/" style="font-size: 15px;">NioEventLoop</a> <a href="/tags/启动/" style="font-size: 15px;">启动</a> <a href="/tags/线程模型/" style="font-size: 15px;">线程模型</a> <a href="/tags/读写事件/" style="font-size: 15px;">读写事件</a> <a href="/tags/http/" style="font-size: 15px;">http</a> <a href="/tags/沾包/" style="font-size: 15px;">沾包</a> <a href="/tags/拆包/" style="font-size: 15px;">拆包</a> <a href="/tags/内存/" style="font-size: 15px;">内存</a> <a href="/tags/NIO/" style="font-size: 15px;">NIO</a> <a href="/tags/限流/" style="font-size: 15px;">限流</a> <a href="/tags/降级/" style="font-size: 15px;">降级</a> <a href="/tags/熔断/" style="font-size: 15px;">熔断</a> <a href="/tags/Sentinel/" style="font-size: 15px;">Sentinel</a> <a href="/tags/源码解析/" style="font-size: 15px;">源码解析</a> <a href="/tags/CAP理论/" style="font-size: 15px;">CAP理论</a> <a href="/tags/原子性/" style="font-size: 15px;">原子性</a> <a href="/tags/long/" style="font-size: 15px;">long</a> <a href="/tags/double/" style="font-size: 15px;">double</a> <a href="/tags/并发/" style="font-size: 15px;">并发</a> <a href="/tags/redis/" style="font-size: 15px;">redis</a> <a href="/tags/NoSQL/" style="font-size: 15px;">NoSQL</a> <a href="/tags/sentinel/" style="font-size: 15px;">sentinel</a> <a href="/tags/zookeeper/" style="font-size: 15px;">zookeeper</a> <a href="/tags/分布式锁/" style="font-size: 15px;">分布式锁</a> <a href="/tags/数据库/" style="font-size: 15px;">数据库</a> <a href="/tags/分库分表/" style="font-size: 15px;">分库分表</a> <a href="/tags/io/" style="font-size: 15px;">io</a> <a href="/tags/同步/" style="font-size: 15px;">同步</a> <a href="/tags/异步/" style="font-size: 15px;">异步</a> <a href="/tags/线程池/" style="font-size: 15px;">线程池</a> <a href="/tags/Java/" style="font-size: 15px;">Java</a> <a href="/tags/Excutors/" style="font-size: 15px;">Excutors</a> <a href="/tags/多线程/" style="font-size: 15px;">多线程</a> <a href="/tags/FutureTask/" style="font-size: 15px;">FutureTask</a> <a href="/tags/AbstractExecutorService/" style="font-size: 15px;">AbstractExecutorService</a> <a href="/tags/ThreadPoolExecutor/" style="font-size: 15px;">ThreadPoolExecutor</a> <a href="/tags/缓存/" style="font-size: 15px;">缓存</a> <a href="/tags/缓存行/" style="font-size: 15px;">缓存行</a> <a href="/tags/轮询/" style="font-size: 15px;">轮询</a> <a href="/tags/算法/" style="font-size: 15px;">算法</a> <a href="/tags/ScheduledThreadPoolExecutor/" style="font-size: 15px;">ScheduledThreadPoolExecutor</a> <a href="/tags/Spring/" style="font-size: 15px;">Spring</a> <a href="/tags/sharding-jdbc/" style="font-size: 15px;">sharding-jdbc</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2020/03/06/Netty之旅24PoolArena/">Netty解析二十二：Netty内存分配PoolArena</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/03/05/Netty之旅23内存分配模型/">Netty解析二十一：Netty内存分配模型</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/03/03/同步异步和阻塞非阻塞/">同步/异步与阻塞/非阻塞</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/03/02/Netty之旅22Netty沾包拆包/">Netty解析二十：Netty中的拆包沾包处理</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/03/01/TCP协议如何保证可靠性/">TCP协议如何保证可靠性</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/01/05/Netty之旅21Netty中的buffer/">Netty解析十九：Netty中的buffer</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/01/04/Netty之旅20服务器端http请求读写流程/">Netty解析十八：Netty服务器端读写事件流程</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/12/21/常用线程池区分/">Executors常用线程池区分</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/12/17/Netty之旅19线程模型/">Netty解析十七：Netty线程模型</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/12/17/Netty之旅18服务端启动流程/">Netty解析十六：Netty服务端启动流程</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2017-2020 <a href="/." rel="nofollow">SvizzerChow's Blog.</a><a rel="nofollow" target="_blank" href="http://www.beian.miit.gov.cn"> 浙ICP备18053179号</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>