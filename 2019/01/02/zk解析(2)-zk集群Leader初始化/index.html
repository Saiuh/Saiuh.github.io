<!DOCTYPE html><html lang="zh-CN"><head><meta name="generator" content="Hexo 3.9.0"><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="我的个人博客"><title>zk解析(2)：zk集群Leader初始化leader.lead() | SvizzerChow's Blog</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/normalize/8.0.1/normalize.min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/1.0.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/1.0.0/grids-responsive-min.css"><link rel="stylesheet" href="//lib.baomitu.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//lib.baomitu.com/jquery/3.4.0/jquery.min.js"></script><link rel="icon" mask sizes="any" href="/favicon.ico"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">zk解析(2)：zk集群Leader初始化leader.lead()</h1><a id="logo" href="/.">SvizzerChow's Blog</a><p class="description">Leaning</p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">zk解析(2)：zk集群Leader初始化leader.lead()</h1><div class="post-meta">Jan 2, 2019<span> | </span><span class="category"><a href="/categories/分布式/">分布式</a></span></div><div class="post-content"><p>根据zk集群启动QuorumPeerMain的解析，可以知道当前节点为主节点时，节点状态变为LEADING。<br><a id="more"></a><br>代码：org.apache.zookeeper.server.quorum.QuorumPeer#run<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="keyword">case</span> LEADING:</span><br><span class="line">        LOG.info(<span class="string">"LEADING"</span>);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            setLeader(makeLeader(logFactory));</span><br><span class="line">            <span class="comment">// 选主后的内容</span></span><br><span class="line">            leader.lead();</span><br><span class="line">            setLeader(<span class="keyword">null</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            LOG.warn(<span class="string">"Unexpected exception"</span>,e);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (leader != <span class="keyword">null</span>) &#123;</span><br><span class="line">                leader.shutdown(<span class="string">"Forcing shutdown"</span>);</span><br><span class="line">                setLeader(<span class="keyword">null</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            setPeerState(ServerState.LOOKING);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="comment">// ...    </span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>由代码可知，转为LEADING后执行leader.lead()。</p>
<h2 id="Leader类"><a href="#Leader类" class="headerlink" title="Leader类"></a>Leader类</h2><h3 id="简化流程图"><a href="#简化流程图" class="headerlink" title="简化流程图"></a>简化流程图</h3><p><img src="https://imgchr.com/i/kEujP0" alt="Leader.leader()简化流程图"></p>
<h3 id="构造器"><a href="#构造器" class="headerlink" title="构造器"></a>构造器</h3><p>Leader类在构造器期间启动了ServerSocket监听请求。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">Leader(QuorumPeer self,LeaderZooKeeperServer zk) <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="keyword">this</span>.self = self;</span><br><span class="line">    <span class="keyword">this</span>.proposalStats = <span class="keyword">new</span> ProposalStats();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (self.getQuorumListenOnAllIPs()) &#123;</span><br><span class="line">            ss = <span class="keyword">new</span> ServerSocket(self.getQuorumAddress().getPort());</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            ss = <span class="keyword">new</span> ServerSocket();</span><br><span class="line">        &#125;</span><br><span class="line">        ss.setReuseAddress(<span class="keyword">true</span>);</span><br><span class="line">        <span class="keyword">if</span> (!self.getQuorumListenOnAllIPs()) &#123;</span><br><span class="line">            ss.bind(self.getQuorumAddress());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (BindException e) &#123;</span><br><span class="line">        <span class="keyword">if</span> (self.getQuorumListenOnAllIPs()) &#123;</span><br><span class="line">            LOG.error(<span class="string">"Couldn't bind to port "</span> + self.getQuorumAddress().getPort(), e);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            LOG.error(<span class="string">"Couldn't bind to "</span> + self.getQuorumAddress(), e);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">throw</span> e;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">this</span>.zk=zk;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="propose-发送提案"><a href="#propose-发送提案" class="headerlink" title="propose() 发送提案"></a>propose() 发送提案</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Proposal <span class="title">propose</span><span class="params">(Request request)</span> <span class="keyword">throws</span> XidRolloverException </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">        * Address the rollover issue. All lower 32bits set indicate a new leader</span></span><br><span class="line"><span class="comment">        * election. Force a re-election instead. See ZOOKEEPER-1277</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">    <span class="keyword">if</span> ((request.zxid &amp; <span class="number">0xffffffffL</span>) == <span class="number">0xffffffffL</span>) &#123;</span><br><span class="line">        String msg =</span><br><span class="line">                <span class="string">"zxid lower 32 bits have rolled over, forcing re-election, and therefore new epoch start"</span>;</span><br><span class="line">        shutdown(msg);</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> XidRolloverException(msg);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">byte</span>[] data = SerializeUtils.serializeRequest(request);</span><br><span class="line">    proposalStats.setLastProposalSize(data.length);</span><br><span class="line">    QuorumPacket pp = <span class="keyword">new</span> QuorumPacket(Leader.PROPOSAL, request.zxid, data, <span class="keyword">null</span>);</span><br><span class="line">    </span><br><span class="line">    Proposal p = <span class="keyword">new</span> Proposal();</span><br><span class="line">    p.packet = pp;</span><br><span class="line">    p.request = request;</span><br><span class="line">    <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (LOG.isDebugEnabled()) &#123;</span><br><span class="line">            LOG.debug(<span class="string">"Proposing:: "</span> + request);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        lastProposed = p.packet.getZxid();</span><br><span class="line">        outstandingProposals.put(lastProposed, p);</span><br><span class="line">        sendPacket(pp);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> p;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="processAck-写请求“从服务器”响应"><a href="#processAck-写请求“从服务器”响应" class="headerlink" title="processAck() 写请求“从服务器”响应"></a>processAck() 写请求“从服务器”响应</h3><p>执行路径：</p>
<blockquote>
<p>LearnerHandler.run() -&gt; leader.processAck() -&gt; commitProcessor.commit(request)<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">synchronized</span> <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">processAck</span><span class="params">(<span class="keyword">long</span> sid, <span class="keyword">long</span> zxid, SocketAddress followerAddr)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (LOG.isTraceEnabled()) &#123;</span><br><span class="line">        LOG.trace(<span class="string">"Ack zxid: 0x&#123;&#125;"</span>, Long.toHexString(zxid));</span><br><span class="line">        <span class="keyword">for</span> (Proposal p : outstandingProposals.values()) &#123;</span><br><span class="line">            <span class="keyword">long</span> packetZxid = p.packet.getZxid();</span><br><span class="line">            LOG.trace(<span class="string">"outstanding proposal: 0x&#123;&#125;"</span>,</span><br><span class="line">                    Long.toHexString(packetZxid));</span><br><span class="line">        &#125;</span><br><span class="line">        LOG.trace(<span class="string">"outstanding proposals all"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ((zxid &amp; <span class="number">0xffffffffL</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">            * We no longer process NEWLEADER ack by this method. However,</span></span><br><span class="line"><span class="comment">            * the learner sends ack back to the leader after it gets UPTODATE</span></span><br><span class="line"><span class="comment">            * so we just ignore the message.</span></span><br><span class="line"><span class="comment">            */</span></span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (outstandingProposals.size() == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (LOG.isDebugEnabled()) &#123;</span><br><span class="line">            LOG.debug(<span class="string">"outstanding is 0"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (lastCommitted &gt;= zxid) &#123;</span><br><span class="line">        <span class="keyword">if</span> (LOG.isDebugEnabled()) &#123;</span><br><span class="line">            LOG.debug(<span class="string">"proposal has already been committed, pzxid: 0x&#123;&#125; zxid: 0x&#123;&#125;"</span>,</span><br><span class="line">                    Long.toHexString(lastCommitted), Long.toHexString(zxid));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// The proposal has already been committed</span></span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//根据zxid取出提案</span></span><br><span class="line">    Proposal p = outstandingProposals.get(zxid);</span><br><span class="line">    <span class="keyword">if</span> (p == <span class="keyword">null</span>) &#123;</span><br><span class="line">        LOG.warn(<span class="string">"Trying to commit future proposal: zxid 0x&#123;&#125; from &#123;&#125;"</span>,</span><br><span class="line">                Long.toHexString(zxid), followerAddr);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 这里加上sid代表该sid的Follower同意了该提案，根据sid的数量判断是否有过半服务器同意。</span></span><br><span class="line">    p.ackSet.add(sid);</span><br><span class="line">    <span class="keyword">if</span> (LOG.isDebugEnabled()) &#123;</span><br><span class="line">        LOG.debug(<span class="string">"Count for zxid: 0x&#123;&#125; is &#123;&#125;"</span>,</span><br><span class="line">                Long.toHexString(zxid), p.ackSet.size());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 过半的服务器同意后执行提案</span></span><br><span class="line">    <span class="keyword">if</span> (self.getQuorumVerifier().containsQuorum(p.ackSet))&#123;             </span><br><span class="line">        <span class="keyword">if</span> (zxid != lastCommitted+<span class="number">1</span>) &#123;</span><br><span class="line">            LOG.warn(<span class="string">"Commiting zxid 0x&#123;&#125; from &#123;&#125; not first!"</span>,</span><br><span class="line">                    Long.toHexString(zxid), followerAddr);</span><br><span class="line">            LOG.warn(<span class="string">"First is 0x&#123;&#125;"</span>, Long.toHexString(lastCommitted + <span class="number">1</span>));</span><br><span class="line">        &#125;</span><br><span class="line">        outstandingProposals.remove(zxid);</span><br><span class="line">        <span class="keyword">if</span> (p.request != <span class="keyword">null</span>) &#123;</span><br><span class="line">            toBeApplied.add(p);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (p.request == <span class="keyword">null</span>) &#123;</span><br><span class="line">            LOG.warn(<span class="string">"Going to commmit null request for proposal: &#123;&#125;"</span>, p);</span><br><span class="line">        &#125;</span><br><span class="line">        commit(zxid);</span><br><span class="line">        inform(p);</span><br><span class="line">        zk.commitProcessor.commit(p.request);</span><br><span class="line">        <span class="keyword">if</span>(pendingSyncs.containsKey(zxid))&#123;</span><br><span class="line">            <span class="keyword">for</span>(LearnerSyncRequest r: pendingSyncs.remove(zxid)) &#123;</span><br><span class="line">                sendSync(r);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
</blockquote>
<h3 id="lead-方法"><a href="#lead-方法" class="headerlink" title="lead()方法"></a>lead()方法</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">lead</span><span class="params">()</span> <span class="keyword">throws</span> IOException, InterruptedException </span>&#123;</span><br><span class="line">    <span class="comment">// 计算选主耗时</span></span><br><span class="line">    self.end_fle = Time.currentElapsedTime();</span><br><span class="line">    <span class="keyword">long</span> electionTimeTaken = self.end_fle - self.start_fle;</span><br><span class="line">    self.setElectionTimeTaken(electionTimeTaken);</span><br><span class="line">    LOG.info(<span class="string">"LEADING - LEADER ELECTION TOOK - &#123;&#125;"</span>, electionTimeTaken);</span><br><span class="line">    self.start_fle = <span class="number">0</span>;</span><br><span class="line">    self.end_fle = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    zk.registerJMX(<span class="keyword">new</span> LeaderBean(<span class="keyword">this</span>, zk), self.jmxLocalPeerBean);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        self.tick.set(<span class="number">0</span>);</span><br><span class="line">        <span class="comment">// 加载硬盘中的数据</span></span><br><span class="line">        zk.loadData();</span><br><span class="line">        <span class="comment">// 上个时代和最后一次接受的提案zxid</span></span><br><span class="line">        leaderStateSummary = <span class="keyword">new</span> StateSummary(self.getCurrentEpoch(), zk.getLastProcessedZxid());</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Start thread that waits for connection requests from </span></span><br><span class="line">        <span class="comment">// new followers.</span></span><br><span class="line">        cnxAcceptor = <span class="keyword">new</span> LearnerCnxAcceptor();</span><br><span class="line">        <span class="comment">// leader在构造器中启动了ServerSocket，这里开启一个线程负责处理连接，详见LearnerCnxAcceptor解析小节</span></span><br><span class="line">        cnxAcceptor.start();</span><br><span class="line">        </span><br><span class="line">        readyToStart = <span class="keyword">true</span>;</span><br><span class="line">        <span class="comment">// 生成新的时代（计数值，每选一次主节点加一），详见生成新时代小节</span></span><br><span class="line">        <span class="keyword">long</span> epoch = getEpochToPropose(self.getId(), self.getAcceptedEpoch());</span><br><span class="line">        <span class="comment">// 生成zxid，(epoch &lt;&lt; 32L) | (counter &amp; 0xffffffffL);</span></span><br><span class="line">        <span class="comment">// zxid 高32位是时代，低32位是计数值，初始值是0</span></span><br><span class="line">        zk.setZxid(ZxidUtils.makeZxid(epoch, <span class="number">0</span>));</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">synchronized</span>(<span class="keyword">this</span>)&#123;</span><br><span class="line">            lastProposed = zk.getZxid();</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        newLeaderProposal.packet = <span class="keyword">new</span> QuorumPacket(NEWLEADER, zk.getZxid(),</span><br><span class="line">                <span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> ((newLeaderProposal.packet.getZxid() &amp; <span class="number">0xffffffffL</span>) != <span class="number">0</span>) &#123;</span><br><span class="line">            LOG.info(<span class="string">"NEWLEADER proposal has Zxid of "</span></span><br><span class="line">                    + Long.toHexString(newLeaderProposal.packet.getZxid()));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 等待过半的服务器响应</span></span><br><span class="line">        waitForEpochAck(self.getId(), leaderStateSummary);</span><br><span class="line">        self.setCurrentEpoch(epoch);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// We have to get at least a majority of servers in sync with</span></span><br><span class="line">        <span class="comment">// us. We do this by waiting for the NEWLEADER packet to get</span></span><br><span class="line">        <span class="comment">// acknowledged</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 等待过半服务器事务同步完成</span></span><br><span class="line">            waitForNewLeaderAck(self.getId(), zk.getZxid());</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            shutdown(<span class="string">"Waiting for a quorum of followers, only synced with sids: [ "</span></span><br><span class="line">                    + getSidSetString(newLeaderProposal.ackSet) + <span class="string">" ]"</span>);</span><br><span class="line">            HashSet&lt;Long&gt; followerSet = <span class="keyword">new</span> HashSet&lt;Long&gt;();</span><br><span class="line">            <span class="keyword">for</span> (LearnerHandler f : learners)</span><br><span class="line">                followerSet.add(f.getSid());</span><br><span class="line">                </span><br><span class="line">            <span class="keyword">if</span> (self.getQuorumVerifier().containsQuorum(followerSet)) &#123;</span><br><span class="line">                LOG.warn(<span class="string">"Enough followers present. "</span></span><br><span class="line">                        + <span class="string">"Perhaps the initTicks need to be increased."</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            Thread.sleep(self.tickTime);</span><br><span class="line">            self.tick.incrementAndGet();</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 更新QuorumPeer中的时代信息（同时写到文件中）</span></span><br><span class="line">        <span class="comment">// 执行ZookeeperServer的startup()，详见ZookeeperServer解析篇</span></span><br><span class="line">        <span class="comment">// ZKDataase对象更新lastProcessedZxid</span></span><br><span class="line">        startZkServer();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">            * WARNING: do not use this for anything other than QA testing</span></span><br><span class="line"><span class="comment">            * on a real cluster. Specifically to enable verification that quorum</span></span><br><span class="line"><span class="comment">            * can handle the lower 32bit roll-over issue identified in</span></span><br><span class="line"><span class="comment">            * ZOOKEEPER-1277. Without this option it would take a very long</span></span><br><span class="line"><span class="comment">            * time (on order of a month say) to see the 4 billion writes</span></span><br><span class="line"><span class="comment">            * necessary to cause the roll-over to occur.</span></span><br><span class="line"><span class="comment">            * </span></span><br><span class="line"><span class="comment">            * This field allows you to override the zxid of the server. Typically</span></span><br><span class="line"><span class="comment">            * you'll want to set it to something like 0xfffffff0 and then</span></span><br><span class="line"><span class="comment">            * start the quorum, run some operations and see the re-election.</span></span><br><span class="line"><span class="comment">            */</span></span><br><span class="line">        String initialZxid = System.getProperty(<span class="string">"zookeeper.testingonly.initialZxid"</span>);</span><br><span class="line">        <span class="keyword">if</span> (initialZxid != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">long</span> zxid = Long.parseLong(initialZxid);</span><br><span class="line">            zk.setZxid((zk.getZxid() &amp; <span class="number">0xffffffff00000000L</span>) | zxid);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (!System.getProperty(<span class="string">"zookeeper.leaderServes"</span>, <span class="string">"yes"</span>).equals(<span class="string">"no"</span>)) &#123;</span><br><span class="line">            self.cnxnFactory.setZooKeeperServer(zk);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// Everything is a go, simply start counting the ticks</span></span><br><span class="line">        <span class="comment">// WARNING: I couldn't find any wait statement on a synchronized</span></span><br><span class="line">        <span class="comment">// block that would be notified by this notifyAll() call, so</span></span><br><span class="line">        <span class="comment">// I commented it out</span></span><br><span class="line">        <span class="comment">//synchronized (this) &#123;</span></span><br><span class="line">        <span class="comment">//    notifyAll();</span></span><br><span class="line">        <span class="comment">//&#125;</span></span><br><span class="line">        <span class="comment">// We ping twice a tick, so we only update the tick every other</span></span><br><span class="line">        <span class="comment">// iteration</span></span><br><span class="line">        <span class="keyword">boolean</span> tickSkip = <span class="keyword">true</span>; <span class="comment">// 标志位，用于记录1/2次self.tickTime时间</span></span><br><span class="line">        <span class="comment">// 一个self.tickTime时间内ping learner服务器两次</span></span><br><span class="line">        <span class="comment">// ping完两次后如果有过半服务器无响应则执行shutdown()停止主节点的工作</span></span><br><span class="line">        <span class="comment">// 实际允许从服务器跳过几个ping，这个由syncLimit控制</span></span><br><span class="line">        <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">            Thread.sleep(self.tickTime / <span class="number">2</span>);</span><br><span class="line">            <span class="keyword">if</span> (!tickSkip) &#123; <span class="comment">// 两次请求增加一个计数值</span></span><br><span class="line">                self.tick.incrementAndGet();</span><br><span class="line">            &#125;</span><br><span class="line">            HashSet&lt;Long&gt; syncedSet = <span class="keyword">new</span> HashSet&lt;Long&gt;();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// lock on the followers when we use it.</span></span><br><span class="line">            syncedSet.add(self.getId());</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> (LearnerHandler f : getLearners()) &#123;</span><br><span class="line">                <span class="comment">// Synced set is used to check we have a supporting quorum, so only</span></span><br><span class="line">                <span class="comment">// PARTICIPANT, not OBSERVER, learners should be used</span></span><br><span class="line">                <span class="keyword">if</span> (f.synced() &amp;&amp; f.getLearnerType() == LearnerType.PARTICIPANT) &#123;</span><br><span class="line">                    syncedSet.add(f.getSid());</span><br><span class="line">                &#125;</span><br><span class="line">                f.ping();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// check leader running status</span></span><br><span class="line">            <span class="keyword">if</span> (!<span class="keyword">this</span>.isRunning()) &#123;</span><br><span class="line">                shutdown(<span class="string">"Unexpected internal error"</span>);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (!tickSkip &amp;&amp; !self.getQuorumVerifier().containsQuorum(syncedSet)) &#123;</span><br><span class="line">            <span class="comment">//if (!tickSkip &amp;&amp; syncedCount &lt; self.quorumPeers.size() / 2) &#123;</span></span><br><span class="line">                <span class="comment">// Lost quorum, shutdown</span></span><br><span class="line">                shutdown(<span class="string">"Not sufficient followers synced, only synced with sids: [ "</span></span><br><span class="line">                        + getSidSetString(syncedSet) + <span class="string">" ]"</span>);</span><br><span class="line">                <span class="comment">// make sure the order is the same!</span></span><br><span class="line">                <span class="comment">// the leader goes to looking</span></span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125; </span><br><span class="line">            tickSkip = !tickSkip; <span class="comment">// 标志位变更</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        zk.unregisterJMX(<span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="生成新时代epoch"><a href="#生成新时代epoch" class="headerlink" title="生成新时代epoch"></a>生成新时代epoch</h4><p>每次选主之后都会生成新的epoch，代表产生新的主节点。</p>
<p>生成逻辑：</p>
<blockquote>
<p>epoch = lastAcceptedEpoch+1;</p>
</blockquote>
<p>connectingFollowers的值要结合LearnerCnxAcceptor类，LearnerCnxAcceptor负责监听连接请求。连接之后的处理是交给LearnerHandler类处理，<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">getEpochToPropose</span><span class="params">(<span class="keyword">long</span> sid, <span class="keyword">long</span> lastAcceptedEpoch)</span> <span class="keyword">throws</span> InterruptedException, IOException </span>&#123;</span><br><span class="line">    <span class="keyword">synchronized</span>(connectingFollowers) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!waitingForNewEpoch) &#123; <span class="comment">// 避免重复生成</span></span><br><span class="line">            <span class="keyword">return</span> epoch;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 接收的时代比当前服务器记录的时代大或相等，+1操作生成新的时代</span></span><br><span class="line">        <span class="keyword">if</span> (lastAcceptedEpoch &gt;= epoch) &#123;</span><br><span class="line">            epoch = lastAcceptedEpoch+<span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 验证当前节点是否在集群中</span></span><br><span class="line">        <span class="keyword">if</span> (isParticipant(sid)) &#123;</span><br><span class="line">            connectingFollowers.add(sid);</span><br><span class="line">        &#125;</span><br><span class="line">        QuorumVerifier verifier = self.getQuorumVerifier();</span><br><span class="line">        <span class="comment">// verifier.containsQuorum 验证集群中是否有过半服务器在线</span></span><br><span class="line">        <span class="keyword">if</span> (connectingFollowers.contains(self.getId()) &amp;&amp; </span><br><span class="line">                                        verifier.containsQuorum(connectingFollowers)) &#123;</span><br><span class="line">            <span class="comment">// 设置标志位代表新的时代已经生成，避免重复生成，并唤起其他等待线程。</span></span><br><span class="line">            waitingForNewEpoch = <span class="keyword">false</span>;</span><br><span class="line">            self.setAcceptedEpoch(epoch);</span><br><span class="line">            connectingFollowers.notifyAll();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">long</span> start = Time.currentElapsedTime();</span><br><span class="line">            <span class="keyword">long</span> cur = start;</span><br><span class="line">            <span class="keyword">long</span> end = start + self.getInitLimit()*self.getTickTime();</span><br><span class="line">            <span class="comment">// 等待集群中的服务器有过半上线，直到超时或其他线程生成新时代</span></span><br><span class="line">            <span class="keyword">while</span>(waitingForNewEpoch &amp;&amp; cur &lt; end) &#123;</span><br><span class="line">                connectingFollowers.wait(end - cur);</span><br><span class="line">                cur = Time.currentElapsedTime();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 超时，没有过半的服务器在线</span></span><br><span class="line">            <span class="keyword">if</span> (waitingForNewEpoch) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> InterruptedException(<span class="string">"Timeout while waiting for epoch from quorum"</span>);        </span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> epoch;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h4 id="生成zxid-ZxidUtils"><a href="#生成zxid-ZxidUtils" class="headerlink" title="生成zxid ZxidUtils"></a>生成zxid ZxidUtils</h4><p>makeZxid方法是生成Zxid的方法，在Leader.lead()中调用。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ZxidUtils</span> </span>&#123;</span><br><span class="line">	<span class="function"><span class="keyword">static</span> <span class="keyword">public</span> <span class="keyword">long</span> <span class="title">getEpochFromZxid</span><span class="params">(<span class="keyword">long</span> zxid)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> zxid &gt;&gt; <span class="number">32L</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">static</span> <span class="keyword">public</span> <span class="keyword">long</span> <span class="title">getCounterFromZxid</span><span class="params">(<span class="keyword">long</span> zxid)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> zxid &amp; <span class="number">0xffffffffL</span>;</span><br><span class="line">	&#125;</span><br><span class="line">    <span class="comment">// 高32位是时代，低32位是一个计数值，初始值为0</span></span><br><span class="line">	<span class="function"><span class="keyword">static</span> <span class="keyword">public</span> <span class="keyword">long</span> <span class="title">makeZxid</span><span class="params">(<span class="keyword">long</span> epoch, <span class="keyword">long</span> counter)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> (epoch &lt;&lt; <span class="number">32L</span>) | (counter &amp; <span class="number">0xffffffffL</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">static</span> <span class="keyword">public</span> String <span class="title">zxidToString</span><span class="params">(<span class="keyword">long</span> zxid)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> Long.toHexString(zxid);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h4 id="等待过半节点接收新时代信息后响应waitForEpochAck"><a href="#等待过半节点接收新时代信息后响应waitForEpochAck" class="headerlink" title="等待过半节点接收新时代信息后响应waitForEpochAck"></a>等待过半节点接收新时代信息后响应waitForEpochAck</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">waitForEpochAck</span><span class="params">(<span class="keyword">long</span> id, StateSummary ss)</span> <span class="keyword">throws</span> IOException, InterruptedException </span>&#123;</span><br><span class="line">    <span class="keyword">synchronized</span>(electingFollowers) &#123;</span><br><span class="line">        <span class="keyword">if</span> (electionFinished) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (ss.getCurrentEpoch() != -<span class="number">1</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (ss.isMoreRecentThan(leaderStateSummary)) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> IOException(<span class="string">"Follower is ahead of the leader, leader summary: "</span> </span><br><span class="line">                                                + leaderStateSummary.getCurrentEpoch()</span><br><span class="line">                                                + <span class="string">" (current epoch), "</span></span><br><span class="line">                                                + leaderStateSummary.getLastZxid()</span><br><span class="line">                                                + <span class="string">" (last zxid)"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (isParticipant(id)) &#123;</span><br><span class="line">                electingFollowers.add(id);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        QuorumVerifier verifier = self.getQuorumVerifier();</span><br><span class="line">        <span class="keyword">if</span> (electingFollowers.contains(self.getId()) &amp;&amp; verifier.containsQuorum(electingFollowers)) &#123;</span><br><span class="line">            electionFinished = <span class="keyword">true</span>;</span><br><span class="line">            electingFollowers.notifyAll();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;                </span><br><span class="line">            <span class="keyword">long</span> start = Time.currentElapsedTime();</span><br><span class="line">            <span class="keyword">long</span> cur = start;</span><br><span class="line">            <span class="keyword">long</span> end = start + self.getInitLimit()*self.getTickTime();</span><br><span class="line">            <span class="keyword">while</span>(!electionFinished &amp;&amp; cur &lt; end) &#123;</span><br><span class="line">                electingFollowers.wait(end - cur);</span><br><span class="line">                cur = Time.currentElapsedTime();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (!electionFinished) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> InterruptedException(<span class="string">"Timeout while waiting for epoch to be acked by quorum"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="启动主节点事务处理startZkServer"><a href="#启动主节点事务处理startZkServer" class="headerlink" title="启动主节点事务处理startZkServer()"></a>启动主节点事务处理startZkServer()</h4><p>zk.startup(); 启动主节点对写事务的处理。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">startZkServer</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// Update lastCommitted and Db's zxid to a value representing the new epoch</span></span><br><span class="line">    lastCommitted = zk.getZxid();</span><br><span class="line">    LOG.info(<span class="string">"Have quorum of supporters, sids: [ "</span></span><br><span class="line">            + getSidSetString(newLeaderProposal.ackSet)</span><br><span class="line">            + <span class="string">" ]; starting up and setting last processed zxid: 0x&#123;&#125;"</span>,</span><br><span class="line">            Long.toHexString(zk.getZxid()));</span><br><span class="line">    zk.startup();</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">        * Update the election vote here to ensure that all members of the</span></span><br><span class="line"><span class="comment">        * ensemble report the same vote to new servers that start up and</span></span><br><span class="line"><span class="comment">        * send leader election notifications to the ensemble.</span></span><br><span class="line"><span class="comment">        * </span></span><br><span class="line"><span class="comment">        * @see https://issues.apache.org/jira/browse/ZOOKEEPER-1732</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">    self.updateElectionVote(getEpoch());</span><br><span class="line"></span><br><span class="line">    zk.getZKDatabase().setlastProcessedZxid(zk.getZxid());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="leader状态通信-LearnerCnxAcceptor"><a href="#leader状态通信-LearnerCnxAcceptor" class="headerlink" title="leader状态通信 LearnerCnxAcceptor"></a>leader状态通信 LearnerCnxAcceptor</h2><h3 id="启动"><a href="#启动" class="headerlink" title="启动"></a>启动</h3><p>LearnerCnxAcceptor的启动是在Leader类的lead()方法中。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">lead</span><span class="params">()</span> <span class="keyword">throws</span> IOException, InterruptedException </span>&#123;</span><br><span class="line">    <span class="comment">// ...省略</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">            self.tick.set(<span class="number">0</span>);</span><br><span class="line">            <span class="comment">// 加载硬盘中的数据</span></span><br><span class="line">            zk.loadData();</span><br><span class="line">            </span><br><span class="line">            leaderStateSummary = <span class="keyword">new</span> StateSummary(self.getCurrentEpoch(), zk.getLastProcessedZxid());</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Start thread that waits for connection requests from </span></span><br><span class="line">            <span class="comment">// new followers.</span></span><br><span class="line">            cnxAcceptor = <span class="keyword">new</span> LearnerCnxAcceptor();</span><br><span class="line">            <span class="comment">// leader在构造器中启动了ServerSocket，这里开启一个线程负责处理连接，详见LearnerCnxAcceptor解析小节</span></span><br><span class="line">            cnxAcceptor.start();</span><br><span class="line">    <span class="comment">// ...省略</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="LearnerCnxAcceptor解析"><a href="#LearnerCnxAcceptor解析" class="headerlink" title="LearnerCnxAcceptor解析"></a>LearnerCnxAcceptor解析</h3><p>LearnerCnxAcceptor类的内容非常少就是ss.accept()接收连接，并将连接(socket)交给LearnerHandler在单独的线程中处理。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LearnerCnxAcceptor</span> <span class="keyword">extends</span> <span class="title">ZooKeeperThread</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">boolean</span> stop = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">LearnerCnxAcceptor</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(<span class="string">"LearnerCnxAcceptor-"</span> + ss.getLocalSocketAddress());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">while</span> (!stop) &#123;</span><br><span class="line">                <span class="keyword">try</span>&#123;</span><br><span class="line">                    <span class="comment">// 获取连接的socket</span></span><br><span class="line">                    <span class="comment">// ss是Leader类的属性，LearnerCnxAcceptor是Leader的内部类，所以可以直接使用</span></span><br><span class="line">                    Socket s = ss.accept();</span><br><span class="line">                    <span class="comment">// start with the initLimit, once the ack is processed</span></span><br><span class="line">                    <span class="comment">// in LearnerHandler switch to the syncLimit</span></span><br><span class="line">                    s.setSoTimeout(self.tickTime * self.initLimit);</span><br><span class="line">                    s.setTcpNoDelay(nodelay);</span><br><span class="line"></span><br><span class="line">                    BufferedInputStream is = <span class="keyword">new</span> BufferedInputStream(</span><br><span class="line">                            s.getInputStream());</span><br><span class="line">                    <span class="comment">// 这里将socket的读写交给LearnerHandler在单独的线程处理</span></span><br><span class="line">                    LearnerHandler fh = <span class="keyword">new</span> LearnerHandler(s, is, Leader.<span class="keyword">this</span>);</span><br><span class="line">                    fh.start();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (SocketException e) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (stop) &#123;</span><br><span class="line">                        LOG.info(<span class="string">"exception while shutting down acceptor: "</span></span><br><span class="line">                                + e);</span><br><span class="line"></span><br><span class="line">                        <span class="comment">// When Leader.shutdown() calls ss.close(),</span></span><br><span class="line">                        <span class="comment">// the call to accept throws an exception.</span></span><br><span class="line">                        <span class="comment">// We catch and set stop to true.</span></span><br><span class="line">                        stop = <span class="keyword">true</span>;</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        <span class="keyword">throw</span> e;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">catch</span> (SaslException e)&#123;</span><br><span class="line">                    LOG.error(<span class="string">"Exception while connecting to quorum learner"</span>, e);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            LOG.warn(<span class="string">"Exception while accepting follower"</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">halt</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        stop = <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="socket处理-LearnerHandler"><a href="#socket处理-LearnerHandler" class="headerlink" title="socket处理 LearnerHandler"></a>socket处理 LearnerHandler</h3><p><strong>LearnerHandler</strong><br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LearnerHandler</span> <span class="keyword">extends</span> <span class="title">ZooKeeperThread</span> </span>&#123;&#125;</span><br></pre></td></tr></table></figure></p>
<h5 id="构造器-1"><a href="#构造器-1" class="headerlink" title="构造器"></a>构造器</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">LearnerHandler(Socket sock, BufferedInputStream bufferedInput,</span><br><span class="line">                Leader leader) <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="keyword">super</span>(<span class="string">"LearnerHandler-"</span> + sock.getRemoteSocketAddress());</span><br><span class="line">    <span class="keyword">this</span>.sock = sock;</span><br><span class="line">    <span class="keyword">this</span>.leader = leader;</span><br><span class="line">    <span class="keyword">this</span>.bufferedInput = bufferedInput;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        leader.self.authServer.authenticate(sock,</span><br><span class="line">                <span class="keyword">new</span> DataInputStream(bufferedInput));</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">        LOG.error(<span class="string">"Server failed to authenticate quorum learner, addr: &#123;&#125;, closing connection"</span>,</span><br><span class="line">                sock.getRemoteSocketAddress(), e);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            sock.close();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException ie) &#123;</span><br><span class="line">            LOG.error(<span class="string">"Exception while closing socket"</span>, ie);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> SaslException(<span class="string">"Authentication failure: "</span> + e.getMessage());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="发送包sendPackets"><a href="#发送包sendPackets" class="headerlink" title="发送包sendPackets()"></a>发送包sendPackets()</h5><p>从队里中取出QuorumPacket，然后发送<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">sendPackets</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">    <span class="keyword">long</span> traceMask = ZooTrace.SERVER_PACKET_TRACE_MASK;</span><br><span class="line">    <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            QuorumPacket p;</span><br><span class="line">            p = queuedPackets.poll();</span><br><span class="line">            <span class="keyword">if</span> (p == <span class="keyword">null</span>) &#123;</span><br><span class="line">                bufferedOutput.flush();</span><br><span class="line">                p = queuedPackets.take();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (p == proposalOfDeath) &#123;</span><br><span class="line">                <span class="comment">// Packet of death!</span></span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (p.getType() == Leader.PING) &#123;</span><br><span class="line">                traceMask = ZooTrace.SERVER_PING_TRACE_MASK;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (p.getType() == Leader.PROPOSAL) &#123;</span><br><span class="line">                syncLimitCheck.updateProposal(p.getZxid(), System.nanoTime());</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (LOG.isTraceEnabled()) &#123;</span><br><span class="line">                ZooTrace.logQuorumPacket(LOG, traceMask, <span class="string">'o'</span>, p);</span><br><span class="line">            &#125;</span><br><span class="line">            oa.writeRecord(p, <span class="string">"packet"</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!sock.isClosed()) &#123;</span><br><span class="line">                LOG.warn(<span class="string">"Unexpected exception at "</span> + <span class="keyword">this</span>, e);</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="comment">// this will cause everything to shutdown on</span></span><br><span class="line">                    <span class="comment">// this learner handler and will help notify</span></span><br><span class="line">                    <span class="comment">// the learner/observer instantaneously</span></span><br><span class="line">                    sock.close();</span><br><span class="line">                &#125; <span class="keyword">catch</span>(IOException ie) &#123;</span><br><span class="line">                    LOG.warn(<span class="string">"Error closing socket for handler "</span> + <span class="keyword">this</span>, ie);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h5 id="run-方法"><a href="#run-方法" class="headerlink" title="run()方法"></a>run()方法</h5><p>run()方法负责处理请求<br><strong>简化流程图</strong><br><img src="https://imgchr.com/i/kEKVG6" alt="Leader主从通信"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br></pre></td><td class="code"><pre><span class="line"> <span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        leader.addLearnerHandler(<span class="keyword">this</span>);</span><br><span class="line">        tickOfNextAckDeadline = leader.self.tick.get()</span><br><span class="line">                + leader.self.initLimit + leader.self.syncLimit;</span><br><span class="line">        <span class="comment">// 输入流和输出流</span></span><br><span class="line">        ia = BinaryInputArchive.getArchive(bufferedInput);</span><br><span class="line">        bufferedOutput = <span class="keyword">new</span> BufferedOutputStream(sock.getOutputStream());</span><br><span class="line">        oa = BinaryOutputArchive.getArchive(bufferedOutput);</span><br><span class="line"></span><br><span class="line">        QuorumPacket qp = <span class="keyword">new</span> QuorumPacket();</span><br><span class="line">        <span class="comment">// 读取数据</span></span><br><span class="line">        ia.readRecord(qp, <span class="string">"packet"</span>);</span><br><span class="line">        <span class="comment">// 状态不对</span></span><br><span class="line">        <span class="keyword">if</span>(qp.getType() != Leader.FOLLOWERINFO &amp;&amp; qp.getType() != Leader.OBSERVERINFO)&#123;</span><br><span class="line">            LOG.error(<span class="string">"First packet "</span> + qp.toString()</span><br><span class="line">                    + <span class="string">" is not FOLLOWERINFO or OBSERVERINFO!"</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">byte</span> learnerInfoData[] = qp.getData();</span><br><span class="line">        <span class="keyword">if</span> (learnerInfoData != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (learnerInfoData.length == <span class="number">8</span>) &#123;</span><br><span class="line">                ByteBuffer bbsid = ByteBuffer.wrap(learnerInfoData);</span><br><span class="line">                <span class="keyword">this</span>.sid = bbsid.getLong();</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                LearnerInfo li = <span class="keyword">new</span> LearnerInfo();</span><br><span class="line">                ByteBufferInputStream.byteBuffer2Record(ByteBuffer.wrap(learnerInfoData), li);</span><br><span class="line">                <span class="keyword">this</span>.sid = li.getServerid();</span><br><span class="line">                <span class="keyword">this</span>.version = li.getProtocolVersion();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">this</span>.sid = leader.followerCounter.getAndDecrement();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        LOG.info(<span class="string">"Follower sid: "</span> + sid + <span class="string">" : info : "</span></span><br><span class="line">                + leader.self.quorumPeers.get(sid));</span><br><span class="line">                    </span><br><span class="line">        <span class="keyword">if</span> (qp.getType() == Leader.OBSERVERINFO) &#123;</span><br><span class="line">                learnerType = LearnerType.OBSERVER;</span><br><span class="line">        &#125;            </span><br><span class="line">        </span><br><span class="line">        <span class="keyword">long</span> lastAcceptedEpoch = ZxidUtils.getEpochFromZxid(qp.getZxid());</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">long</span> peerLastZxid;</span><br><span class="line">        StateSummary ss = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">long</span> zxid = qp.getZxid();</span><br><span class="line">        <span class="comment">// 获取新时代，新时代生成必须有过半节点连接</span></span><br><span class="line">        <span class="keyword">long</span> newEpoch = leader.getEpochToPropose(<span class="keyword">this</span>.getSid(), lastAcceptedEpoch);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.getVersion() &lt; <span class="number">0x10000</span>) &#123;</span><br><span class="line">            <span class="comment">// we are going to have to extrapolate the epoch information</span></span><br><span class="line">            <span class="keyword">long</span> epoch = ZxidUtils.getEpochFromZxid(zxid);</span><br><span class="line">            ss = <span class="keyword">new</span> StateSummary(epoch, zxid);</span><br><span class="line">            <span class="comment">// 等待过半节点接收新时代信息后响应</span></span><br><span class="line">            leader.waitForEpochAck(<span class="keyword">this</span>.getSid(), ss);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">byte</span> ver[] = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">4</span>];</span><br><span class="line">            ByteBuffer.wrap(ver).putInt(<span class="number">0x10000</span>);</span><br><span class="line">            QuorumPacket newEpochPacket = <span class="keyword">new</span> QuorumPacket(Leader.LEADERINFO, ZxidUtils.makeZxid(newEpoch, <span class="number">0</span>), ver, <span class="keyword">null</span>);</span><br><span class="line">            <span class="comment">// 响应主节信息</span></span><br><span class="line">            oa.writeRecord(newEpochPacket, <span class="string">"packet"</span>);</span><br><span class="line">            bufferedOutput.flush();</span><br><span class="line">            QuorumPacket ackEpochPacket = <span class="keyword">new</span> QuorumPacket();</span><br><span class="line">            <span class="comment">// 读取响应</span></span><br><span class="line">            ia.readRecord(ackEpochPacket, <span class="string">"packet"</span>);</span><br><span class="line">            <span class="keyword">if</span> (ackEpochPacket.getType() != Leader.ACKEPOCH) &#123;</span><br><span class="line">                LOG.error(ackEpochPacket.toString()</span><br><span class="line">                        + <span class="string">" is not ACKEPOCH"</span>);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            ByteBuffer bbepoch = ByteBuffer.wrap(ackEpochPacket.getData());</span><br><span class="line">            ss = <span class="keyword">new</span> StateSummary(bbepoch.getInt(), ackEpochPacket.getZxid());</span><br><span class="line">            <span class="comment">// 等待过半节点接收新时代信息后响应</span></span><br><span class="line">            leader.waitForEpochAck(<span class="keyword">this</span>.getSid(), ss);</span><br><span class="line">        &#125;</span><br><span class="line">        peerLastZxid = ss.getLastZxid();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">/* the default to send to the follower */</span></span><br><span class="line">        <span class="keyword">int</span> packetToSend = Leader.SNAP; <span class="comment">// SNAP默认是发送快照</span></span><br><span class="line">        <span class="keyword">long</span> zxidToSend = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">long</span> leaderLastZxid = <span class="number">0</span>;</span><br><span class="line">        <span class="comment">/** the packets that the follower needs to get updates from **/</span></span><br><span class="line">        <span class="keyword">long</span> updates = peerLastZxid;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">/* we are sending the diff check if we have proposals in memory to be able to </span></span><br><span class="line"><span class="comment">            * send a diff to the </span></span><br><span class="line"><span class="comment">            */</span> </span><br><span class="line">        ReentrantReadWriteLock lock = leader.zk.getZKDatabase().getLogLock();</span><br><span class="line">        ReadLock rl = lock.readLock();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            rl.lock();        </span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">long</span> maxCommittedLog = leader.zk.getZKDatabase().getmaxCommittedLog();</span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">long</span> minCommittedLog = leader.zk.getZKDatabase().getminCommittedLog();</span><br><span class="line">            LOG.info(<span class="string">"Synchronizing with Follower sid: "</span> + sid</span><br><span class="line">                    +<span class="string">" maxCommittedLog=0x"</span>+Long.toHexString(maxCommittedLog)</span><br><span class="line">                    +<span class="string">" minCommittedLog=0x"</span>+Long.toHexString(minCommittedLog)</span><br><span class="line">                    +<span class="string">" peerLastZxid=0x"</span>+Long.toHexString(peerLastZxid));</span><br><span class="line">            <span class="comment">// 获取已经接受的提案</span></span><br><span class="line">            LinkedList&lt;Proposal&gt; proposals = leader.zk.getZKDatabase().getCommittedLog();</span><br><span class="line">            <span class="comment">// 已经和主节点的数据一致了</span></span><br><span class="line">            <span class="keyword">if</span> (peerLastZxid == leader.zk.getZKDatabase().getDataTreeLastProcessedZxid()) &#123;</span><br><span class="line">                <span class="comment">// Follower is already sync with us, send empty diff</span></span><br><span class="line">                LOG.info(<span class="string">"leader and follower are in sync, zxid=0x&#123;&#125;"</span>,</span><br><span class="line">                        Long.toHexString(peerLastZxid));</span><br><span class="line">                packetToSend = Leader.DIFF;</span><br><span class="line">                zxidToSend = peerLastZxid;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (proposals.size() != <span class="number">0</span>) &#123;</span><br><span class="line">                LOG.debug(<span class="string">"proposal size is &#123;&#125;"</span>, proposals.size());</span><br><span class="line">                <span class="comment">// 主节点的事务比较大，其他节点要同步主节点的数据</span></span><br><span class="line">                <span class="comment">// 而且要大于最小事务，不然只能快照同步</span></span><br><span class="line">                <span class="keyword">if</span> ((maxCommittedLog &gt;= peerLastZxid)</span><br><span class="line">                        &amp;&amp; (minCommittedLog &lt;= peerLastZxid)) &#123;</span><br><span class="line">                    LOG.debug(<span class="string">"Sending proposals to follower"</span>);</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// as we look through proposals, this variable keeps track of previous</span></span><br><span class="line">                    <span class="comment">// proposal Id.</span></span><br><span class="line">                    <span class="keyword">long</span> prevProposalZxid = minCommittedLog;</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// Keep track of whether we are about to send the first packet.</span></span><br><span class="line">                    <span class="comment">// Before sending the first packet, we have to tell the learner</span></span><br><span class="line">                    <span class="comment">// whether to expect a trunc or a diff</span></span><br><span class="line">                    <span class="keyword">boolean</span> firstPacket=<span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// If we are here, we can use committedLog to sync with</span></span><br><span class="line">                    <span class="comment">// follower. Then we only need to decide whether to</span></span><br><span class="line">                    <span class="comment">// send trunc or not</span></span><br><span class="line">                    packetToSend = Leader.DIFF;</span><br><span class="line">                    zxidToSend = maxCommittedLog;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">for</span> (Proposal propose: proposals) &#123;</span><br><span class="line">                        <span class="comment">// skip the proposals the peer already has</span></span><br><span class="line">                        <span class="comment">// 跳过已经接受的事务</span></span><br><span class="line">                        <span class="keyword">if</span> (propose.packet.getZxid() &lt;= peerLastZxid) &#123;</span><br><span class="line">                            prevProposalZxid = propose.packet.getZxid();</span><br><span class="line">                            <span class="keyword">continue</span>;</span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                            <span class="comment">// If we are sending the first packet, figure out whether to trunc</span></span><br><span class="line">                            <span class="comment">// in case the follower has some proposals that the leader doesn't</span></span><br><span class="line">                            <span class="keyword">if</span> (firstPacket) &#123;</span><br><span class="line">                                firstPacket = <span class="keyword">false</span>;</span><br><span class="line">                                <span class="comment">// Does the peer have some proposals that the leader hasn't seen yet</span></span><br><span class="line">                                <span class="keyword">if</span> (prevProposalZxid &lt; peerLastZxid) &#123;</span><br><span class="line">                                    <span class="comment">// send a trunc message before sending the diff</span></span><br><span class="line">                                    packetToSend = Leader.TRUNC;                                        </span><br><span class="line">                                    zxidToSend = prevProposalZxid;</span><br><span class="line">                                    updates = zxidToSend;</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;</span><br><span class="line">                            queuePacket(propose.packet);</span><br><span class="line">                            QuorumPacket qcommit = <span class="keyword">new</span> QuorumPacket(Leader.COMMIT, propose.packet.getZxid(),</span><br><span class="line">                                    <span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line">                            queuePacket(qcommit);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (peerLastZxid &gt; maxCommittedLog) &#123; <span class="comment">// 其他服务器比主节点的事务高</span></span><br><span class="line">                    LOG.debug(<span class="string">"Sending TRUNC to follower zxidToSend=0x&#123;&#125; updates=0x&#123;&#125;"</span>,</span><br><span class="line">                            Long.toHexString(maxCommittedLog),</span><br><span class="line">                            Long.toHexString(updates));</span><br><span class="line"></span><br><span class="line">                    packetToSend = Leader.TRUNC;</span><br><span class="line">                    zxidToSend = maxCommittedLog;</span><br><span class="line">                    updates = zxidToSend;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    LOG.warn(<span class="string">"Unhandled proposal scenario"</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// just let the state transfer happen</span></span><br><span class="line">                LOG.debug(<span class="string">"proposals is empty"</span>);</span><br><span class="line">            &#125;               </span><br><span class="line"></span><br><span class="line">            LOG.info(<span class="string">"Sending "</span> + Leader.getPacketType(packetToSend));</span><br><span class="line">            leaderLastZxid = leader.startForwarding(<span class="keyword">this</span>, updates);</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            rl.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 同步数据完毕</span></span><br><span class="line">        QuorumPacket newLeaderQP = <span class="keyword">new</span> QuorumPacket(Leader.NEWLEADER,</span><br><span class="line">            ZxidUtils.makeZxid(newEpoch, <span class="number">0</span>), <span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line">        <span class="keyword">if</span> (getVersion() &lt; <span class="number">0x10000</span>) &#123;</span><br><span class="line">                oa.writeRecord(newLeaderQP, <span class="string">"packet"</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            queuedPackets.add(newLeaderQP);</span><br><span class="line">        &#125;</span><br><span class="line">        bufferedOutput.flush();</span><br><span class="line">        <span class="comment">//Need to set the zxidToSend to the latest zxid</span></span><br><span class="line">        <span class="keyword">if</span> (packetToSend == Leader.SNAP) &#123;</span><br><span class="line">            zxidToSend = leader.zk.getZKDatabase().getDataTreeLastProcessedZxid();</span><br><span class="line">        &#125;</span><br><span class="line">        oa.writeRecord(<span class="keyword">new</span> QuorumPacket(packetToSend, zxidToSend, <span class="keyword">null</span>, <span class="keyword">null</span>), <span class="string">"packet"</span>);</span><br><span class="line">        bufferedOutput.flush();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">/* if we are not truncating or sending a diff just send a snapshot */</span></span><br><span class="line">        <span class="comment">// 发送快照</span></span><br><span class="line">        <span class="keyword">if</span> (packetToSend == Leader.SNAP) &#123;</span><br><span class="line">            LOG.info(<span class="string">"Sending snapshot last zxid of peer is 0x"</span></span><br><span class="line">                    + Long.toHexString(peerLastZxid) + <span class="string">" "</span> </span><br><span class="line">                    + <span class="string">" zxid of leader is 0x"</span></span><br><span class="line">                    + Long.toHexString(leaderLastZxid)</span><br><span class="line">                    + <span class="string">"sent zxid of db as 0x"</span> </span><br><span class="line">                    + Long.toHexString(zxidToSend));</span><br><span class="line">            <span class="comment">// Dump data to peer</span></span><br><span class="line">            leader.zk.getZKDatabase().serializeSnapshot(oa);</span><br><span class="line">            oa.writeString(<span class="string">"BenWasHere"</span>, <span class="string">"signature"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        bufferedOutput.flush();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Start sending packets</span></span><br><span class="line">        <span class="comment">// 开启线程发送</span></span><br><span class="line">        <span class="keyword">new</span> Thread() &#123;</span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                Thread.currentThread().setName(</span><br><span class="line">                        <span class="string">"Sender-"</span> + sock.getRemoteSocketAddress());</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    sendPackets();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    LOG.warn(<span class="string">"Unexpected interruption"</span>,e);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;.start();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">            * Have to wait for the first ACK, wait until </span></span><br><span class="line"><span class="comment">            * the leader is ready, and only then we can</span></span><br><span class="line"><span class="comment">            * start processing messages.</span></span><br><span class="line"><span class="comment">            */</span></span><br><span class="line">        qp = <span class="keyword">new</span> QuorumPacket();</span><br><span class="line">        <span class="comment">// 等待响应</span></span><br><span class="line">        ia.readRecord(qp, <span class="string">"packet"</span>);</span><br><span class="line">        <span class="keyword">if</span>(qp.getType() != Leader.ACK)&#123;</span><br><span class="line">            LOG.error(<span class="string">"Next packet was supposed to be an ACK"</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        LOG.info(<span class="string">"Received NEWLEADER-ACK message from "</span> + getSid());</span><br><span class="line">        <span class="comment">// 等待半数回应</span></span><br><span class="line">        leader.waitForNewLeaderAck(getSid(), qp.getZxid());</span><br><span class="line"></span><br><span class="line">        syncLimitCheck.start();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// now that the ack has been processed expect the syncLimit</span></span><br><span class="line">        sock.setSoTimeout(leader.self.tickTime * leader.self.syncLimit);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">            * Wait until leader starts up</span></span><br><span class="line"><span class="comment">            */</span></span><br><span class="line">        <span class="keyword">synchronized</span>(leader.zk)&#123;</span><br><span class="line">            <span class="keyword">while</span>(!leader.zk.isRunning() &amp;&amp; !<span class="keyword">this</span>.isInterrupted())&#123;</span><br><span class="line">                leader.zk.wait(<span class="number">20</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// Mutation packets will be queued during the serialize,</span></span><br><span class="line">        <span class="comment">// so we need to mark when the peer can actually start</span></span><br><span class="line">        <span class="comment">// using the data</span></span><br><span class="line">        <span class="comment">// 标记什么时候可以开始使用数据</span></span><br><span class="line">        queuedPackets.add(<span class="keyword">new</span> QuorumPacket(Leader.UPTODATE, -<span class="number">1</span>, <span class="keyword">null</span>, <span class="keyword">null</span>));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">            qp = <span class="keyword">new</span> QuorumPacket();</span><br><span class="line">            ia.readRecord(qp, <span class="string">"packet"</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">long</span> traceMask = ZooTrace.SERVER_PACKET_TRACE_MASK;</span><br><span class="line">            <span class="keyword">if</span> (qp.getType() == Leader.PING) &#123;</span><br><span class="line">                traceMask = ZooTrace.SERVER_PING_TRACE_MASK;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (LOG.isTraceEnabled()) &#123;</span><br><span class="line">                ZooTrace.logQuorumPacket(LOG, traceMask, <span class="string">'i'</span>, qp);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// tick: 代表当前leader第几次ping服务器，变化在Leader.lead()</span></span><br><span class="line">            <span class="comment">// syncLimit: 允许从服务器丢失几次ping，在zoo.cfg中配置</span></span><br><span class="line">            <span class="comment">// 两者相加代表从服务器失去连接的最大计数值，校验在 org.apache.zookeeper.server.quorum.LearnerHandler#synced()</span></span><br><span class="line">            tickOfNextAckDeadline = leader.self.tick.get() + leader.self.syncLimit;</span><br><span class="line"></span><br><span class="line">            ByteBuffer bb;</span><br><span class="line">            <span class="keyword">long</span> sessionId;</span><br><span class="line">            <span class="keyword">int</span> cxid;</span><br><span class="line">            <span class="keyword">int</span> type;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">switch</span> (qp.getType()) &#123;</span><br><span class="line">            <span class="keyword">case</span> Leader.ACK:  <span class="comment">// 响应某个提案</span></span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">this</span>.learnerType == LearnerType.OBSERVER) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (LOG.isDebugEnabled()) &#123;</span><br><span class="line">                        LOG.debug(<span class="string">"Received ACK from Observer  "</span> + <span class="keyword">this</span>.sid);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                syncLimitCheck.updateAck(qp.getZxid());</span><br><span class="line">                <span class="comment">// 处理响应，如果有过半服务器都响应了这个提案就执行这个提案</span></span><br><span class="line">                leader.processAck(<span class="keyword">this</span>.sid, qp.getZxid(), sock.getLocalSocketAddress());</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> Leader.PING: <span class="comment">// 保持连接，维持session</span></span><br><span class="line">                <span class="comment">// Process the touches</span></span><br><span class="line">                ByteArrayInputStream bis = <span class="keyword">new</span> ByteArrayInputStream(qp</span><br><span class="line">                        .getData());</span><br><span class="line">                DataInputStream dis = <span class="keyword">new</span> DataInputStream(bis);</span><br><span class="line">                <span class="keyword">while</span> (dis.available() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="keyword">long</span> sess = dis.readLong();</span><br><span class="line">                    <span class="keyword">int</span> to = dis.readInt();</span><br><span class="line">                    <span class="comment">// 维持session</span></span><br><span class="line">                    leader.zk.touch(sess, to);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> Leader.REVALIDATE: <span class="comment">// 重新生效，校验session</span></span><br><span class="line">                bis = <span class="keyword">new</span> ByteArrayInputStream(qp.getData());</span><br><span class="line">                dis = <span class="keyword">new</span> DataInputStream(bis);</span><br><span class="line">                <span class="keyword">long</span> id = dis.readLong();</span><br><span class="line">                <span class="keyword">int</span> to = dis.readInt();</span><br><span class="line">                ByteArrayOutputStream bos = <span class="keyword">new</span> ByteArrayOutputStream();</span><br><span class="line">                DataOutputStream dos = <span class="keyword">new</span> DataOutputStream(bos);</span><br><span class="line">                dos.writeLong(id);</span><br><span class="line">                <span class="comment">// session</span></span><br><span class="line">                <span class="keyword">boolean</span> valid = leader.zk.touch(id, to);</span><br><span class="line">                <span class="keyword">if</span> (valid) &#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        <span class="comment">//set the session owner</span></span><br><span class="line">                        <span class="comment">// as the follower that</span></span><br><span class="line">                        <span class="comment">// owns the session</span></span><br><span class="line">                        leader.zk.setOwner(id, <span class="keyword">this</span>);</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (SessionExpiredException e) &#123;</span><br><span class="line">                        LOG.error(<span class="string">"Somehow session "</span> + Long.toHexString(id) + <span class="string">" expired right after being renewed! (impossible)"</span>, e);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (LOG.isTraceEnabled()) &#123;</span><br><span class="line">                    ZooTrace.logTraceMessage(LOG,</span><br><span class="line">                                                ZooTrace.SESSION_TRACE_MASK,</span><br><span class="line">                                                <span class="string">"Session 0x"</span> + Long.toHexString(id)</span><br><span class="line">                                                + <span class="string">" is valid: "</span>+ valid);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// 返回校验结果</span></span><br><span class="line">                dos.writeBoolean(valid);</span><br><span class="line">                qp.setData(bos.toByteArray());</span><br><span class="line">                queuedPackets.add(qp);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> Leader.REQUEST:   <span class="comment">// 请求                 </span></span><br><span class="line">                bb = ByteBuffer.wrap(qp.getData());</span><br><span class="line">                sessionId = bb.getLong();</span><br><span class="line">                cxid = bb.getInt();</span><br><span class="line">                type = bb.getInt();</span><br><span class="line">                bb = bb.slice();</span><br><span class="line">                Request si;</span><br><span class="line">                <span class="keyword">if</span>(type == OpCode.sync)&#123;</span><br><span class="line">                    si = <span class="keyword">new</span> LearnerSyncRequest(<span class="keyword">this</span>, sessionId, cxid, type, bb, qp.getAuthinfo());</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    si = <span class="keyword">new</span> Request(<span class="keyword">null</span>, sessionId, cxid, type, bb, qp.getAuthinfo());</span><br><span class="line">                &#125;</span><br><span class="line">                si.setOwner(<span class="keyword">this</span>);</span><br><span class="line">                leader.zk.submitRequest(si); <span class="comment">//提交请求，处理请求在zk解析(3)中解析ZooKeeperServer</span></span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                LOG.warn(<span class="string">"unexpected quorum packet, type: &#123;&#125;"</span>, packetToString(qp));</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">        <span class="keyword">if</span> (sock != <span class="keyword">null</span> &amp;&amp; !sock.isClosed()) &#123;</span><br><span class="line">            LOG.error(<span class="string">"Unexpected exception causing shutdown while sock "</span></span><br><span class="line">                    + <span class="string">"still open"</span>, e);</span><br><span class="line">            <span class="comment">//close the socket to make sure the </span></span><br><span class="line">            <span class="comment">//other side can see it being close</span></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                sock.close();</span><br><span class="line">            &#125; <span class="keyword">catch</span>(IOException ie) &#123;</span><br><span class="line">                <span class="comment">// do nothing</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">        LOG.error(<span class="string">"Unexpected exception causing shutdown"</span>, e);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        LOG.warn(<span class="string">"******* GOODBYE "</span> </span><br><span class="line">                + (sock != <span class="keyword">null</span> ? sock.getRemoteSocketAddress() : <span class="string">"&lt;null&gt;"</span>)</span><br><span class="line">                + <span class="string">" ********"</span>);</span><br><span class="line">        shutdown();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</div><div class="tags"><a href="/tags/zookeeper/">zookeeper</a></div><div class="post-nav"><a class="pre" href="/2019/01/14/zk解析(3)-leader请求处理及处理链/">zk解析(3)：leader请求处理及处理链(ZookeeperServer/LeaderZooKeeperServer)</a><a class="next" href="/2018/12/18/zk解析(1)-zk集群启动及选主/">zk解析(1)：zk集群启动QuorumPeerMain解析</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form class="search-form" action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank"><input type="text" name="q" maxlength="20" placeholder="Search"><input type="hidden" name="sitesearch" value="https://SvizzerChow.github.io"></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Java/">Java</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Netty/">Netty</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Sentinel/">Sentinel</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/redis/">redis</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/sharding-jdbc/">sharding-jdbc</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/分布式/">分布式</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/并发/">并发</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/数据库/">数据库</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/算法/">算法</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/网络/">网络</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/虚拟机/">虚拟机</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/原子性/" style="font-size: 15px;">原子性</a> <a href="/tags/BASE理论/" style="font-size: 15px;">BASE理论</a> <a href="/tags/虚拟机/" style="font-size: 15px;">虚拟机</a> <a href="/tags/JavaAgent/" style="font-size: 15px;">JavaAgent</a> <a href="/tags/集合/" style="font-size: 15px;">集合</a> <a href="/tags/可见性/" style="font-size: 15px;">可见性</a> <a href="/tags/内存模型/" style="font-size: 15px;">内存模型</a> <a href="/tags/MESI/" style="font-size: 15px;">MESI</a> <a href="/tags/volatile/" style="font-size: 15px;">volatile</a> <a href="/tags/MySQL/" style="font-size: 15px;">MySQL</a> <a href="/tags/网络/" style="font-size: 15px;">网络</a> <a href="/tags/Netty/" style="font-size: 15px;">Netty</a> <a href="/tags/channel/" style="font-size: 15px;">channel</a> <a href="/tags/NIO/" style="font-size: 15px;">NIO</a> <a href="/tags/限流/" style="font-size: 15px;">限流</a> <a href="/tags/降级/" style="font-size: 15px;">降级</a> <a href="/tags/熔断/" style="font-size: 15px;">熔断</a> <a href="/tags/Sentinel/" style="font-size: 15px;">Sentinel</a> <a href="/tags/源码解析/" style="font-size: 15px;">源码解析</a> <a href="/tags/redis/" style="font-size: 15px;">redis</a> <a href="/tags/NoSQL/" style="font-size: 15px;">NoSQL</a> <a href="/tags/CAP理论/" style="font-size: 15px;">CAP理论</a> <a href="/tags/long/" style="font-size: 15px;">long</a> <a href="/tags/double/" style="font-size: 15px;">double</a> <a href="/tags/并发/" style="font-size: 15px;">并发</a> <a href="/tags/sentinel/" style="font-size: 15px;">sentinel</a> <a href="/tags/zookeeper/" style="font-size: 15px;">zookeeper</a> <a href="/tags/分布式锁/" style="font-size: 15px;">分布式锁</a> <a href="/tags/数据库/" style="font-size: 15px;">数据库</a> <a href="/tags/分库分表/" style="font-size: 15px;">分库分表</a> <a href="/tags/多线程/" style="font-size: 15px;">多线程</a> <a href="/tags/线程池/" style="font-size: 15px;">线程池</a> <a href="/tags/Java/" style="font-size: 15px;">Java</a> <a href="/tags/FutureTask/" style="font-size: 15px;">FutureTask</a> <a href="/tags/AbstractExecutorService/" style="font-size: 15px;">AbstractExecutorService</a> <a href="/tags/ThreadPoolExecutor/" style="font-size: 15px;">ThreadPoolExecutor</a> <a href="/tags/ScheduledThreadPoolExecutor/" style="font-size: 15px;">ScheduledThreadPoolExecutor</a> <a href="/tags/缓存/" style="font-size: 15px;">缓存</a> <a href="/tags/缓存行/" style="font-size: 15px;">缓存行</a> <a href="/tags/轮询/" style="font-size: 15px;">轮询</a> <a href="/tags/算法/" style="font-size: 15px;">算法</a> <a href="/tags/Spring/" style="font-size: 15px;">Spring</a> <a href="/tags/sharding-jdbc/" style="font-size: 15px;">sharding-jdbc</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2019/12/09/Netty之旅14ChannelHandler/">Netty解析十二：ChannelHandler</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/12/08/Netty之旅13ChannelPipeline/">Netty解析十一：ChannelPipeline与DefaultChannelPipeline</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/12/07/netty之旅12Channel/">Netty解析十：channel与AbstractNioChannel</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/12/06/volatile几个场景总结/">volatile几个场景总结</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/12/05/long和double使用volatile实现原子性/">volatile long/double原子读写原理</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/12/04/缓存行优化/">缓存行优化</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/12/03/MESI与内存屏障/">既然有了MESI协议为什么还要volatile来保证可见性</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/12/02/Netty之旅11SingleThreadEventLoop/">Netty解析九：EventLoop的基类SingleThreadEventLoop</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/12/01/Netty之旅10Promise/">Netty解析八：可写的Future类【Promise】</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/11/30/Netty之旅9FastThreadLocal/">Netty解析七：快速的FastThreadLocal</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2017-2020 <a href="/." rel="nofollow">SvizzerChow's Blog.</a><a rel="nofollow" target="_blank" href="http://www.beian.miit.gov.cn"> 浙icp备330500251067号</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>