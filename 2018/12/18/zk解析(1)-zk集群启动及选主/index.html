<!DOCTYPE html><html lang="zh-CN"><head><meta name="generator" content="Hexo 3.9.0"><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="我的个人博客"><title>zk解析(1)：zk集群启动QuorumPeerMain解析 | SvizzerChow's Blog</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/normalize/8.0.1/normalize.min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/1.0.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/1.0.0/grids-responsive-min.css"><link rel="stylesheet" href="//lib.baomitu.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//lib.baomitu.com/jquery/3.4.0/jquery.min.js"></script><link rel="icon" mask sizes="any" href="/favicon.ico"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">zk解析(1)：zk集群启动QuorumPeerMain解析</h1><a id="logo" href="/.">SvizzerChow's Blog</a><p class="description">Leaning</p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">zk解析(1)：zk集群启动QuorumPeerMain解析</h1><div class="post-meta">Dec 18, 2018<span> | </span><span class="category"><a href="/categories/分布式/">分布式</a></span></div><div class="post-content"><h1 id="入口查看"><a href="#入口查看" class="headerlink" title="入口查看"></a>入口查看</h1><p>打开启动脚本zkServer.cmd/zkServer.sh，可以找到以下的内容:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ZOOMAIN=&quot;org.apache.zookeeper.server.quorum.QuorumPeerMain&quot;</span><br></pre></td></tr></table></figure></p>
<p>可知入口类是org.apache.zookeeper.server.quorum.QuorumPeerMain<br><a id="more"></a></p>
<h1 id="QuorumPeerMain解析"><a href="#QuorumPeerMain解析" class="headerlink" title="QuorumPeerMain解析"></a>QuorumPeerMain解析</h1><h2 id="类继承关系"><a href="#类继承关系" class="headerlink" title="类继承关系"></a>类继承关系</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@InterfaceAudience</span>.Public</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">QuorumPeerMain</span> </span>&#123;...&#125;</span><br></pre></td></tr></table></figure>
<h2 id="成员变量"><a href="#成员变量" class="headerlink" title="成员变量"></a>成员变量</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String USAGE = <span class="string">"Usage: QuorumPeerMain configfile"</span>;</span><br><span class="line"><span class="keyword">protected</span> QuorumPeer quorumPeer;</span><br></pre></td></tr></table></figure>
<h2 id="main方法"><a href="#main方法" class="headerlink" title="main方法"></a>main方法</h2><p>main方法中new了一个QuorumPeerMain类，然后调用它的initializeAndRun(args)方法，所以的运行内容都在initializeAndRun(args)方法中<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">    QuorumPeerMain main = <span class="keyword">new</span> QuorumPeerMain();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        main.initializeAndRun(args);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IllegalArgumentException e) &#123;</span><br><span class="line">        LOG.error(<span class="string">"Invalid arguments, exiting abnormally"</span>, e);</span><br><span class="line">        LOG.info(USAGE);</span><br><span class="line">        System.err.println(USAGE);</span><br><span class="line">        System.exit(<span class="number">2</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (ConfigException e) &#123;</span><br><span class="line">        LOG.error(<span class="string">"Invalid config, exiting abnormally"</span>, e);</span><br><span class="line">        System.err.println(<span class="string">"Invalid config, exiting abnormally"</span>);</span><br><span class="line">        System.exit(<span class="number">2</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        LOG.error(<span class="string">"Unexpected exception, exiting abnormally"</span>, e);</span><br><span class="line">        System.exit(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    LOG.info(<span class="string">"Exiting normally"</span>);</span><br><span class="line">    System.exit(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="初始化与运行initializeAndRun-String-args"><a href="#初始化与运行initializeAndRun-String-args" class="headerlink" title="初始化与运行initializeAndRun(String[] args)"></a>初始化与运行initializeAndRun(String[] args)</h2><ol>
<li>使用QuorumPeerConfig解析命令行参数args；</li>
<li>启动定时清理任务DatadirCleanupManager.start()；</li>
<li>是集群启动则runFromConfig(config);</li>
<li>不然走ZooKeeperServerMain.main(args);<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">initializeAndRun</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> ConfigException, IOException</span>&#123;</span><br><span class="line">    QuorumPeerConfig config = <span class="keyword">new</span> QuorumPeerConfig();</span><br><span class="line">    <span class="keyword">if</span> (args.length == <span class="number">1</span>) &#123;</span><br><span class="line">        config.parse(args[<span class="number">0</span>]);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Start and schedule the the purge task</span></span><br><span class="line">    <span class="comment">// 启动定时清理任务</span></span><br><span class="line">    DatadirCleanupManager purgeMgr = <span class="keyword">new</span> DatadirCleanupManager(config</span><br><span class="line">            .getDataDir(), config.getDataLogDir(), config</span><br><span class="line">            .getSnapRetainCount(), config.getPurgeInterval());</span><br><span class="line">    purgeMgr.start();</span><br><span class="line">    <span class="comment">// config.servers.size() 判断集群服务器数量</span></span><br><span class="line">    <span class="keyword">if</span> (args.length == <span class="number">1</span> &amp;&amp; config.servers.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        runFromConfig(config);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        LOG.warn(<span class="string">"Either no config or no quorum defined in config, running "</span></span><br><span class="line">                + <span class="string">" in standalone mode"</span>);</span><br><span class="line">        <span class="comment">// there is only server in the quorum -- run as standalone</span></span><br><span class="line">        ZooKeeperServerMain.main(args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h2 id="集群启动runFromConfig-QuorumPeerConfig-config"><a href="#集群启动runFromConfig-QuorumPeerConfig-config" class="headerlink" title="集群启动runFromConfig(QuorumPeerConfig config)"></a>集群启动runFromConfig(QuorumPeerConfig config)</h2><ol>
<li>jmx管理log4j;</li>
<li>创建上下文工厂;</li>
<li>跟进配置项config配置QuorumPeer;</li>
<li>执行quorumPeer的初始化方法 initialize();</li>
<li>线程启动 quorumPeer.start();</li>
<li>主线程等待quorumPeer线程退出 quorumPeer.join();<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">runFromConfig</span><span class="params">(QuorumPeerConfig config)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// jmx管理log4j</span></span><br><span class="line">        ManagedUtil.registerLog4jMBeans();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (JMException e) &#123;</span><br><span class="line">        LOG.warn(<span class="string">"Unable to register log4j JMX control"</span>, e);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    LOG.info(<span class="string">"Starting quorum peer"</span>);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// 服务器上下文工厂，默认实现是NIOServerCnxnFactory，可以通过环境变量zookeeper.serverCnxnFactory设置</span></span><br><span class="line">        <span class="comment">// 这个工厂类保存了sessionMap</span></span><br><span class="line">        ServerCnxnFactory cnxnFactory = ServerCnxnFactory.createFactory();</span><br><span class="line">        cnxnFactory.configure(config.getClientPortAddress(),</span><br><span class="line">                            config.getMaxClientCnxns());</span><br><span class="line"></span><br><span class="line">        quorumPeer = getQuorumPeer();</span><br><span class="line">        <span class="comment">// 将config配置到quorumPeer</span></span><br><span class="line">        quorumPeer.setQuorumPeers(config.getServers());</span><br><span class="line">        quorumPeer.setTxnFactory(<span class="keyword">new</span> FileTxnSnapLog(</span><br><span class="line">                <span class="keyword">new</span> File(config.getDataLogDir()),</span><br><span class="line">                <span class="keyword">new</span> File(config.getDataDir())));</span><br><span class="line">        quorumPeer.setElectionType(config.getElectionAlg());</span><br><span class="line">        quorumPeer.setMyid(config.getServerId());</span><br><span class="line">        quorumPeer.setTickTime(config.getTickTime());</span><br><span class="line">        quorumPeer.setInitLimit(config.getInitLimit());</span><br><span class="line">        quorumPeer.setSyncLimit(config.getSyncLimit());</span><br><span class="line">        quorumPeer.setQuorumListenOnAllIPs(config.getQuorumListenOnAllIPs());</span><br><span class="line">        quorumPeer.setCnxnFactory(cnxnFactory);</span><br><span class="line">        quorumPeer.setQuorumVerifier(config.getQuorumVerifier());</span><br><span class="line">        quorumPeer.setClientPortAddress(config.getClientPortAddress());</span><br><span class="line">        quorumPeer.setMinSessionTimeout(config.getMinSessionTimeout());</span><br><span class="line">        quorumPeer.setMaxSessionTimeout(config.getMaxSessionTimeout());</span><br><span class="line">        quorumPeer.setZKDatabase(<span class="keyword">new</span> ZKDatabase(quorumPeer.getTxnFactory()));</span><br><span class="line">        quorumPeer.setLearnerType(config.getPeerType());</span><br><span class="line">        quorumPeer.setSyncEnabled(config.getSyncEnabled());</span><br><span class="line"></span><br><span class="line">        <span class="comment">// sets quorum sasl authentication configurations</span></span><br><span class="line">        <span class="comment">// Simple Authentication and Security Layer，一种用户身份认证机制</span></span><br><span class="line">        quorumPeer.setQuorumSaslEnabled(config.quorumEnableSasl);</span><br><span class="line">        <span class="keyword">if</span>(quorumPeer.isQuorumSaslAuthEnabled())&#123;</span><br><span class="line">            quorumPeer.setQuorumServerSaslRequired(config.quorumServerRequireSasl);</span><br><span class="line">            quorumPeer.setQuorumLearnerSaslRequired(config.quorumLearnerRequireSasl);</span><br><span class="line">            quorumPeer.setQuorumServicePrincipal(config.quorumServicePrincipal);</span><br><span class="line">            quorumPeer.setQuorumServerLoginContext(config.quorumServerLoginContext);</span><br><span class="line">            quorumPeer.setQuorumLearnerLoginContext(config.quorumLearnerLoginContext);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        quorumPeer.setQuorumCnxnThreadsSize(config.quorumCnxnThreadsSize);</span><br><span class="line">        quorumPeer.initialize();</span><br><span class="line"></span><br><span class="line">        quorumPeer.start();</span><br><span class="line">        quorumPeer.join();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">        <span class="comment">// warn, but generally this is ok</span></span><br><span class="line">        LOG.warn(<span class="string">"Quorum Peer interrupted"</span>, e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h1 id="QuorumPeer-解析"><a href="#QuorumPeer-解析" class="headerlink" title="QuorumPeer 解析"></a>QuorumPeer 解析</h1><h2 id="类继承关系-1"><a href="#类继承关系-1" class="headerlink" title="类继承关系"></a>类继承关系</h2><p><img src="https://i.loli.net/2018/12/20/5c1b5e044d0be.png" alt="继承关系"><br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">QuorumPeer</span> <span class="keyword">extends</span> <span class="title">ZooKeeperThread</span> <span class="keyword">implements</span> <span class="title">QuorumStats</span>.<span class="title">Provider</span> </span>&#123;...&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="成员变量-1"><a href="#成员变量-1" class="headerlink" title="成员变量"></a>成员变量</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">QuorumBean jmxQuorumBean;</span><br><span class="line">LocalPeerBean jmxLocalPeerBean;</span><br><span class="line">LeaderElectionBean jmxLeaderElectionBean;</span><br><span class="line">QuorumCnxManager qcm;</span><br><span class="line">QuorumAuthServer authServer;</span><br><span class="line">QuorumAuthLearner authLearner;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">boolean</span> authInitialized = <span class="keyword">false</span>;</span><br><span class="line"><span class="comment">// 存储数据结构</span></span><br><span class="line"><span class="keyword">private</span> ZKDatabase zkDb;</span><br></pre></td></tr></table></figure>
<h2 id="初始化initialize"><a href="#初始化initialize" class="headerlink" title="初始化initialize()"></a>初始化initialize()</h2><p>根据是否开启Sasl权限校验初始化QuorumAuthServer和QuorumAuthLearner。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">initialize</span><span class="params">()</span> <span class="keyword">throws</span> SaslException </span>&#123;</span><br><span class="line">    <span class="comment">// init quorum auth server &amp; learner</span></span><br><span class="line">    <span class="comment">// quorumSaslEnableAuth 是否开启权限校验</span></span><br><span class="line">    <span class="keyword">if</span> (isQuorumSaslAuthEnabled()) &#123;</span><br><span class="line">        Set&lt;String&gt; authzHosts = <span class="keyword">new</span> HashSet&lt;String&gt;();</span><br><span class="line">        <span class="keyword">for</span> (QuorumServer qs : getView().values()) &#123;</span><br><span class="line">            authzHosts.add(qs.hostname);</span><br><span class="line">        &#125;</span><br><span class="line">        authServer = <span class="keyword">new</span> SaslQuorumAuthServer(isQuorumServerSaslAuthRequired(),</span><br><span class="line">                quorumServerLoginContext, authzHosts);</span><br><span class="line">        authLearner = <span class="keyword">new</span> SaslQuorumAuthLearner(isQuorumLearnerSaslAuthRequired(),</span><br><span class="line">                quorumServicePrincipal, quorumLearnerLoginContext);</span><br><span class="line">        authInitialized = <span class="keyword">true</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        authServer = <span class="keyword">new</span> NullQuorumAuthServer();</span><br><span class="line">        authLearner = <span class="keyword">new</span> NullQuorumAuthLearner();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="执行启动流程start"><a href="#执行启动流程start" class="headerlink" title="执行启动流程start()"></a>执行启动流程start()</h2><ol>
<li>加载硬盘数据到内存；</li>
<li>开启数据读写上下文管理Server；</li>
<li>选主；<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    loadDataBase();</span><br><span class="line">    cnxnFactory.start();        </span><br><span class="line">    startLeaderElection();</span><br><span class="line">    <span class="keyword">super</span>.start();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h3 id="加载硬盘数据到内存-loadDataBase"><a href="#加载硬盘数据到内存-loadDataBase" class="headerlink" title="加载硬盘数据到内存 loadDataBase()"></a>加载硬盘数据到内存 loadDataBase()</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">loadDataBase</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    File updating = <span class="keyword">new</span> File(getTxnFactory().getSnapDir(),</span><br><span class="line">                                UPDATING_EPOCH_FILENAME);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// 将硬盘中的快照数据加载到内存中，详细见ZKDatabase解析</span></span><br><span class="line">        zkDb.loadDataBase();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// load the epochs</span></span><br><span class="line">        <span class="comment">// 加载最后的Zxid</span></span><br><span class="line">        <span class="keyword">long</span> lastProcessedZxid = zkDb.getDataTree().lastProcessedZxid;</span><br><span class="line">        <span class="comment">// 时代，Zxid中的计数值（高32位）</span></span><br><span class="line">        <span class="keyword">long</span> epochOfZxid = ZxidUtils.getEpochFromZxid(lastProcessedZxid);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// CURRENT_EPOCH_FILENAME = "currentEpoch"</span></span><br><span class="line">            <span class="comment">// 从currentEpoch文件中读取long值</span></span><br><span class="line">            currentEpoch = readLongFromFile(CURRENT_EPOCH_FILENAME);</span><br><span class="line">            <span class="comment">// 快照中的时代比当前时代大，则当前时代更新为快照中的时代</span></span><br><span class="line">            <span class="keyword">if</span> (epochOfZxid &gt; currentEpoch &amp;&amp; updating.exists()) &#123;</span><br><span class="line">                LOG.info(<span class="string">"&#123;&#125; found. The server was terminated after "</span> +</span><br><span class="line">                            <span class="string">"taking a snapshot but before updating current "</span> +</span><br><span class="line">                            <span class="string">"epoch. Setting current epoch to &#123;&#125;."</span>,</span><br><span class="line">                            UPDATING_EPOCH_FILENAME, epochOfZxid);</span><br><span class="line">                setCurrentEpoch(epochOfZxid);</span><br><span class="line">                <span class="comment">// 删除快照</span></span><br><span class="line">                <span class="keyword">if</span> (!updating.delete()) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> IOException(<span class="string">"Failed to delete "</span> +</span><br><span class="line">                                            updating.toString());</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span>(FileNotFoundException e) &#123;</span><br><span class="line">            <span class="comment">// pick a reasonable epoch number</span></span><br><span class="line">            <span class="comment">// this should only happen once when moving to a</span></span><br><span class="line">            <span class="comment">// new code version</span></span><br><span class="line">            <span class="comment">// 读取不到当前currentEpoch的文件，设置快照中的epoch并保存到文件中</span></span><br><span class="line">            currentEpoch = epochOfZxid;</span><br><span class="line">            LOG.info(CURRENT_EPOCH_FILENAME</span><br><span class="line">                    + <span class="string">" not found! Creating with a reasonable default of &#123;&#125;. This should only happen when you are upgrading your installation"</span>,</span><br><span class="line">                    currentEpoch);</span><br><span class="line">            writeLongToFile(CURRENT_EPOCH_FILENAME, currentEpoch);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (epochOfZxid &gt; currentEpoch) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IOException(<span class="string">"The current epoch, "</span> + ZxidUtils.zxidToString(currentEpoch) + <span class="string">", is older than the last zxid, "</span> + lastProcessedZxid);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 读取已接收的acceptedEpoch文件中的时代</span></span><br><span class="line">            acceptedEpoch = readLongFromFile(ACCEPTED_EPOCH_FILENAME);</span><br><span class="line">        &#125; <span class="keyword">catch</span>(FileNotFoundException e) &#123;</span><br><span class="line">            <span class="comment">// pick a reasonable epoch number</span></span><br><span class="line">            <span class="comment">// this should only happen once when moving to a</span></span><br><span class="line">            <span class="comment">// new code version</span></span><br><span class="line">            acceptedEpoch = epochOfZxid;</span><br><span class="line">            LOG.info(ACCEPTED_EPOCH_FILENAME</span><br><span class="line">                    + <span class="string">" not found! Creating with a reasonable default of &#123;&#125;. This should only happen when you are upgrading your installation"</span>,</span><br><span class="line">                    acceptedEpoch);</span><br><span class="line">            writeLongToFile(ACCEPTED_EPOCH_FILENAME, acceptedEpoch);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (acceptedEpoch &lt; currentEpoch) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IOException(<span class="string">"The accepted epoch, "</span> + ZxidUtils.zxidToString(acceptedEpoch) + <span class="string">" is less than the current epoch, "</span> + ZxidUtils.zxidToString(currentEpoch));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span>(IOException ie) &#123;</span><br><span class="line">        LOG.error(<span class="string">"Unable to load database on disk"</span>, ie);</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"Unable to run quorum server "</span>, ie);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="开启客户端数据读写服务cnxnFactory-start"><a href="#开启客户端数据读写服务cnxnFactory-start" class="headerlink" title="开启客户端数据读写服务cnxnFactory.start()"></a>开启客户端数据读写服务cnxnFactory.start()</h3><p>ServerCnxnFactory是作为处理读写的Server，有不同的实现方式。</p>
<p>由上文ServerCnxnFactory cnxnFactory = ServerCnxnFactory.createFactory();可以知道默认实现是NIOServerCnxnFactory，所以参考该类的实现。</p>
<blockquote>
<p>public class NIOServerCnxnFactory extends ServerCnxnFactory implements Runnable </p>
</blockquote>
<p>NIOServerCnxnFactory实现了Runnable接口，同时内部保存了一个Thread对象，start方法就是执行这个Thread对象的start()。即单独开一个线程实现读写Server。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(InetSocketAddress addr, <span class="keyword">int</span> maxcc)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    configureSaslLogin();</span><br><span class="line"></span><br><span class="line">    thread = <span class="keyword">new</span> ZooKeeperThread(<span class="keyword">this</span>, <span class="string">"NIOServerCxn.Factory:"</span> + addr);</span><br><span class="line">    thread.setDaemon(<span class="keyword">true</span>);</span><br><span class="line">    maxClientCnxns = maxcc;</span><br><span class="line">    <span class="keyword">this</span>.ss = ServerSocketChannel.open();</span><br><span class="line">    ss.socket().setReuseAddress(<span class="keyword">true</span>);</span><br><span class="line">    LOG.info(<span class="string">"binding to port "</span> + addr);</span><br><span class="line">    ss.socket().bind(addr);</span><br><span class="line">    ss.configureBlocking(<span class="keyword">false</span>);</span><br><span class="line">    ss.register(selector, SelectionKey.OP_ACCEPT);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// ensure thread is started once and only once</span></span><br><span class="line">    <span class="keyword">if</span> (thread.getState() == Thread.State.NEW) &#123;</span><br><span class="line">        thread.start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>主要看实现的run()方法。run方法实现了一个NIO的Server，处理连接和读写请求，其中读写请求由NIOServerCnxn的doIO处理。读写请求处理的详细解析放到另一个章节中解析。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">while</span> (!ss.socket().isClosed()) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            selector.select(<span class="number">1000</span>);</span><br><span class="line">            Set&lt;SelectionKey&gt; selected;</span><br><span class="line">            <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">                selected = selector.selectedKeys();</span><br><span class="line">            &#125;</span><br><span class="line">            ArrayList&lt;SelectionKey&gt; selectedList = <span class="keyword">new</span> ArrayList&lt;SelectionKey&gt;(</span><br><span class="line">                    selected);</span><br><span class="line">            Collections.shuffle(selectedList);</span><br><span class="line">            <span class="keyword">for</span> (SelectionKey k : selectedList) &#123;</span><br><span class="line">                <span class="comment">// 处理连接</span></span><br><span class="line">                <span class="keyword">if</span> ((k.readyOps() &amp; SelectionKey.OP_ACCEPT) != <span class="number">0</span>) &#123;</span><br><span class="line">                    SocketChannel sc = ((ServerSocketChannel) k</span><br><span class="line">                            .channel()).accept();</span><br><span class="line">                    InetAddress ia = sc.socket().getInetAddress();</span><br><span class="line">                    <span class="keyword">int</span> cnxncount = getClientCnxnCount(ia);</span><br><span class="line">                    <span class="keyword">if</span> (maxClientCnxns &gt; <span class="number">0</span> &amp;&amp; cnxncount &gt;= maxClientCnxns)&#123;</span><br><span class="line">                        LOG.warn(<span class="string">"Too many connections from "</span> + ia</span><br><span class="line">                                    + <span class="string">" - max is "</span> + maxClientCnxns );</span><br><span class="line">                        sc.close();</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        LOG.info(<span class="string">"Accepted socket connection from "</span></span><br><span class="line">                                    + sc.socket().getRemoteSocketAddress());</span><br><span class="line">                        sc.configureBlocking(<span class="keyword">false</span>);</span><br><span class="line">                        SelectionKey sk = sc.register(selector,</span><br><span class="line">                                SelectionKey.OP_READ);</span><br><span class="line">                        NIOServerCnxn cnxn = createConnection(sc, sk);</span><br><span class="line">                        <span class="comment">// 这里添加上下文 NIOServerCnxn</span></span><br><span class="line">                        sk.attach(cnxn);</span><br><span class="line">                        addCnxn(cnxn);</span><br><span class="line">                    &#125;</span><br><span class="line">                <span class="comment">// 处理读写请求</span></span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> ((k.readyOps() &amp; (SelectionKey.OP_READ | SelectionKey.OP_WRITE)) != <span class="number">0</span>) &#123;</span><br><span class="line">                    NIOServerCnxn c = (NIOServerCnxn) k.attachment();</span><br><span class="line">                    c.doIO(k);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span> (LOG.isDebugEnabled()) &#123;</span><br><span class="line">                        LOG.debug(<span class="string">"Unexpected ops in select "</span></span><br><span class="line">                                    + k.readyOps());</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            selected.clear();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (RuntimeException e) &#123;</span><br><span class="line">            LOG.warn(<span class="string">"Ignoring unexpected runtime exception"</span>, e);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            LOG.warn(<span class="string">"Ignoring exception"</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    closeAll();</span><br><span class="line">    LOG.info(<span class="string">"NIOServerCnxn factory exited run method"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="初始化选主startLeaderElection"><a href="#初始化选主startLeaderElection" class="headerlink" title="初始化选主startLeaderElection()"></a>初始化选主startLeaderElection()</h3><p><strong>投票信息对象</strong><br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Vote</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">private</span> <span class="keyword">int</span> version;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">private</span> <span class="keyword">long</span> id;              <span class="comment">//服务器id </span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">private</span> <span class="keyword">long</span> zxid;            <span class="comment">//服务器当前zxid</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">private</span> <span class="keyword">long</span> electionEpoch;   </span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">private</span> <span class="keyword">long</span> peerEpoch;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">private</span> ServerState state;    <span class="comment">//状态，开始选主时为LOOKING</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Vote</span><span class="params">(<span class="keyword">long</span> id, </span></span></span><br><span class="line"><span class="function"><span class="params">                    <span class="keyword">long</span> zxid, </span></span></span><br><span class="line"><span class="function"><span class="params">                    <span class="keyword">long</span> electionEpoch, </span></span></span><br><span class="line"><span class="function"><span class="params">                    <span class="keyword">long</span> peerEpoch)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.version = <span class="number">0x0</span>;</span><br><span class="line">        <span class="keyword">this</span>.id = id;</span><br><span class="line">        <span class="keyword">this</span>.zxid = zxid;</span><br><span class="line">        <span class="keyword">this</span>.electionEpoch = electionEpoch;</span><br><span class="line">        <span class="keyword">this</span>.peerEpoch = peerEpoch;</span><br><span class="line">        <span class="keyword">this</span>.state = ServerState.LOOKING;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><strong>初始化选主</strong></p>
<ol>
<li>生成投票信息对象Vote，包含服务器ID、当前服务器的zxid、CurrentEpoch，且状态为LOOKING；</li>
<li>获取当前服务器配置的addr；</li>
<li>生成选举算法；<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">synchronized</span> <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">startLeaderElection</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// 生成当前节点（服务器）的投票ID</span></span><br><span class="line">        <span class="comment">// myid服务器编号，当前发zxid，时间戳</span></span><br><span class="line">        <span class="comment">// 此时Vote的服务器状态是ServerState.LOOKING</span></span><br><span class="line">        currentVote = <span class="keyword">new</span> Vote(myid, getLastLoggedZxid(), getCurrentEpoch());</span><br><span class="line">    &#125; <span class="keyword">catch</span>(IOException e) &#123;</span><br><span class="line">        RuntimeException re = <span class="keyword">new</span> RuntimeException(e.getMessage());</span><br><span class="line">        re.setStackTrace(e.getStackTrace());</span><br><span class="line">        <span class="keyword">throw</span> re;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//  getView().values() 集群中的observer</span></span><br><span class="line">    <span class="comment">//  找到当前服务器的addr</span></span><br><span class="line">    <span class="keyword">for</span> (QuorumServer p : getView().values()) &#123;</span><br><span class="line">        <span class="keyword">if</span> (p.id == myid) &#123;</span><br><span class="line">            myQuorumAddr = p.addr;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (myQuorumAddr == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"My id "</span> + myid + <span class="string">" not in the peer list"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// electionType区分不同的选举算法，默认值为3，可在配置文件中配置</span></span><br><span class="line">    <span class="keyword">if</span> (electionType == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            udpSocket = <span class="keyword">new</span> DatagramSocket(myQuorumAddr.getPort());</span><br><span class="line">            responder = <span class="keyword">new</span> ResponderThread();</span><br><span class="line">            <span class="comment">// 相应请求，LOOKING状态返回服务器id和zxid</span></span><br><span class="line">            responder.start();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (SocketException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 生成选举算法</span></span><br><span class="line">    <span class="comment">// 默认值为3:FastLeaderElection，其他算法在3.4版本中已经废弃</span></span><br><span class="line">    <span class="keyword">this</span>.electionAlg = createElectionAlgorithm(electionType);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">protected</span> Election <span class="title">createElectionAlgorithm</span><span class="params">(<span class="keyword">int</span> electionAlgorithm)</span></span>&#123;</span><br><span class="line">    Election le=<span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">switch</span> (electionAlgorithm) &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">        le = <span class="keyword">new</span> LeaderElection(<span class="keyword">this</span>);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">        le = <span class="keyword">new</span> AuthFastLeaderElection(<span class="keyword">this</span>);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">        le = <span class="keyword">new</span> AuthFastLeaderElection(<span class="keyword">this</span>, <span class="keyword">true</span>);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">3</span>:</span><br><span class="line">        qcm = createCnxnManager();</span><br><span class="line">        QuorumCnxManager.Listener listener = qcm.listener;</span><br><span class="line">        <span class="keyword">if</span>(listener != <span class="keyword">null</span>)&#123;</span><br><span class="line">            listener.start();</span><br><span class="line">            le = <span class="keyword">new</span> FastLeaderElection(<span class="keyword">this</span>, qcm);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            LOG.error(<span class="string">"Null listener when initializing cnx manager"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">        <span class="keyword">assert</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> le;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h3 id="开始选主super-start"><a href="#开始选主super-start" class="headerlink" title="开始选主super.start()"></a>开始选主super.start()</h3><p>看一下继承关系<img src="https://i.loli.net/2018/12/20/5c1b5e044d0be.png" alt="继承关系"><br>可以发现start()方法其实是Thread类的实现，也就是开启线程。QuorumPeer类继承了ZooKeeperThread并且重写了Thread的run()方法，也就是开启线程执行内容。接下来看QuorumPeer的run()方法。</p>
<p>这个run()方法一直处于运行状态，当服务器状态改变为LOOKING状态，就会执行选主策略的lookForLeader()方法去选主。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// Thread类的方法，设置线程名</span></span><br><span class="line">    setName(<span class="string">"QuorumPeer"</span> + <span class="string">"[myid="</span> + getId() + <span class="string">"]"</span> +</span><br><span class="line">            cnxnFactory.getLocalAddress());</span><br><span class="line"></span><br><span class="line">    LOG.debug(<span class="string">"Starting quorum peer"</span>);</span><br><span class="line">    <span class="comment">// jmx配置</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        jmxQuorumBean = <span class="keyword">new</span> QuorumBean(<span class="keyword">this</span>);</span><br><span class="line">        MBeanRegistry.getInstance().register(jmxQuorumBean, <span class="keyword">null</span>);</span><br><span class="line">        <span class="comment">// 遍历所有观察者(observer)</span></span><br><span class="line">        <span class="keyword">for</span>(QuorumServer s: getView().values())&#123;</span><br><span class="line">            ZKMBeanInfo p;</span><br><span class="line">            <span class="comment">// 当前服务器</span></span><br><span class="line">            <span class="keyword">if</span> (getId() == s.id) &#123;</span><br><span class="line">                p = jmxLocalPeerBean = <span class="keyword">new</span> LocalPeerBean(<span class="keyword">this</span>);</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    MBeanRegistry.getInstance().register(p, jmxQuorumBean);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                    LOG.warn(<span class="string">"Failed to register with JMX"</span>, e);</span><br><span class="line">                    jmxLocalPeerBean = <span class="keyword">null</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                p = <span class="keyword">new</span> RemotePeerBean(s);</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    MBeanRegistry.getInstance().register(p, jmxQuorumBean);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                    LOG.warn(<span class="string">"Failed to register with JMX"</span>, e);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        LOG.warn(<span class="string">"Failed to register with JMX"</span>, e);</span><br><span class="line">        jmxQuorumBean = <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * Main loop 主循环，这个循环一直查询服务器状态，当服务器处于LOOKING状态时就会开始选主</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">while</span> (running) &#123;</span><br><span class="line">            <span class="keyword">switch</span> (getPeerState()) &#123;  <span class="comment">// state属性记录当前节点的状态</span></span><br><span class="line">            <span class="keyword">case</span> LOOKING:     <span class="comment">//LOOKING状态代表要选主</span></span><br><span class="line">                LOG.info(<span class="string">"LOOKING"</span>);</span><br><span class="line">                <span class="comment">// 开启只读模式</span></span><br><span class="line">                <span class="keyword">if</span> (Boolean.getBoolean(<span class="string">"readonlymode.enabled"</span>)) &#123;</span><br><span class="line">                    LOG.info(<span class="string">"Attempting to start ReadOnlyZooKeeperServer"</span>);</span><br><span class="line">                    <span class="comment">// 只读服务</span></span><br><span class="line">                    <span class="comment">// Create read-only server but don't start it immediately</span></span><br><span class="line">                    <span class="keyword">final</span> ReadOnlyZooKeeperServer roZk = <span class="keyword">new</span> ReadOnlyZooKeeperServer(</span><br><span class="line">                            logFactory, <span class="keyword">this</span>,</span><br><span class="line">                            <span class="keyword">new</span> ZooKeeperServer.BasicDataTreeBuilder(),</span><br><span class="line">                            <span class="keyword">this</span>.zkDb);</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// Instead of starting roZk immediately, wait some grace</span></span><br><span class="line">                    <span class="comment">// period before we decide we're partitioned.</span></span><br><span class="line">                    <span class="comment">//</span></span><br><span class="line">                    <span class="comment">// Thread is used here because otherwise it would require</span></span><br><span class="line">                    <span class="comment">// changes in each of election strategy classes which is</span></span><br><span class="line">                    <span class="comment">// unnecessary code coupling.</span></span><br><span class="line">                    Thread roZkMgr = <span class="keyword">new</span> Thread() &#123;</span><br><span class="line">                        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                            <span class="keyword">try</span> &#123;</span><br><span class="line">                                <span class="comment">// lower-bound grace period to 2 secs</span></span><br><span class="line">                                sleep(Math.max(<span class="number">2000</span>, tickTime));</span><br><span class="line">                                <span class="keyword">if</span> (ServerState.LOOKING.equals(getPeerState())) &#123;</span><br><span class="line">                                    roZk.startup();</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                                LOG.info(<span class="string">"Interrupted while attempting to start ReadOnlyZooKeeperServer, not started"</span>);</span><br><span class="line">                            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                                LOG.error(<span class="string">"FAILED to start ReadOnlyZooKeeperServer"</span>, e);</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        roZkMgr.start();</span><br><span class="line">                        setBCVote(<span class="keyword">null</span>);</span><br><span class="line">                        <span class="comment">// 执行在startLeaderElection()中生成的选主策略的lookForLeader()方法</span></span><br><span class="line">                        setCurrentVote(makeLEStrategy().lookForLeader());</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                        LOG.warn(<span class="string">"Unexpected exception"</span>,e);</span><br><span class="line">                        setPeerState(ServerState.LOOKING);</span><br><span class="line">                    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                        <span class="comment">// If the thread is in the the grace period, interrupt</span></span><br><span class="line">                        <span class="comment">// to come out of waiting.</span></span><br><span class="line">                        roZkMgr.interrupt();</span><br><span class="line">                        roZk.shutdown();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        setBCVote(<span class="keyword">null</span>);</span><br><span class="line">                        <span class="comment">// 执行在startLeaderElection()中生成的选主策略的lookForLeader()方法</span></span><br><span class="line">                        setCurrentVote(makeLEStrategy().lookForLeader());</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                        LOG.warn(<span class="string">"Unexpected exception"</span>, e);</span><br><span class="line">                        setPeerState(ServerState.LOOKING);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> OBSERVING:     <span class="comment">// 成为了观察者</span></span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    LOG.info(<span class="string">"OBSERVING"</span>);</span><br><span class="line">                    setObserver(makeObserver(logFactory));</span><br><span class="line">                    observer.observeLeader();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                    LOG.warn(<span class="string">"Unexpected exception"</span>,e );                        </span><br><span class="line">                &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                    observer.shutdown();</span><br><span class="line">                    setObserver(<span class="keyword">null</span>);</span><br><span class="line">                    setPeerState(ServerState.LOOKING);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> FOLLOWING:</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    LOG.info(<span class="string">"FOLLOWING"</span>);</span><br><span class="line">                    setFollower(makeFollower(logFactory));</span><br><span class="line">                    follower.followLeader();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                    LOG.warn(<span class="string">"Unexpected exception"</span>,e);</span><br><span class="line">                &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                    follower.shutdown();</span><br><span class="line">                    setFollower(<span class="keyword">null</span>);</span><br><span class="line">                    setPeerState(ServerState.LOOKING);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> LEADING:</span><br><span class="line">                LOG.info(<span class="string">"LEADING"</span>);</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    setLeader(makeLeader(logFactory));</span><br><span class="line">                    leader.lead();</span><br><span class="line">                    setLeader(<span class="keyword">null</span>);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                    LOG.warn(<span class="string">"Unexpected exception"</span>,e);</span><br><span class="line">                &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span> (leader != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        leader.shutdown(<span class="string">"Forcing shutdown"</span>);</span><br><span class="line">                        setLeader(<span class="keyword">null</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                    setPeerState(ServerState.LOOKING);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        LOG.warn(<span class="string">"QuorumPeer main thread exited"</span>);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            MBeanRegistry.getInstance().unregisterAll();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            LOG.warn(<span class="string">"Failed to unregister with JMX"</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">        jmxQuorumBean = <span class="keyword">null</span>;</span><br><span class="line">        jmxLocalPeerBean = <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="选主策略"><a href="#选主策略" class="headerlink" title="选主策略"></a>选主策略</h2><p>所有选主策略都实现了Election接口，其中lookForLeader方法用于选主。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Election</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Vote <span class="title">lookForLeader</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException</span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">shutdown</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>目前除FastLeaderElection外的选主方式都已经处于废弃状态，所以主要关注FastLeaderElection。</p>
<h3 id="快速选主FastLeaderElection"><a href="#快速选主FastLeaderElection" class="headerlink" title="快速选主FastLeaderElection"></a>快速选主FastLeaderElection</h3><p><strong>继承</strong><br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FastLeaderElection</span> <span class="keyword">implements</span> <span class="title">Election</span></span>&#123;...&#125;</span><br></pre></td></tr></table></figure></p>
<p>在了解选主之前要先了解一下QuorumCnxManager，QuorumCnxManager通过SocketServer实现与其它服务器选主信息交互。</p>
<h4 id="选主消息管理-QuorumCnxManager-Socket"><a href="#选主消息管理-QuorumCnxManager-Socket" class="headerlink" title="选主消息管理 QuorumCnxManager Socket"></a>选主消息管理 QuorumCnxManager Socket</h4><p>QuorumCnxManager代码比较简单就不解析，这里将主要的流程贴一下：<br><img src="https://imgchr.com/i/FfAcWQ" alt="QuorumCnxManager"></p>
<p><strong>注意：zk为了防止TCP连接重复，要求只能sid高的节点主动连接sid低的节点。</strong></p>
<p>建立socket连接后，因为socket是阻塞的，所以读写都在单独的线程上执行。</p>
<h4 id="FastLeaderElection-WorkerReceiver处理消息"><a href="#FastLeaderElection-WorkerReceiver处理消息" class="headerlink" title="FastLeaderElection.WorkerReceiver处理消息"></a>FastLeaderElection.WorkerReceiver处理消息</h4><p><img src="https://imgchr.com/i/FfATFU" alt></p>
<h4 id="选主lookForLeader"><a href="#选主lookForLeader" class="headerlink" title="选主lookForLeader()"></a>选主lookForLeader()</h4><p><strong>完整流程图</strong><br><img src="https://imgchr.com/i/FfAXO1" alt></p>
<p><strong>简略的流程</strong><br><img src="https://i.loli.net/2019/01/01/5c2b334316e6f.jpg" alt><br>代码解析<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Vote <span class="title">lookForLeader</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">    <span class="comment">// jmx</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        self.jmxLeaderElectionBean = <span class="keyword">new</span> LeaderElectionBean();</span><br><span class="line">        MBeanRegistry.getInstance().register(</span><br><span class="line">                self.jmxLeaderElectionBean, self.jmxLocalPeerBean);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        LOG.warn(<span class="string">"Failed to register with JMX"</span>, e);</span><br><span class="line">        self.jmxLeaderElectionBean = <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (self.start_fle == <span class="number">0</span>) &#123;</span><br><span class="line">        self.start_fle = Time.currentElapsedTime();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// 接收到的Vote</span></span><br><span class="line">        HashMap&lt;Long, Vote&gt; recvset = <span class="keyword">new</span> HashMap&lt;Long, Vote&gt;();</span><br><span class="line"></span><br><span class="line">        HashMap&lt;Long, Vote&gt; outofelection = <span class="keyword">new</span> HashMap&lt;Long, Vote&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span> notTimeout = finalizeWait;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">synchronized</span>(<span class="keyword">this</span>)&#123;</span><br><span class="line">            <span class="comment">// AtomicLong#incrementAndGet</span></span><br><span class="line">            logicalclock.incrementAndGet();</span><br><span class="line">            <span class="comment">// 更新提案，提案当前服务器为主节点</span></span><br><span class="line">            updateProposal(getInitId(), getInitLastLoggedZxid(), getPeerEpoch());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        LOG.info(<span class="string">"New election. My id =  "</span> + self.getId() +</span><br><span class="line">                <span class="string">", proposed zxid=0x"</span> + Long.toHexString(proposedZxid));</span><br><span class="line">        <span class="comment">// 向所有节点发送投票通知，提议当前节点为主节点</span></span><br><span class="line">        sendNotifications();</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">        * Loop in which we exchange notifications until we find a leader</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">        <span class="comment">// 循环直到找到主节点</span></span><br><span class="line">        <span class="keyword">while</span> ((self.getPeerState() == ServerState.LOOKING) &amp;&amp;</span><br><span class="line">                (!stop))&#123;</span><br><span class="line">            <span class="comment">/*</span></span><br><span class="line"><span class="comment">                * Remove next notification from queue, times out after 2 times</span></span><br><span class="line"><span class="comment">                * the termination time</span></span><br><span class="line"><span class="comment">                */</span></span><br><span class="line">            Notification n = recvqueue.poll(notTimeout,</span><br><span class="line">                    TimeUnit.MILLISECONDS);</span><br><span class="line"></span><br><span class="line">            <span class="comment">/*</span></span><br><span class="line"><span class="comment">                * Sends more notifications if haven't received enough.</span></span><br><span class="line"><span class="comment">                * Otherwise processes new notification.</span></span><br><span class="line"><span class="comment">                */</span></span><br><span class="line">            <span class="keyword">if</span>(n == <span class="keyword">null</span>)&#123;</span><br><span class="line">                <span class="comment">// 已经发送了，但是没有接收的返回就重新发送</span></span><br><span class="line">                <span class="keyword">if</span>(manager.haveDelivered())&#123;</span><br><span class="line">                    sendNotifications();</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    manager.connectAll();</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">/*</span></span><br><span class="line"><span class="comment">                    * Exponential backoff</span></span><br><span class="line"><span class="comment">                    */</span></span><br><span class="line">                <span class="keyword">int</span> tmpTimeOut = notTimeout*<span class="number">2</span>;</span><br><span class="line">                notTimeout = (tmpTimeOut &lt; maxNotificationInterval?</span><br><span class="line">                        tmpTimeOut : maxNotificationInterval);</span><br><span class="line">                LOG.info(<span class="string">"Notification time out: "</span> + notTimeout);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span>(validVoter(n.sid) &amp;&amp; validVoter(n.leader)) &#123; <span class="comment">// 接收到了响应，validVoter校验响应的服务器是否在集群中</span></span><br><span class="line">                <span class="comment">/*</span></span><br><span class="line"><span class="comment">                    * Only proceed if the vote comes from a replica in the</span></span><br><span class="line"><span class="comment">                    * voting view for a replica in the voting view.</span></span><br><span class="line"><span class="comment">                    */</span></span><br><span class="line">                <span class="keyword">switch</span> (n.state) &#123;</span><br><span class="line">                <span class="keyword">case</span> LOOKING:   <span class="comment">// 选主消息</span></span><br><span class="line">                    <span class="comment">// If notification &gt; current, replace and send messages out</span></span><br><span class="line">                    <span class="comment">// 每次发消息都会计数logicalclock</span></span><br><span class="line">                    <span class="comment">// 判断接收到的选举消息是否和发送的消息是同一次</span></span><br><span class="line">                    <span class="keyword">if</span> (n.electionEpoch &gt; logicalclock.get()) &#123;</span><br><span class="line">                        <span class="comment">// 设置当前服务器的计数值为接收到的大的值</span></span><br><span class="line">                        logicalclock.set(n.electionEpoch);</span><br><span class="line">                        recvset.clear();</span><br><span class="line">                        <span class="comment">// totalOrderPredicate 判断推举哪个服务器</span></span><br><span class="line">                        <span class="comment">// 判断条件curEpoch，curZxid，curId</span></span><br><span class="line">                        <span class="comment">// 依次比较大小，如果n中的比较大则推举n中发服务器为主节点</span></span><br><span class="line">                        <span class="keyword">if</span>(totalOrderPredicate(n.leader, n.zxid, n.peerEpoch,</span><br><span class="line">                                getInitId(), getInitLastLoggedZxid(), getPeerEpoch())) &#123;</span><br><span class="line">                            updateProposal(n.leader, n.zxid, n.peerEpoch);</span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123; <span class="comment">// 推举自己为主节点</span></span><br><span class="line">                            updateProposal(getInitId(),</span><br><span class="line">                                    getInitLastLoggedZxid(),</span><br><span class="line">                                    getPeerEpoch());</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="comment">// 发送推举的服务器信息</span></span><br><span class="line">                        sendNotifications();</span><br><span class="line">                    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (n.electionEpoch &lt; logicalclock.get()) &#123;   <span class="comment">// 收到的计数值比当前的计数值小</span></span><br><span class="line">                        <span class="keyword">if</span>(LOG.isDebugEnabled())&#123;</span><br><span class="line">                            LOG.debug(<span class="string">"Notification election epoch is smaller than logicalclock. n.electionEpoch = 0x"</span></span><br><span class="line">                                    + Long.toHexString(n.electionEpoch)</span><br><span class="line">                                    + <span class="string">", logicalclock=0x"</span> + Long.toHexString(logicalclock.get()));</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                        <span class="comment">// totalOrderPredicate 判断推举哪个服务器</span></span><br><span class="line">                        <span class="comment">// 判断条件curEpoch，curZxid，curId</span></span><br><span class="line">                        <span class="comment">// 依次比较大小，如果n中的比较大则推举n中发服务器为主节点</span></span><br><span class="line">                    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (totalOrderPredicate(n.leader, n.zxid, n.peerEpoch,</span><br><span class="line">                            proposedLeader, proposedZxid, proposedEpoch)) &#123;</span><br><span class="line">                        updateProposal(n.leader, n.zxid, n.peerEpoch);</span><br><span class="line">                        sendNotifications();</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span>(LOG.isDebugEnabled())&#123;</span><br><span class="line">                        LOG.debug(<span class="string">"Adding vote: from="</span> + n.sid +</span><br><span class="line">                                <span class="string">", proposed leader="</span> + n.leader +</span><br><span class="line">                                <span class="string">", proposed zxid=0x"</span> + Long.toHexString(n.zxid) +</span><br><span class="line">                                <span class="string">", proposed election epoch=0x"</span> + Long.toHexString(n.electionEpoch));</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">// 记录接收到的投票信息</span></span><br><span class="line">                    recvset.put(n.sid, <span class="keyword">new</span> Vote(n.leader, n.zxid, n.electionEpoch, n.peerEpoch));</span><br><span class="line">                    <span class="comment">// 判断当前服务器支持的提案（proposedLeader）是否已经有过半的服务器支持了</span></span><br><span class="line">                    <span class="keyword">if</span> (termPredicate(recvset,</span><br><span class="line">                            <span class="keyword">new</span> Vote(proposedLeader, proposedZxid,</span><br><span class="line">                                    logicalclock.get(), proposedEpoch))) &#123;</span><br><span class="line"></span><br><span class="line">                        <span class="comment">// Verify if there is any change in the proposed leader</span></span><br><span class="line">                        <span class="comment">// 当前已经有半数的服务器同意了提案，看看还能不能接收其他服务器的提案</span></span><br><span class="line">                        <span class="keyword">while</span>((n = recvqueue.poll(finalizeWait,</span><br><span class="line">                                TimeUnit.MILLISECONDS)) != <span class="keyword">null</span>)&#123;</span><br><span class="line">                            <span class="comment">// 比较接收的提案</span></span><br><span class="line">                            <span class="keyword">if</span>(totalOrderPredicate(n.leader, n.zxid, n.peerEpoch,</span><br><span class="line">                                    proposedLeader, proposedZxid, proposedEpoch))&#123;</span><br><span class="line">                                recvqueue.put(n);</span><br><span class="line">                                <span class="keyword">break</span>; <span class="comment">// 提案变更</span></span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="comment">// 队列中没有投票信息（提案没有变更，提案变更n是存在值的）</span></span><br><span class="line">                        <span class="keyword">if</span> (n == <span class="keyword">null</span>) &#123;</span><br><span class="line">                            <span class="comment">// 这里更新状态</span></span><br><span class="line">                            <span class="comment">// 队列中没有投票信息且当前提案推选的节点为当前服务器ID，则当前节点成为主节点</span></span><br><span class="line">                            self.setPeerState((proposedLeader == self.getId()) ?</span><br><span class="line">                                    ServerState.LEADING: learningState());</span><br><span class="line">                            Vote endVote = <span class="keyword">new</span> Vote(proposedLeader,</span><br><span class="line">                                                    proposedZxid,</span><br><span class="line">                                                    logicalclock.get(),</span><br><span class="line">                                                    proposedEpoch);</span><br><span class="line">                            leaveInstance(endVote);  <span class="comment">//清空recvqueue</span></span><br><span class="line">                            <span class="keyword">return</span> endVote;          <span class="comment">//返回选主结果 </span></span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> OBSERVING:</span><br><span class="line">                    LOG.debug(<span class="string">"Notification from observer: "</span> + n.sid);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> FOLLOWING:</span><br><span class="line">                <span class="keyword">case</span> LEADING:   <span class="comment">// 其他节点为主节点或者跟随者</span></span><br><span class="line">                    <span class="comment">// 确定计数值相同，即同一次选举</span></span><br><span class="line">                    <span class="keyword">if</span>(n.electionEpoch == logicalclock.get())&#123;</span><br><span class="line">                        recvset.put(n.sid, <span class="keyword">new</span> Vote(n.leader,</span><br><span class="line">                                                        n.zxid,</span><br><span class="line">                                                        n.electionEpoch,</span><br><span class="line">                                                        n.peerEpoch));</span><br><span class="line">                        <span class="comment">// ooePredicate调用了termPredicate判断是否被半数以上的服务器同意</span></span><br><span class="line">                        <span class="comment">// 并调用checkLeader校验推举的服务器的状态</span></span><br><span class="line">                        <span class="keyword">if</span>(ooePredicate(recvset, outofelection, n)) &#123;</span><br><span class="line">                            <span class="comment">// 设置当前服务器的状态</span></span><br><span class="line">                            self.setPeerState((n.leader == self.getId()) ?</span><br><span class="line">                                    ServerState.LEADING: learningState());</span><br><span class="line"></span><br><span class="line">                            Vote endVote = <span class="keyword">new</span> Vote(n.leader, </span><br><span class="line">                                    n.zxid, </span><br><span class="line">                                    n.electionEpoch, </span><br><span class="line">                                    n.peerEpoch);</span><br><span class="line">                            leaveInstance(endVote);</span><br><span class="line">                            <span class="keyword">return</span> endVote;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    </span><br><span class="line">                    <span class="comment">/*</span></span><br><span class="line"><span class="comment">                        * Before joining an established ensemble, verify</span></span><br><span class="line"><span class="comment">                        * a majority is following the same leader.</span></span><br><span class="line"><span class="comment">                        */</span></span><br><span class="line">                    outofelection.put(n.sid, <span class="keyword">new</span> Vote(n.version,</span><br><span class="line">                                                        n.leader,</span><br><span class="line">                                                        n.zxid,</span><br><span class="line">                                                        n.electionEpoch,</span><br><span class="line">                                                        n.peerEpoch,</span><br><span class="line">                                                        n.state));</span><br><span class="line">                    <span class="comment">// 走到这步是因为n.electionEpoch &gt; logicalclock.get()</span></span><br><span class="line">                    <span class="comment">// 即其它服务器已经再次选举了，所以要更新计数logicalclock</span></span><br><span class="line">                    <span class="keyword">if</span>(ooePredicate(outofelection, outofelection, n)) &#123;</span><br><span class="line">                        <span class="keyword">synchronized</span>(<span class="keyword">this</span>)&#123;</span><br><span class="line">                            logicalclock.set(n.electionEpoch);       <span class="comment">// 更新计数值为新值，新值必然大于旧值</span></span><br><span class="line">                            self.setPeerState((n.leader == self.getId()) ?</span><br><span class="line">                                    ServerState.LEADING: learningState());</span><br><span class="line">                        &#125;</span><br><span class="line">                        Vote endVote = <span class="keyword">new</span> Vote(n.leader,</span><br><span class="line">                                                n.zxid,</span><br><span class="line">                                                n.electionEpoch,</span><br><span class="line">                                                n.peerEpoch);</span><br><span class="line">                        leaveInstance(endVote);</span><br><span class="line">                        <span class="keyword">return</span> endVote;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">default</span>:</span><br><span class="line">                    LOG.warn(<span class="string">"Notification state unrecognized: &#123;&#125; (n.state), &#123;&#125; (n.sid)"</span>,</span><br><span class="line">                            n.state, n.sid);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (!validVoter(n.leader)) &#123;</span><br><span class="line">                    LOG.warn(<span class="string">"Ignoring notification for non-cluster member sid &#123;&#125; from sid &#123;&#125;"</span>, n.leader, n.sid);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (!validVoter(n.sid)) &#123;</span><br><span class="line">                    LOG.warn(<span class="string">"Ignoring notification for sid &#123;&#125; from non-quorum member sid &#123;&#125;"</span>, n.leader, n.sid);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span>(self.jmxLeaderElectionBean != <span class="keyword">null</span>)&#123;</span><br><span class="line">                MBeanRegistry.getInstance().unregister(</span><br><span class="line">                        self.jmxLeaderElectionBean);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            LOG.warn(<span class="string">"Failed to unregister with JMX"</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">        self.jmxLeaderElectionBean = <span class="keyword">null</span>;</span><br><span class="line">        LOG.debug(<span class="string">"Number of connection processing threads: &#123;&#125;"</span>,</span><br><span class="line">                manager.getConnectionThreadCount());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h1 id="思考"><a href="#思考" class="headerlink" title="思考"></a>思考</h1><h2 id="updateProposal和getVote函数什么关系"><a href="#updateProposal和getVote函数什么关系" class="headerlink" title="updateProposal和getVote函数什么关系"></a>updateProposal和getVote函数什么关系</h2><p>前者根据参数更新提议即(proposedLeader, proposedZxid, proposedEpoch)后者是根据提议(proposedLeader, proposedZxid, proposedEpoch)生成投票可以理解为set和get</p>
<h2 id="getVote-和self-getCurrentVote-的区别是什么"><a href="#getVote-和self-getCurrentVote-的区别是什么" class="headerlink" title="getVote()和self.getCurrentVote()的区别是什么"></a>getVote()和self.getCurrentVote()的区别是什么</h2><p>源码中有两种获取vote的形式，这两种的区别是什么getVote()是临时投票,相当于选leader时的提议，会不断变化的self.getCurrentVote()是每次选leader时，最后决定下来的投票，一般都是最终的leader</p>
<h2 id="连续多次等待通知都没有等到，等待通知的时长变化如何"><a href="#连续多次等待通知都没有等到，等待通知的时长变化如何" class="headerlink" title="连续多次等待通知都没有等到，等待通知的时长变化如何"></a>连续多次等待通知都没有等到，等待通知的时长变化如何</h2><p>FastLeaderElection#lookForLeader<br><img src="https://upload-images.jianshu.io/upload_images/4871751-737427c138f3a0e6.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/492/format/webp" alt><br>初始值为200ms，也就是说，只要没等到，就再等double的时间，到400ms，800ms，最终不超过maxNotificationInterval也就是1分钟</p>
<h2 id="FastLeaderElection与QuorumCnxManager关系"><a href="#FastLeaderElection与QuorumCnxManager关系" class="headerlink" title="FastLeaderElection与QuorumCnxManager关系"></a>FastLeaderElection与QuorumCnxManager关系</h2><p>选leader时消息的收发依赖QuorumCnxManager,它作为server之间的IO管理器<br><img src="https://upload-images.jianshu.io/upload_images/4871751-d3480463957154d1.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/505/format/webp" alt></p>
<h2 id="Vote为什么要peerEpoch字段"><a href="#Vote为什么要peerEpoch字段" class="headerlink" title="Vote为什么要peerEpoch字段"></a>Vote为什么要peerEpoch字段</h2><p>peerEpoch：被推举的Leader的epoch。</p>
<p>前面看代码看peerEpoch都是各种set和get，没有发现哪里比较了，最后发现是FastLeaderElection#totalOrderPredicate比较两个vote的大小关系的时候，会先用peerEpoch进行比较</p>
<h2 id="electionEpoch和peerEpoch区别-什么时候会不同"><a href="#electionEpoch和peerEpoch区别-什么时候会不同" class="headerlink" title="electionEpoch和peerEpoch区别,什么时候会不同?"></a>electionEpoch和peerEpoch区别,什么时候会不同?</h2><p>electionEpoch是选举周期，用于判断是不是同一个选举周期，从0开始累计</p>
<p>peerEpoch是当前周期,用于判断各个server所处的周期，从log中读取currentEpoch</p>
<p>选举leader时，electionEpoch作为大判断条件，要求大家按最新的electionEpoch作为选举周期如果electionEpoch一样，那么再根据currentEpoch和zxid，sid等判断哪个server是最“新”的</p>
<p>参考FastLeaderElection#totalOrderPredicate函数</p>
<h2 id="FastLeaderElection-Messenger-WorkerReceiver-run中，初始化时，认为的leader是哪一个"><a href="#FastLeaderElection-Messenger-WorkerReceiver-run中，初始化时，认为的leader是哪一个" class="headerlink" title="FastLeaderElection.Messenger.WorkerReceiver#run中，初始化时，认为的leader是哪一个"></a>FastLeaderElection.Messenger.WorkerReceiver#run中，初始化时，认为的leader是哪一个</h2><p><img src="https://upload-images.jianshu.io/upload_images/4871751-dceac4deebae0496.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/689/format/webp" alt><br>这里如果是null可是会npe的</p>
<p>ans：值是在这里设置的，初始化时当前投票是投给自己的,QuorumPeer#startLeaderElection，也就是提前调用了</p>
<blockquote>
<p>currentVote = new Vote(myid, getLastLoggedZxid(), getCurrentEpoch());</p>
</blockquote>
<h2 id="两个vote的全序大小比较规则总结"><a href="#两个vote的全序大小比较规则总结" class="headerlink" title="两个vote的全序大小比较规则总结"></a>两个vote的全序大小比较规则总结</h2><ol>
<li>依次根据peerEpoch，zxid，sid来</li>
<li>peerEpoch代表所处周期，越大则投票越新</li>
<li>peerEpoch相同时，zxid代表一个周期中的事务记录，越大则投票越新</li>
<li>peerEpoch，zxid均相同时，sid大的赢（两个投票一样新，只是为了决定leader需要有大小关系）</li>
</ol>
<h2 id="选举投票leader的验证问题"><a href="#选举投票leader的验证问题" class="headerlink" title="选举投票leader的验证问题"></a>选举投票leader的验证问题</h2><ol>
<li>如果消息发送方state是looking，则termPredicate看是否过半即可</li>
<li>如果消息发送方state是following或者leading，则ooePredicate看是否过半，且leader机器发出ack知道了自己是leader即可</li>
</ol>
<h2 id="集群中是否所有机器是否都是网络互通"><a href="#集群中是否所有机器是否都是网络互通" class="headerlink" title="集群中是否所有机器是否都是网络互通"></a>集群中是否所有机器是否都是网络互通</h2><p>这里集群不是所有列表，而是所有leading和following的机器，不是网络互通的，比如<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">三台机器ABC，AB网络不通</span><br><span class="line">但是A，B，C投票都给C</span><br><span class="line">C收到三张票，过半，自己成为leader</span><br><span class="line">B知道C得到了两张票，分别是BC投给C（B不知道A投给了C），也过半，自己成为follower</span><br><span class="line">同理，A也成为follower</span><br></pre></td></tr></table></figure></p>
<h2 id="是否会出现looking机器和leader机器网络不通，但收了过半的leader投票，因此认定了leader的合理性"><a href="#是否会出现looking机器和leader机器网络不通，但收了过半的leader投票，因此认定了leader的合理性" class="headerlink" title="是否会出现looking机器和leader机器网络不通，但收了过半的leader投票，因此认定了leader的合理性"></a>是否会出现looking机器和leader机器网络不通，但收了过半的leader投票，因此认定了leader的合理性</h2><p>情景：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">1.假设5台机器ABCDE，ABCD已经形成集群，以D为leader</span><br><span class="line">2.这时E以looking状态进来，收到了ABC以following状态的投票，这时就过半了</span><br><span class="line">3.E会不会把D当成leader</span><br></pre></td></tr></table></figure></p>
<p>这就是checkLeader函数的意义，里面会有检查<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(leader != self.getId())&#123;<span class="comment">// 自己不为leader</span></span><br><span class="line">    <span class="keyword">if</span>(votes.get(leader) == <span class="keyword">null</span>) predicate = <span class="keyword">false</span>;<span class="comment">// 投票记录中，没有来自leader的投票</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span>(votes.get(leader).getState() != ServerState.LEADING) predicate = <span class="keyword">false</span>;<span class="comment">//leader不知道自己是leader</span></span><br></pre></td></tr></table></figure></p>
<p>如果网络不通，那么就会votes.get(leader) == null，因此E不会把D当成leader</p>
<h2 id="加入一个已经有的集群，走的什么流程"><a href="#加入一个已经有的集群，走的什么流程" class="headerlink" title="加入一个已经有的集群，走的什么流程"></a>加入一个已经有的集群，走的什么流程</h2><p>在上面checkLeader意义处也带过了，就是收了一堆following和leader机器的回复，然后进行过半验证以及leader验证即可</p>
<h2 id="竞选leader是”广播”吗？"><a href="#竞选leader是”广播”吗？" class="headerlink" title="竞选leader是”广播”吗？"></a>竞选leader是”广播”吗？</h2><p>选举leader不是广播，后续一致性同步才是广播。这里就是所有server互相通信完成的</p>
<h2 id="leader选举在server中启动步骤的位置"><a href="#leader选举在server中启动步骤的位置" class="headerlink" title="leader选举在server中启动步骤的位置"></a>leader选举在server中启动步骤的位置</h2><p><img src="https://upload-images.jianshu.io/upload_images/4871751-47ee97e8304b5bf5.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/634/format/webp" alt></p>
</div><div class="tags"><a href="/tags/zookeeper/">zookeeper</a></div><div class="post-nav"><a class="pre" href="/2018/12/18/zk集群启动/">zk集群启动QuorumPeerMain解析</a><a class="next" href="/2018/08/23/SpringMVC/">SpringMVC 源码解析</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form class="search-form" action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank"><input type="text" name="q" maxlength="20" placeholder="Search"><input type="hidden" name="sitesearch" value="https://SvizzerChow.github.io"></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Java/">Java</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Netty/">Netty</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Sentinel/">Sentinel</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/redis/">redis</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/sharding-jdbc/">sharding-jdbc</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/分布式/">分布式</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/并发/">并发</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/数据库/">数据库</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/算法/">算法</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/线程池/">线程池</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/网络/">网络</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/虚拟机/">虚拟机</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/Sentinel/" style="font-size: 15px;">Sentinel</a> <a href="/tags/BASE理论/" style="font-size: 15px;">BASE理论</a> <a href="/tags/虚拟机/" style="font-size: 15px;">虚拟机</a> <a href="/tags/JavaAgent/" style="font-size: 15px;">JavaAgent</a> <a href="/tags/集合/" style="font-size: 15px;">集合</a> <a href="/tags/可见性/" style="font-size: 15px;">可见性</a> <a href="/tags/内存模型/" style="font-size: 15px;">内存模型</a> <a href="/tags/MESI/" style="font-size: 15px;">MESI</a> <a href="/tags/volatile/" style="font-size: 15px;">volatile</a> <a href="/tags/MySQL/" style="font-size: 15px;">MySQL</a> <a href="/tags/网络/" style="font-size: 15px;">网络</a> <a href="/tags/Netty/" style="font-size: 15px;">Netty</a> <a href="/tags/channel/" style="font-size: 15px;">channel</a> <a href="/tags/ServerBootstrap/" style="font-size: 15px;">ServerBootstrap</a> <a href="/tags/NioEventLoop/" style="font-size: 15px;">NioEventLoop</a> <a href="/tags/启动/" style="font-size: 15px;">启动</a> <a href="/tags/线程模型/" style="font-size: 15px;">线程模型</a> <a href="/tags/读写事件/" style="font-size: 15px;">读写事件</a> <a href="/tags/http/" style="font-size: 15px;">http</a> <a href="/tags/沾包/" style="font-size: 15px;">沾包</a> <a href="/tags/拆包/" style="font-size: 15px;">拆包</a> <a href="/tags/内存/" style="font-size: 15px;">内存</a> <a href="/tags/NIO/" style="font-size: 15px;">NIO</a> <a href="/tags/redis/" style="font-size: 15px;">redis</a> <a href="/tags/NoSQL/" style="font-size: 15px;">NoSQL</a> <a href="/tags/限流/" style="font-size: 15px;">限流</a> <a href="/tags/降级/" style="font-size: 15px;">降级</a> <a href="/tags/熔断/" style="font-size: 15px;">熔断</a> <a href="/tags/CAP理论/" style="font-size: 15px;">CAP理论</a> <a href="/tags/源码解析/" style="font-size: 15px;">源码解析</a> <a href="/tags/TCP/" style="font-size: 15px;">TCP</a> <a href="/tags/原子性/" style="font-size: 15px;">原子性</a> <a href="/tags/long/" style="font-size: 15px;">long</a> <a href="/tags/double/" style="font-size: 15px;">double</a> <a href="/tags/并发/" style="font-size: 15px;">并发</a> <a href="/tags/sentinel/" style="font-size: 15px;">sentinel</a> <a href="/tags/zookeeper/" style="font-size: 15px;">zookeeper</a> <a href="/tags/分布式锁/" style="font-size: 15px;">分布式锁</a> <a href="/tags/数据库/" style="font-size: 15px;">数据库</a> <a href="/tags/分库分表/" style="font-size: 15px;">分库分表</a> <a href="/tags/io/" style="font-size: 15px;">io</a> <a href="/tags/同步/" style="font-size: 15px;">同步</a> <a href="/tags/异步/" style="font-size: 15px;">异步</a> <a href="/tags/线程池/" style="font-size: 15px;">线程池</a> <a href="/tags/Java/" style="font-size: 15px;">Java</a> <a href="/tags/Excutors/" style="font-size: 15px;">Excutors</a> <a href="/tags/多线程/" style="font-size: 15px;">多线程</a> <a href="/tags/FutureTask/" style="font-size: 15px;">FutureTask</a> <a href="/tags/AbstractExecutorService/" style="font-size: 15px;">AbstractExecutorService</a> <a href="/tags/ThreadPoolExecutor/" style="font-size: 15px;">ThreadPoolExecutor</a> <a href="/tags/ScheduledThreadPoolExecutor/" style="font-size: 15px;">ScheduledThreadPoolExecutor</a> <a href="/tags/缓存/" style="font-size: 15px;">缓存</a> <a href="/tags/缓存行/" style="font-size: 15px;">缓存行</a> <a href="/tags/轮询/" style="font-size: 15px;">轮询</a> <a href="/tags/算法/" style="font-size: 15px;">算法</a> <a href="/tags/Spring/" style="font-size: 15px;">Spring</a> <a href="/tags/sharding-jdbc/" style="font-size: 15px;">sharding-jdbc</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2020/03/16/Netty之旅27PoolArena/">Netty解析二十五：Netty内存分配PoolArena</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/03/13/Netty之旅26PoolChunkList/">Netty解析二十四：Netty内存分配PoolChunkList</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/03/12/Netty之旅25PoolSubpage/">Netty解析二十三：Netty内存分配PoolSubpage</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/03/06/Netty之旅24PoolChunk/">Netty解析二十二：Netty内存分配PoolChunk</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/03/05/Netty之旅23内存分配模型/">Netty解析二十一：Netty内存分配模型</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/03/03/同步异步和阻塞非阻塞/">同步/异步与阻塞/非阻塞</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/03/02/Netty之旅22Netty沾包拆包/">Netty解析二十：Netty中的拆包沾包处理</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/03/01/TCP协议如何保证可靠性/">TCP协议如何保证可靠性</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/01/05/Netty之旅21Netty中的buffer/">Netty解析十九：Netty中的buffer</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/01/04/Netty之旅20服务器端http请求读写流程/">Netty解析十八：Netty服务器端读写事件流程</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2017-2020 <a href="/." rel="nofollow">SvizzerChow's Blog.</a><a rel="nofollow" target="_blank" href="http://www.beian.miit.gov.cn"> 浙ICP备18053179号</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>